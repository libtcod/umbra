<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 5, revision: 3, date: new Date("Aug 18, 2009"), extensions: {}};
//]]>
</script>
    <!--[if lte IE 7]>
      <script>
        alert("You are using an old version of M$IE. Please update it (or use a *decent* browser) for best Umbra documentation browsing experience!")
      </script>
    <![endif]-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) UnaMesa Association 2004-2009

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> Umbra - powering libtcod-based applications </title>
<style id="styleArea" type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston, Copyright &copy; 2007 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="ColorPalette">
<pre>Background: #202020
Foreground: #d0d0d0
PrimaryPale: #ffa
PrimaryLight: #fa3
PrimaryMid: #d61
PrimaryDark: #740
SecondaryPale: #ffc
SecondaryLight: #fe4
SecondaryMid: #fb0
SecondaryDark: #f80
TertiaryPale: #444
TertiaryLight: #555
TertiaryMid: #666
TertiaryDark: #888
Error: #f88
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity=60)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0 0; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0;}
.wizardFooter .status {padding:0 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {margin:0 0 0 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding:0.1em 0.4em; margin:0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; width:90%; margin-left:3em; padding:1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none !important;}
#displayArea {margin: 1em 1em 0em;}
noscript {display:none;} /* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank [[TiddlyWiki]], you'll need to modify the following tiddlers:
* [[SiteTitle]] &amp; [[SiteSubtitle]]: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* [[MainMenu]]: The menu (usually on the left)
* [[DefaultTiddlers]]: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;</pre>
</div>
</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="API reference" modifier="Mingos" created="200910241815" modified="201008190945" tags="api" changecount="15">
<pre>&lt;&lt;tabs api
    &quot;Classes&quot; &quot;Classes&quot; [[Classes]]
    &quot;Methods&quot; &quot;Methods&quot; [[Methods]]
    &quot;Operators&quot; &quot;Operators&quot; [[Operators]]
    &quot;Callbacks&quot; &quot;Callbacks&quot; [[Callbacks]]
    &quot;Enums&quot; &quot;Enums&quot; [[Enums]]
    &quot;Flags&quot; &quot;Flags&quot; [[Flags]]
    &quot;Defines&quot; &quot;Defines&quot; [[Defines]]
&gt;&gt;</pre>
</div>
<div title="About Umbra" modifier="Mingos" created="200910241806" modified="201009032153" changecount="16">
<pre>Umbra is a general purpose framework for applications that use libtcod, mainly games. It is thought to provide a &quot;module player&quot; functionality more than anything else, meaning that it lacks any out-of-the-box support for game logic or other game elements. The game/app developer will still need to write everything from scratch, but Umbra will help divide the game into manageable chunks, or [[modules|What is a module]]. Also, the [[engine|The engine]] takes control over the main game loop and screen flushing, provides a global keybindings method and lets the developer define module-specific keybindings.

Umbra is released under the BSD licence and thus may be freely used by anyone for any purpose. The licence text is as follows:

!!Umbra
''Copyright (c) 2009, 2010 Mingos, Jice''
''All rights reserved.''

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
* Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
* The names of Mingos or Jice may not be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY MINGOS &amp; JICE &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL MINGOS OR JICE BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</pre>
</div>
<div title="Accessing modules and widgets" modifier="Mingos" created="201009091724" modified="201009100137" tags="tutorial module widget moduleReference" changecount="4">
<pre>Modules and widgets are accessed in the same way, as the engine does not distinguish between them.

The method used to gain access to a module from within the engine is [[UmbraEngine::getModule]]. It takes the [[module ID number|Module ID]] as parametre, and returns a pointer to the module with that ID.

!Example
&lt;code C++&gt;
myModule-&gt;getEngine()-&gt;getModule(2)-&gt;setActive(true);
&lt;/code&gt;
The above code, executed from within a module, will fetch a pointer to the engine, then to a module with an ID number of 2, and activate it.</pre>
</div>
<div title="Activating modules" modifier="Mingos" created="200911121718" modified="201007272150" tags="tutorial module moduleStatus init" changecount="5">
<pre>A registered module resides inside the modules list, but before the engine actually runs any of the modules from the list, the developer has to specify which one needs to be activated. Typically, a main menu, a title screen or a credits screen will be the first activated module.

Module activation is extremely simple. Once a module is registered, it is given an ID number, which the developer can deduce from the order in which the modules were registered. This number can then be used to activate a module. The method that actually does the trick is [[UmbraModule::activateModule]]. Instead of the ID number, the method also accepts the module reference as an argument. In both cases, the chosen module will be put on a separate list of modules destinated for activation in the next frame. The engine should run with no problems once a module is active.</pre>
</div>
<div title="BSOD" modifier="Mingos" created="200911092016" modified="201010021201" tags="tutorial internalModule error" changecount="8">
<pre>The BSOD is an internal module created with the sole purpose of notifying the developer that a non fatal error has occurred in the program. It is supposed to be used in conjunction with the [[UmbraError::add]] method.

The BSOD is, as the name implies, a blue screen. It's not as annoying as its namesake, as it has the form of a small, semitransparent blue box that disappears a few seconds after it is displayed. Additionally, it can be moved around in case it happens to cover something important or even closed with a close button in the top right corner.

The module, when triggered using the method [[UmbraEngine::displayError]], will display the last registered error mesage (or the line &quot;No errors registered&quot; in case it is displayed before any errors have been added to the log). Here is an example use:
&lt;code C++&gt;
if (errorCondition) {
    UmbraError::add(UMBRA_ERRORLEVEL_ERROR, &quot;Example error message.&quot;);
    UmbraEngine::getInstance()-&gt;displayError();
}
&lt;/code&gt;
Please note that this module requires the console emulator to be active, otherwise it won't be displayed. For this reason, the BSOD is only useful for displaying non fatal errors. In case a fatal error is encountered, it will typically call {{{exit(1);}}} instead of {{{displayError();}}}. The BSOD is useless in such situations, and the error message can only be retrieved from the error log saved to the disc.</pre>
</div>
<div title="Callbacks" modifier="Mingos" created="201008020041" modified="201008191016" tags="api callback" changecount="5">
<pre>*[[UmbraCallbackFontDown]]
*[[UmbraCallbackFontUp]]
*[[UmbraCallbackFullscreen]]
*[[UmbraCallbackPause]]
*[[UmbraCallbackQuit]]
*[[UmbraCallbackScreenshot]]
*[[UmbraCallbackSpeedometer]]</pre>
</div>
<div title="Change log" modifier="Mingos" created="201008111354" modified="201010021205" tags="changeLog" changecount="12">
<pre>&lt;&lt;tiddler ChangeLogSymbols&gt;&gt;
!!!Umbra, current HEAD revision
|!Category|!Committed on|!Change|!Committed by|
|API|2-Oct-2010|Error reporting now uses error levels|Mingos|
!!!Umbra 10.09 Alpha, 19-September-2010
|!Category|!Committed on|!Change|!Committed by|
|NEW|19-Sep-2010|First official release of Umbra Engine|Mingos &amp; Jice|</pre>
</div>
<div title="ChangeLogSymbols" modifier="Mingos" created="201008111356" modified="201008111409" tags="changeLog" changecount="7">
<pre>|!Symbol|!Meaning|
|NEW|new feature|
|REM|removed feature|
|API|changed feature and/or API break|
|BUG|bug fix|</pre>
</div>
<div title="Classes" modifier="Mingos" created="200911042330" modified="201008190947" tags="api class" changecount="10">
<pre>&lt;&lt;tabs methods
    &quot;UmbraEngine&quot; &quot;UmbraEngine&quot; [[UmbraEngine]]
    &quot;UmbraModule&quot; &quot;UmbraModule&quot; [[UmbraModule]]
    &quot;UmbraWidget&quot; &quot;UmbraWidget&quot; [[UmbraWidget]]
    &quot;UmbraCallback&quot; &quot;UmbraCallback&quot; [[UmbraCallback]]
    &quot;UmbraKey&quot; &quot;UmbraKey&quot; [[UmbraKey]]
    &quot;UmbraPoint&quot; &quot;UmbraPoint&quot; [[UmbraPoint]]
    &quot;UmbraRect&quot; &quot;UmbraRect&quot; [[UmbraRect]]
    &quot;UmbraError&quot; &quot;UmbraError&quot; [[UmbraError]]
&gt;&gt;</pre>
</div>
<div title="Creating a callback" modifier="Mingos" created="201008040033" modified="201008111220" tags="tutorial callback" changecount="6">
<pre>!Creating a basic callback
In order to create a callback, it is necessary to create a class that will hold the callback-specific information. It needs to inherit the base callback class, [[UmbraCallback]]. The most basic callback declaration would be this:
&lt;code C++&gt;
class MyCallback: public UmbraCallback {
    public:
        MyCallback();
    private:
        void action();
}
&lt;/code&gt;
The constructor will typically initialise the keystroke data held by the [[UmbraCallback]] mother class, while the {{{action}}} method will implement custom code that will be executed once the callback's keystroke has been detected:
&lt;code C++&gt;
MyCallback::MyCallback() {
    key.assign(TCODK_F4,0,true,false,false);
}

void MyCallback::action() {
    getEngine()-&gt;deactivateAll();
}
&lt;/code&gt;
Note that overriding the {{{action}}} method is mandatory. Please refer to the [[UmbraKey]] class for more details on how the keystroke works.
!Creating a more complex callback
There's another method that can be overridden in the [[UmbraCallback]] mother class: {{{evaluate}}}. It's the method that is invoked every main loop iteration and serves the purpose of comparing the keyboard input with the keystroke the callback listens to. The [[UmbraCallbackQuit]] does exactly that, as it needs to listen to two different key combinations:
&lt;code C++&gt;
class UmbraCallbackQuit: public UmbraCallback {
    public:
        UmbraCallbackQuit ();
    private:
        UmbraKey key2;
        inline bool evaluate (UmbraKey k) { if (k == key || k == key2) return true; else return false; }
        void action ();
};
&lt;/code&gt;</pre>
</div>
<div title="Creating a module" modifier="Mingos" created="200911142341" modified="201009182111" tags="tutorial module" changecount="14">
<pre>Creating a module is essentially easy. Here's the simplest way:
&lt;code C++&gt;
class MyModule : public UmbraModule {};
&lt;/code&gt;
Yes, that's right. By creating any class that inherits [[UmbraModule]] you can create a perfectly valid module that will be recognised by the engine.

Creating a ''valid'' module is one thing. Making it ''functional'' is a different story. Registering the above module is legal, but no code would ever be executed should it be run.

Each module, along with [[UmbraModule]], inherits a set of virtual methods, which are called by the engine. These need to be overridden. First, let's have a look at the method that is probably the most interesting to the developer: [[UmbraModule::update]].
!Update

The module needs to update its internal logic in order to work. This is what [[UmbraModule::update]] is supposed to do. Imagine you have a chess program. The updating would be roughly something like this:
&lt;code C++&gt;
bool MyModule::update (void) {
    if (computersTurn) {
        calculateMove();
        refreshFigurePositions();
        computersTurn = false;
    }
    if (!checkmate &amp;&amp; !stalemate) return true;
    else return false;
}
&lt;/code&gt;
In other words, the updating of a chess program would:
#check whether it's the computer's move,
##if it is, find the best move available,
##make that move by updating the figures positions
##switch to the player's turn
#check whether the game has ended
##if it hasn't, return true (module keeps active)
##if it has, return false (deactivate module)
A key feature of [[UmbraModule::update]] is the effect its return value has on the entire module. Should it return {{{false}}}, the module will automatically be marked for deactivation. If the method returns {{{true}}}, the module still can get deactivated, for instance, by another module.

If the update method isn't overridden, it will always return true. This might be useful in case of modules that simply display a static piece of graphics or text, or have the render method depend on an external source.
!Render

The [[UmbraModule::render]] does exactly what its name indicates: takes care of graphical representation. There are no rules regarding how the rendering should look like. Umbra leaves this to the developer's intuition and specific needs.

One possibility is to do it the straightforward way: draw everything directly to the root console. There are many situations that do not require a more sophisticated solution. Imagine a module that simply renders a smoky background behing the items in the main menu. It's the lowest layer and it won't overwrite anything. It'll also probably cover the entire console's area, so the simple rendering is perfectly acceptable.

Another way would be using an offscreen console. It is a good solution to blit an offscreen console over the root if, for instance, only a small area with a dynamic position needs to be rendered. Imagine a dialogue balloon appearing over a character in a roguelike game. Its position and size wouldn't be fixed, so blitting an offscreen console would be the only sensible solution.
!Example module

Here's an example of an extremely simple module.

{{{credits.hpp}}}:
&lt;code C++&gt;
#ifndef MODULE_CREDITS_HPP
#define MODULE_CREDITS_HPP

class Credits : public UmbraModule {
    public:
        Credits ();
 //the constructor
        void activate (void); //to be run on module activation
        bool update (void);
        void render (void);
        void keyboard (TCOD_key_t &amp;key); //keyboard input

    private:
        std::string credits; //credits text
        uint32 startTime; //used for the timeout
        uint32 duration; //used for the timeout
        int x, y; //rendering starting position
};

#endif
&lt;/code&gt;
The module Credits contains no specific methods, it only overrides four [[UmbraModule]]'s virtual methods. {{{activate}}} is the custom code that will be executed each time the module is activated. {{{update}}} is overridden as well and will be used to determine the deactivation condition: a timeout. {{{render}}} displays the credits text, and {{{keyboard}}} parses keyboard input. None of these needs to be called manually, as the engine knows exactly what to do with those methods.

The variables are very important for this module, even though all but one might as well be replaced by literals. {{{std::string credits}}} is the actual credits text that will be displayed. {{{uint32 startTime}}} is a variable that will be used to determine how long the module has been running. {{{uint32 duration}}} is how long, in milliseconds, we want the module to run before it's deactivated (timeout). Finally, {{{int x, y}}} are the coordinates where the credits will be displayed.

{{{credits.cpp}}}:
&lt;code C++&gt;
#include &quot;umbra.hpp&quot;
#include &quot;credits.hpp&quot;
#include &lt;stdio.h&gt;

//constructor
Credits::Credits () {
    credits = &quot;Game Title\n&quot;
              &quot;by Game Author\n&quot;
              &quot;\n&quot;
              &quot;powered by:\n&quot;
              &quot;libtcod 1.5.1 by Jice &amp; Mingos,\n&quot;
              &quot;Umbra 0.1 by Mingos &amp; Jice&quot;;
    duration = 3000;
    x = UmbraConfig::rootWidth/2;
    y = (UmbraConfig::rootHeight/2)-3;
}

//update: check the timeout
bool Credits::update (void) {
    if (TCODSystem::getElapsedMilli()-startTime &lt; duration)
        return true;
    else
        return false;
}

//render: put the credits text on the screen
void Credits::render (void) {
    TCODConsole::root-&gt;setForegroundColor(TCODColor::white);
    TCODConsole::root-&gt;setBackgroundColor(TCODColor::black);
    TCODConsole::root-&gt;printCenter(x,y,TCOD_BKGND_NONE,credits.c_str());
}

//keyboard input
void Credits::keyboard (TCOD_key_t &amp;key) {
    if (key.vk == TCODK_SPACE) setActive (false);
}

//activation code
void Credits::activate (void) {
    startTime = TCODSystem::getElapsedMilli();
}
&lt;/code&gt;
The constructor, as can be expected, sets the initial values for the module's variables. The credits text is set, the timeout is fixed to 3 seconds (3000 milliseconds), and the coordinates are chosen for the credits renderer.

The {{{update}}} method only does one thing: check whether the module has timed out. It compares the elapsed time to the module's activation time plus the timeout.

It's logical that the {{{render}}} method also needn't be complicated: it just sets the background and foreground colours and prints the credits string at the coordinates {{{[x,y]}}}.

The activation custom code is very simple. It is launched only when the module is activated, so we can safely put the {{{startTime}}} initialisation there. As soon as the module's activated, this method will check the current elapsed time and assign its value to the {{{startTime}}} variable. It will thus become the module's starting time and a base to evaluate the timeout.

Finally, the {{{keyboard}}} parsing. It does a simple check: if the space bar is pressed, the module will be deactivated.

The entire module, when registered and activated, will be enough to create a simple application that displays the credits text until 3 seconds have passed or until the space bar is pressed (whichever happens first).</pre>
</div>
<div title="Creating a widget" modifier="Mingos" created="200911162231" modified="201007252135" tags="tutorial module widget" changecount="7">
<pre>Creating a ''valid'' widget is as easy as creating a ''valid'' module:
&lt;code C++&gt;
class MyWidget : public UmbraWidget {};
&lt;/code&gt;
Again, the engine will happily accept this widget as a working module (remember that the engine doesn't distinguish between modules and widgets because widgets actually inherit [[UmbraModule]]), but activating it will result in nothing happening.

Apart from all [[UmbraModule::update]] and [[UmbraModule::render]], which should be overridden pretty much the same way as in the case of [[UmbraModule]] (see [[Creating a module]]), overriding the method [[UmbraModule::mouse]] is pretty much mandatory if you wish to use additional widget-related features such as pushbuttons. Also, there is one particularity in how the rendering should be taken care of.

There are also a few interesting member objects which must be initialised in order to be used in the widget. The objects are the drag zone, the minimise button and the close button. They are completely interactive, but you should take care of proper display.
!Mouse input

Custom mouse input may be defined using [[UmbraModule::mouse]], but it is not necessary if all interactivity that's desired is the functional close button, the minimise button and/or the drag zone. Additional interactive objects will require custom mouse input.
!Rendering a widget

It is highly recommended to use an offscreen console. All rendering should be done on it, never directly on the root console. If a widget is rendered directly on the root console, it doesn't have dynamic position on the screen and thus needn't be a widget at all.

Mouse input, more specifically widget dragging, will be applied to {{{UmbraRect UmbraWidget::rect}}}, so it's convenient to end the rendering method with the following line:
&lt;code C++&gt;
TCODConsole::blit(consoleName,0,0,rect.w,rect.h,TCODConsole::root,rect.x,rect.y,1.0f,0.5f);
&lt;/code&gt;
where {{{consoleName}}} is the offscreen console used in the rendered widget. The transparency values may differ, of course, and needn't be fixed to 1.0f and 0.5f.

This is not a requirement, but rather a useful guideline. Dealing with rendering this way spares additional code required to refer to dynamic cell positions, as well as transparency issues.
!Drag zone

The widget always comes with a very special member object: {{{UmbraRect dragZone}}}. The drag zone is a rectangular area that will react to the mouse hovering over it and to being clicked and dragged. It will result in the entire widget being dragged around the console. In order for it to work, the draggable area needs to be specified. This is done via the [[UmbraWidget::setDragZone]] method. Specifying a valid set of coordinates inside the widget will activate draggability. That's it, an active drag zone already lets the widget be dragged around.

Bear in mind that the fact that a widget is draggable doesn't make it self-explanatory. It is generally recommended to indicate the draggable area in one way or another. The way that internal modules use is highlighting the widget's label. Here's the code used in [[BSOD]] rendering method:
&lt;code C++&gt;
...
bsod-&gt;setForegroundColor(TCODColor::white);
bsod-&gt;printFrame(0,0,30,8,true,TCOD_BKGND_NONE,&quot;Umbra BSOD&quot;);
...
if (dragZone.mouseHover || isDragging) {
    bsod-&gt;setBackgroundColor(TCODColor::lightRed);
    bsod-&gt;rect(9,0,12,1,false,TCOD_BKGND_SET);
}
...
&lt;/code&gt;
As you can see, there are two variables that are used in the process: {{{dragZone.mouseHover}}} and {{{isDragging}}}. They are set automatically each frame, so there's no need to bother with how they work. The former indicates whether the mouse cursor is hovering over the drag zone and the latter indicates whether the widget is being dragged. As can be observed in the code snippet, if any of the two conditions is met, the background colour of the area corresponding to the widget's label (&quot;Umbra BSOD&quot;, printed in white by the {{{TCODConsole::printFrame}}} method from libtcod) is changed to light red. If none of the conditions is satisfied, the label remains white.
!Minimise and close buttons

Another useful feature of a widget are the minimise and close buttons. They are implemented as {{{UmbraPoint minimiseButton}}} and {{{UmbraPoint closeButton}}}. As with the drag zone, the widget will need to be instructed where the points are supposed to be placed. This can be achieved using the [[UmbraPoint::set]] method. Once instructed about the placement of the buttons within the widget (specifically, relative to the coordinates [0,0] of {{{UmbraRect UmbraWidget::rect}}}), the widget will be able to collect data from the mouse and determine whether the cursor is hovering over the buttons and whether it's down. The hover and down events can be retrieved directly from the points using the variables {{{UmbraPoint::mouseHover}}} and {{{UmbraPoint::mouseDown}}}:
&lt;code C++&gt;
if (closeButton.mouseDown) setActive(false);
&lt;/code&gt;
The above code will check whether the mouse button has been pressed on the close button of a widget and if so, it will deactivate the widget.

The buttons will not be rendered themselves. Rendering them has to be taken care of in the widget's rendering method. The below code snippet has been copied from the [[Speed-o-meter]] widget:
&lt;code C++&gt;
if (closeButton.mouseHover)
    speed-&gt;setForegroundColor(TCODColor::red); //button is active
else
    speed-&gt;setForegroundColor(TCODColor::lightGrey); //button is not active
speed-&gt;putChar(closeButton.x,closeButton.y,'X',TCOD_BKGND_SET);
&lt;/code&gt;
In the above code snippet, {{{speed}}} is the offscreen console the widget uses. Note that {{{mouseHover}}} variable is used to determine the colour of the button character.</pre>
</div>
<div title="Credits" modifier="Mingos" created="200910272033" modified="201008111414" changecount="15">
<pre>The following people had a say in the creation of Umbra:

;[[Mingos]]
:Main developer of Umbra. The developer of a talkie game Umbrarum Regnum and co-developer of llibtcod. Web designer.
:*http://umbrarumregnum.110mb.com
:*http://www.umbraprojekt.pl
;Jice
:Main developer of Umbra. The guy behind libtcod (The Doryen Library), TCOD (The Chronicles of Doryen) and The Cave (the first project using Umbra).
:*http://doryen.eptalys.net
;Merc
:The developer of The Way of Fallen and the creator of the original engine concept Umbra is based on.
;[[Scautura]]
:Documentation proofreading - thanks a million, mate!</pre>
</div>
<div title="DeactivateAll() failing with fallbacks" modifier="Mingos" created="201008111315" modified="201008111413" tags="issueTracker bug open" changecount="3">
<pre>[[UmbraEngine::deactivateAll]] fails to close an application when the active modules have fallbacks. The fallbacks are activated upon module deactivation and the application continues.</pre>
</div>
<div title="DefaultTiddlers" modifier="Mingos" created="200910241745" modified="200910241818" changecount="2">
<pre>[[About Umbra]]</pre>
</div>
<div title="Defines" modifier="Mingos" created="201008020021" modified="201008152322" tags="api define" changecount="6">
<pre>There are few defines in Umbra:
;{{{UMBRA_TITLE}}}
:the string {{{&quot;Umbra Engine&quot;}}}
;{{{UMBRA_VERSION}}}
:the string containing the version of Umbra that's being used. Umbra uses Ubuntu-style versioning (e.g., version {{{10.09}}} has been released in September 2010).
;{{{UMBRA_STATUS}}}
:the string containing the status of the Umbra build that's being used, e.g. {{{&quot;Alpha&quot;}}}.
;{{{UMBRA_LICENCE}}}
:the string containing the licence text, as quoted [[here|About Umbra]]. You are encouraged to display it somewhere in your application.</pre>
</div>
<div title="Displaying an error" modifier="Mingos" created="200911111643" modified="201007252156" tags="tutorial error" changecount="2">
<pre>The errors that have been appended to the log using the method [[UmbraError::add]] can be displayed in a variety of ways.

Probably the easiest way is to use [[UmbraEngine::displayError]] method. It will activate the [[BSOD]] module and automatically display the last registered error. It can be called at any time and will work only if the root console is initialised.

If only the last message is of interest, but for some reason BSOD use is not an option, the last registered error message can also be retrieved with [[UmbraError::getLastMessage]].

Any other message can be retrieved as well using the [[UmbraError::getMessage]] method. You can specify the message index you wish to retrieve. In case you don't know how many errors have been registered so far, you can always check this with [[UmbraError::getNbErrors]].</pre>
</div>
<div title="Engine instantiation versus initialisation" modifier="Mingos" created="200911111512" modified="201008111257" tags="tutorial engine" changecount="5">
<pre>The difference between the two concepts is very important. The engine needs to be instantiated in order to become available at all, but in order to run it also needs to be configured.

!Instantiation
This will typically be the very first thing to do in your code:
&lt;code C++&gt;
UmbraEngine engine();
&lt;/code&gt;
The above line of code ''instantiates'' the engine, ie, creates an instance of the [[UmbraEngine]] class that can be [[referenced|Referencing the engine]]. Without it, all attempts to use the engine would result in a compilation error.

When the engine is instantiated, its constructor assigns the engine's variables initial values and, if the developer requests it, also activates default [[callbacks|What are callbacks]]. A freshly instantiated engine is not useable yet.

!Initialisation
After instantiating the engine, it is configured according to the developer's needs. Modules are registered, and so are fonts, and finally at least one module is activated. Additional configuration possibilities exist as well. See the [[things to do before initialising the engine|Using Umbra]] for more details on this subject.

As soon as the engine is properly configured, it can be initialised. The initialisation is a simple process, yet it relies on the initial configuration. The configuration file is loaded, and information contained therein is used to launch the main application window (libtcod console). At least one font needs to be registered in order to launch the console. If none have been registered, the engine will look in the fonts directory specified in the configuration file and try to automatically register font files with the correct naming pattern. See [[Font autodetection]] for details.

After the engine is successfully initialised, it can be run.
&lt;code C++&gt;
if (engine.initialise()) return engine.run();
else return 1;
&lt;/code&gt;</pre>
</div>
<div title="Enums" modifier="Mingos" created="200911042341" modified="201010021147" changecount="5">
<pre>*[[UmbraErrorLevel]]
*[[UmbraInternalModuleID]]
*[[UmbraKeyboardMode]]
*[[UmbraModuleStatus]]</pre>
</div>
<div title="Error log" modifier="Mingos" created="200911111602" modified="201007252156" tags="tutorial error" changecount="2">
<pre>The error log is a list of error messages registered throughout a single run of the application. Errors can be appended to that list, and each time an error is reported, it will be sent to stderr (in case of console-based applications, stderr is the system console) and also to a text file {{{errorlog.txt}}} located in the application's working directory.

The errors are added automatically when something goes wrong inside Umbra, but the developer can also use the log to append custom error messages.</pre>
</div>
<div title="Fallbacks" modifier="Mingos" created="200911091937" modified="201007271701" tags="tutorial module fallback" changecount="12">
<pre>A fallback (not to be confused with a callback) is a simple integer ID number that can be assigned to any registered module.

When a module is deactivated, it can adopt one of two behaviours:
#Do nothing, simply end itself,
#Trigger the activation of another module
The second case is called a fallback, since a deactivated module //falls back// to another one.

This behaviour can be defined at the moment of module registering. The method that registers a module is [[UmbraEngine::registerModule]], with the declaration {{{UmbraEngine::registerModule (UmbraModule * module, int fallback)}}}. The second argument, the integer variable called {{{fallback}}} is optional. If it is not specified, the registered module will simply end when it's deactivated. On the other hand, if another module's ID is passed to the method as the second argument, the deactivation of the registered module will trigger the activation of another one, with ID number equal to the one specified as {{{fallback}}}.

Let's see this in an example situation:
&lt;code C++&gt;
int main () {
    enum { MOD_CREDITS, MOD_MAINMENU }; //module IDs
    UmbraEngine engine;
    engine.registerModule(new Credits(),MOD_MAINMENU); //with fallback
    engine.registerModule(new Menu()); //no fallback
    engine.activateModule(MOD_CREDITS);
    if (engine.initialise()) return engine.run();
    else return 1;
}
&lt;/code&gt;
In line 02. we declare an enumeration that coincides with the ID numbers that are assigned to registered modules (see [[UmbraEngine::registerModule]] for details). In line 04. we register a module called Credits. It is assigned a fallback {{{MOD_MAINMENU}}}. In the next line, another module is registered, called Menu, but without a falback. Finally, in line 06., the module with ID {{{MOD_CREDITS}}} is activated.

How will the engine behave? The first activated module is supposedly a credits screen, which is usually displayed only during a few seconds in order to honour copyright holders (in case of Umbra, the creators of SDL, libtcod and Umbra itself would be mentioned). When it ends, usually after a specified amount of time has passed, it will give place to another screen, usually related to the game. In our small example, it is a main menu screen. When the main menu ends, it will not fall back to any module automatically, as there are usually various possibilities for the main menu to end. It may trigger the character creation screen, savegame choice screen, options screen or simply end the game. For this reason, no fallback has been specified in line 05. Had it been assigned a fallback, the main menu would always fall back to the specified module, which is not desired.</pre>
</div>
<div title="Flags" modifier="Mingos" created="201008111239" modified="201008111239" changecount="2">
<pre>*[[UmbraRegisterCallbackFlag]]</pre>
</div>
<div title="Font autodetection" modifier="Mingos" created="200911050951" modified="201009152146" tags="tutorial font init" changecount="21">
<pre>By default Umbra will look for {{{font&lt;w&gt;x&lt;h&gt;[_&lt;layout&gt;].png}}} files in the {{{./data/img/}}} directory. You can change this directory by adding a fontDir variable in umbra.txt, for example :
&lt;code c++&gt;
/*
 * UMBRA CONFIGURATION FILE
 */

config {
  rootWidth = 80
  rootHeight = 60
  fontID = 1
  fullScreen = false
  debug = false
  fontDir = &quot;./fonts&quot;
}
&lt;/code&gt;
If no font file is found, we fall back to the default libtcod behaviour: we'll try to use the default {{{&quot;./terminal.png&quot;}}} font file.
Font files names must have the following format: 
{{{font&lt;w&gt;x&lt;h&gt;[_&lt;layout&gt;].png}}}
w and h represent the character width and height in the font.
layout is either {{{TCOD}}}, {{{INCOL}}} or {{{INROW}}}. If missing, {{{TCOD}}} is assumed. Fonts must be grayscale (see libtcod setCustomFont documentation).
Examples :
{{{font8x8.png}}}: grayscale font with 8 pixels wide square characters, TCOD layout
{{{font10x10_INCOL.png}}}: grayscale font with 10 pixels wide square characters, ASCII in columns layout
{{{font10x12_INROW.png}}}: grayscale font with non square characters, ASCII in rows layout

All those fonts will be automatically registered and sorted by character &quot;size&quot; = width * height, smallest to biggest. When the game runs, you can switch the current font by pressing pageUp and pageDown (by default). The font selected will be remembered the next time you run the game.

If you want a finer control on the way fonts are loaded, you can register them manually using [[UmbraEngine::registerFont]].

;see also:
:[[Registering fonts]]</pre>
</div>
<div title="Font switching fails when fonts have different layouts" modifier="Mingos" created="201009152158" tags="issueTracker bug open" changecount="1">
<pre>Apparently, if there are multiple fonts registered and their layout is not the same, switching between them using Umbra inbuilt font switcher doesn't work. This might be a libtcod-specific bug though.</pre>
</div>
<div title="ForEachTiddlerMacro" modifier="YourName" created="200512081501" modified="200707300922" tags="Documentation ForEachTiddlerMacro Macro" server.type="file" server.host="tiddlywiki.abego-software.de/#ForEachTiddlerPlugin" server.page.revision="200707300922">
<pre>//~~(Part of the [[ForEachTiddlerPlugin]])~~//

Create customizable lists, tables etc. for your selections of tiddlers. Specify the tiddlers to include and their order through a powerful language.

''Syntax:'' 
|&gt;|{{{&lt;&lt;}}}''forEachTiddler'' [''in'' //tiddlyWikiPath//] [''where'' //whereCondition//] [''sortBy'' //sortExpression// [''ascending'' //or// ''descending'']] [''script'' //scriptText//] [//action// [//actionParameters//]]{{{&gt;&gt;}}}|
|//tiddlyWikiPath//|The filepath to the TiddlyWiki the macro should work on. When missing the current TiddlyWiki is used.|
|//whereCondition//|(quoted) JavaScript boolean expression. May refer to the build-in variables {{{tiddler}}} and {{{context}}}.|
|//sortExpression//|(quoted) JavaScript expression returning &quot;comparable&quot; objects (using '{{{&lt;}}}','{{{&gt;}}}','{{{==}}}'. May refer to the build-in variables {{{tiddler}}} and {{{context}}}.|
|//scriptText//|(quoted) JavaScript text. Typically defines JavaScript functions that are called by the various JavaScript expressions (whereClause, sortClause, action arguments,...)|
|//action//|The action that should be performed on every selected tiddler, in the given order. By default the actions [[addToList|AddToListAction]] and [[write|WriteAction]] are supported. When no action is specified [[addToList|AddToListAction]] is used.|
|//actionParameters//|(action specific) parameters the action may refer while processing the tiddlers (see action descriptions for details). &lt;&lt;tiddler [[JavaScript in actionParameters]]&gt;&gt;|
|&gt;|~~Syntax formatting: Keywords in ''bold'', optional parts in [...]. 'or' means that exactly one of the two alternatives must exist.~~|


''Using JavaScript''

To give you a lot of flexibility the [[ForEachTiddlerMacro]] uses JavaScript in its arguments. Even if you are not that familiar with JavaScript you may find forEachTiddler useful. Just have a look at the various ready-to-use [[ForEachTiddlerExamples]] and adapt them to your needs.

''The Elements of the Macro''

The arguments of the ForEachTiddlerMacro consist of multiple parts, each of them being optional.

&lt;&lt;slider chkFETInClause [[inClause]] &quot;inClause&quot; &quot;inClause&quot;&gt;&gt;
&lt;&lt;slider chkFETWhereClause [[whereClause]] &quot;whereClause&quot; &quot;whereClause&quot;&gt;&gt;
&lt;&lt;slider chkFETSortClause [[sortClause]] &quot;sortClause&quot; &quot;sortClause&quot;&gt;&gt;
&lt;&lt;slider chkFETScriptClause [[scriptClause]] &quot;scriptClause&quot; &quot;scriptClause&quot;&gt;&gt;
&lt;&lt;slider chkFETActions [[Action Specification]] &quot;Action Specification&quot; &quot;Action Specification&quot;&gt;&gt;

''Using Macros and &quot;&gt;&quot; inside the forEachTiddler Macro''

You may use other macro calls into the expression, especially in the actionParameters. To avoid that the {{{&gt;&gt;}}} of such a macro call is misinterpreted as the end of the {{{&lt;&lt;forEachTiddler...&gt;&gt;}}} macro you must escape the {{{&gt;&gt;}}} of the inner macro with {{{$))}}} E.g. if you want to use {{{&lt;&lt;tiddler ...&gt;&gt;}}} inside the {{{forEachTiddler}}} macro you have to write {{{&lt;&lt;tiddler ...$))}}}.

In addition it is necessary to escape single {{{&gt;}}} with the text {{{$)}}}.

''Using {{{&lt;&lt;tiddler ... with: ...&gt;&gt;}}} to re-use ForEachTiddler definitions''

Sometimes you may want to use a certain ForEachTiddler definition in slight variations. E.g. you may want to list either the tiddlers tagged with &quot;ToDo&quot; and in the other case with &quot;Done&quot;. To do so you may use &quot;Tiddler parameters&quot;. Here an example:

Replace the variable part of the ForEachTiddler definition with $1 ($2,... $9 are supported). E.g. you may create the tiddler &quot;ListTaggedTiddlers&quot; like this
{{{
&lt;&lt;forEachTiddler 
 where 
 'tiddler.tags.contains(&quot;$1&quot;)'
&gt;&gt;
}}}

Now you can use the ListTaggedTiddlers for various specific tags, using the {{{&lt;&lt;tiddler ...&gt;&gt;}}} macro:
{{{
&lt;&lt;tiddler ListTaggedTiddlers with: &quot;systemConfig&quot;&gt;&gt;
}}}
{{{
&lt;&lt;tiddler ListTaggedTiddlers with: &quot;Plugin&quot;&gt;&gt;
}}}


See also [[ForEachTiddlerExamples]].</pre>
</div>
<div title="ForEachTiddlerPlugin" modifier="UdoBorkowski" created="200512281150" modified="200704122022" tags="ForEachTiddlerMacro ForEachTiddlerProject Plugin UdoBorkowski systemConfig" server.type="file" server.host="tiddlywiki.abego-software.de/#ForEachTiddlerPlugin" server.page.revision="200704122022">
<pre>/***
|''Name:''|ForEachTiddlerPlugin|
|''Version:''|1.0.8 (2007-04-12)|
|''Source:''|http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2007 [[abego Software|http://www.abego-software.de]]|
|''TiddlyWiki:''|1.2.38+, 2.0|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|
!Description

Create customizable lists, tables etc. for your selections of tiddlers. Specify the tiddlers to include and their order through a powerful language.

''Syntax:'' 
|&gt;|{{{&lt;&lt;}}}''forEachTiddler'' [''in'' //tiddlyWikiPath//] [''where'' //whereCondition//] [''sortBy'' //sortExpression// [''ascending'' //or// ''descending'']] [''script'' //scriptText//] [//action// [//actionParameters//]]{{{&gt;&gt;}}}|
|//tiddlyWikiPath//|The filepath to the TiddlyWiki the macro should work on. When missing the current TiddlyWiki is used.|
|//whereCondition//|(quoted) JavaScript boolean expression. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//sortExpression//|(quoted) JavaScript expression returning &quot;comparable&quot; objects (using '{{{&lt;}}}','{{{&gt;}}}','{{{==}}}'. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//scriptText//|(quoted) JavaScript text. Typically defines JavaScript functions that are called by the various JavaScript expressions (whereClause, sortClause, action arguments,...)|
|//action//|The action that should be performed on every selected tiddler, in the given order. By default the actions [[addToList|AddToListAction]] and [[write|WriteAction]] are supported. When no action is specified [[addToList|AddToListAction]]  is used.|
|//actionParameters//|(action specific) parameters the action may refer while processing the tiddlers (see action descriptions for details). &lt;&lt;tiddler [[JavaScript in actionParameters]]&gt;&gt;|
|&gt;|~~Syntax formatting: Keywords in ''bold'', optional parts in [...]. 'or' means that exactly one of the two alternatives must exist.~~|

See details see [[ForEachTiddlerMacro]] and [[ForEachTiddlerExamples]].

!Revision history
* v1.0.8 (2007-04-12)
** Adapted to latest TiddlyWiki 2.2 Beta importTiddlyWiki API (introduced with changeset 2004). TiddlyWiki 2.2 Beta builds prior to changeset 2004 are no longer supported (but TiddlyWiki 2.1 and earlier, of cause)
* v1.0.7 (2007-03-28)
** Also support &quot;pre&quot; formatted TiddlyWikis (introduced with TW 2.2) (when using &quot;in&quot; clause to work on external tiddlers)
* v1.0.6 (2006-09-16)
** Context provides &quot;viewerTiddler&quot;, i.e. the tiddler used to view the macro. Most times this is equal to the &quot;inTiddler&quot;, but when using the &quot;tiddler&quot; macro both may be different.
** Support &quot;begin&quot;, &quot;end&quot; and &quot;none&quot; expressions in &quot;write&quot; action
* v1.0.5 (2006-02-05)
** Pass tiddler containing the macro with wikify, context object also holds reference to tiddler containing the macro (&quot;inTiddler&quot;). Thanks to SimonBaird.
** Support Firefox 1.5.0.1
** Internal
*** Make &quot;JSLint&quot; conform
*** &quot;Only install once&quot;
* v1.0.4 (2006-01-06)
** Support TiddlyWiki 2.0
* v1.0.3 (2005-12-22)
** Features: 
*** Write output to a file supports multi-byte environments (Thanks to Bram Chen) 
*** Provide API to access the forEachTiddler functionality directly through JavaScript (see getTiddlers and performMacro)
** Enhancements:
*** Improved error messages on InternetExplorer.
* v1.0.2 (2005-12-10)
** Features: 
*** context object also holds reference to store (TiddlyWiki)
** Fixed Bugs: 
*** ForEachTiddler 1.0.1 has broken support on win32 Opera 8.51 (Thanks to BrunoSabin for reporting)
* v1.0.1 (2005-12-08)
** Features: 
*** Access tiddlers stored in separated TiddlyWikis through the &quot;in&quot; option. I.e. you are no longer limited to only work on the &quot;current TiddlyWiki&quot;.
*** Write output to an external file using the &quot;toFile&quot; option of the &quot;write&quot; action. With this option you may write your customized tiddler exports.
*** Use the &quot;script&quot; section to define &quot;helper&quot; JavaScript functions etc. to be used in the various JavaScript expressions (whereClause, sortClause, action arguments,...).
*** Access and store context information for the current forEachTiddler invocation (through the build-in &quot;context&quot; object) .
*** Improved script evaluation (for where/sort clause and write scripts).
* v1.0.0 (2005-11-20)
** initial version

!Code
***/
//{{{

	
//============================================================================
//============================================================================
//		   ForEachTiddlerPlugin
//============================================================================
//============================================================================

// Only install once
if (!version.extensions.ForEachTiddlerPlugin) {

if (!window.abego) window.abego = {};

version.extensions.ForEachTiddlerPlugin = {
	major: 1, minor: 0, revision: 8, 
	date: new Date(2007,3,12), 
	source: &quot;http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin&quot;,
	licence: &quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,
	copyright: &quot;Copyright (c) abego Software GmbH, 2005-2007 (www.abego-software.de)&quot;
};

// For backward compatibility with TW 1.2.x
//
if (!TiddlyWiki.prototype.forEachTiddler) {
	TiddlyWiki.prototype.forEachTiddler = function(callback) {
		for(var t in this.tiddlers) {
			callback.call(this,t,this.tiddlers[t]);
		}
	};
}

//============================================================================
// forEachTiddler Macro
//============================================================================

version.extensions.forEachTiddler = {
	major: 1, minor: 0, revision: 8, date: new Date(2007,3,12), provider: &quot;http://tiddlywiki.abego-software.de&quot;};

// ---------------------------------------------------------------------------
// Configurations and constants 
// ---------------------------------------------------------------------------

config.macros.forEachTiddler = {
	 // Standard Properties
	 label: &quot;forEachTiddler&quot;,
	 prompt: &quot;Perform actions on a (sorted) selection of tiddlers&quot;,

	 // actions
	 actions: {
		 addToList: {},
		 write: {}
	 }
};

// ---------------------------------------------------------------------------
//  The forEachTiddler Macro Handler 
// ---------------------------------------------------------------------------

config.macros.forEachTiddler.getContainingTiddler = function(e) {
	while(e &amp;&amp; !hasClass(e,&quot;tiddler&quot;))
		e = e.parentNode;
	var title = e ? e.getAttribute(&quot;tiddler&quot;) : null; 
	return title ? store.getTiddler(title) : null;
};

config.macros.forEachTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	// config.macros.forEachTiddler.traceMacroCall(place,macroName,params,wikifier,paramString,tiddler);

	if (!tiddler) tiddler = config.macros.forEachTiddler.getContainingTiddler(place);
	// --- Parsing ------------------------------------------

	var i = 0; // index running over the params
	// Parse the &quot;in&quot; clause
	var tiddlyWikiPath = undefined;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;in&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;TiddlyWiki path expected behind 'in'.&quot;);
			return;
		}
		tiddlyWikiPath = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the where clause
	var whereClause =&quot;true&quot;;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;where&quot;) {
		i++;
		whereClause = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the sort stuff
	var sortClause = null;
	var sortAscending = true; 
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;sortBy&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;sortClause missing behind 'sortBy'.&quot;);
			return;
		}
		sortClause = this.paramEncode(params[i]);
		i++;

		if ((i &lt; params.length) &amp;&amp; (params[i] == &quot;ascending&quot; || params[i] == &quot;descending&quot;)) {
			 sortAscending = params[i] == &quot;ascending&quot;;
			 i++;
		}
	}

	// Parse the script
	var scriptText = null;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;script&quot;) {
		i++;
		scriptText = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the action. 
	// When we are already at the end use the default action
	var actionName = &quot;addToList&quot;;
	if (i &lt; params.length) {
	   if (!config.macros.forEachTiddler.actions[params[i]]) {
			this.handleError(place, &quot;Unknown action '&quot;+params[i]+&quot;'.&quot;);
			return;
		} else {
			actionName = params[i]; 
			i++;
		}
	} 
	
	// Get the action parameter
	// (the parsing is done inside the individual action implementation.)
	var actionParameter = params.slice(i);


	// --- Processing ------------------------------------------
	try {
		this.performMacro({
				place: place, 
				inTiddler: tiddler,
				whereClause: whereClause, 
				sortClause: sortClause, 
				sortAscending: sortAscending, 
				actionName: actionName, 
				actionParameter: actionParameter, 
				scriptText: scriptText, 
				tiddlyWikiPath: tiddlyWikiPath});

	} catch (e) {
		this.handleError(place, e);
	}
};

// Returns an object with properties &quot;tiddlers&quot; and &quot;context&quot;.
// tiddlers holds the (sorted) tiddlers selected by the parameter,
// context the context of the execution of the macro.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlersAndContext = function(parameter) {

	var context = config.macros.forEachTiddler.createContext(parameter.place, parameter.whereClause, parameter.sortClause, parameter.sortAscending, parameter.actionName, parameter.actionParameter, parameter.scriptText, parameter.tiddlyWikiPath, parameter.inTiddler);

	var tiddlyWiki = parameter.tiddlyWikiPath ? this.loadTiddlyWiki(parameter.tiddlyWikiPath) : store;
	context[&quot;tiddlyWiki&quot;] = tiddlyWiki;
	
	// Get the tiddlers, as defined by the whereClause
	var tiddlers = this.findTiddlers(parameter.whereClause, context, tiddlyWiki);
	context[&quot;tiddlers&quot;] = tiddlers;

	// Sort the tiddlers, when sorting is required.
	if (parameter.sortClause) {
		this.sortTiddlers(tiddlers, parameter.sortClause, parameter.sortAscending, context);
	}

	return {tiddlers: tiddlers, context: context};
};

// Returns the (sorted) tiddlers selected by the parameter.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlers = function(parameter) {
	return this.getTiddlersAndContext(parameter).tiddlers;
};

// Performs the macros with the given parameter.
//
// @param parameter holds the parameter of the macro as separate properties.
//				  The following properties are supported:
//
//						place
//						whereClause
//						sortClause
//						sortAscending
//						actionName
//						actionParameter
//						scriptText
//						tiddlyWikiPath
//
//					All properties are optional. 
//					For most actions the place property must be defined.
//
config.macros.forEachTiddler.performMacro = function(parameter) {
	var tiddlersAndContext = this.getTiddlersAndContext(parameter);

	// Perform the action
	var actionName = parameter.actionName ? parameter.actionName : &quot;addToList&quot;;
	var action = config.macros.forEachTiddler.actions[actionName];
	if (!action) {
		this.handleError(parameter.place, &quot;Unknown action '&quot;+actionName+&quot;'.&quot;);
		return;
	}

	var actionHandler = action.handler;
	actionHandler(parameter.place, tiddlersAndContext.tiddlers, parameter.actionParameter, tiddlersAndContext.context);
};

// ---------------------------------------------------------------------------
//  The actions 
// ---------------------------------------------------------------------------

// Internal.
//
// --- The addToList Action -----------------------------------------------
//
config.macros.forEachTiddler.actions.addToList.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;addToList&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var list = document.createElement(&quot;ul&quot;);
	place.appendChild(list);
	for (var i = 0; i &lt; tiddlers.length; i++) {
		var tiddler = tiddlers[i];
		var listItem = document.createElement(&quot;li&quot;);
		list.appendChild(listItem);
		createTiddlyLink(listItem, tiddler.title, true);
	}
};

abego.parseNamedParameter = function(name, parameter, i) {
	var beginExpression = null;
	if ((i &lt; parameter.length) &amp;&amp; parameter[i] == name) {
		i++;
		if (i &gt;= parameter.length) {
			throw &quot;Missing text behind '%0'&quot;.format([name]);
		}
		
		return config.macros.forEachTiddler.paramEncode(parameter[i]);
	}
	return null;
}

// Internal.
//
// --- The write Action ---------------------------------------------------
//
config.macros.forEachTiddler.actions.write.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;
	if (p &gt;= parameter.length) {
		this.handleError(place, &quot;Missing expression behind 'write'.&quot;);
		return;
	}

	var textExpression = config.macros.forEachTiddler.paramEncode(parameter[p]);
	p++;

	// Parse the &quot;begin&quot; option
	var beginExpression = abego.parseNamedParameter(&quot;begin&quot;, parameter, p);
	if (beginExpression !== null) 
		p += 2;
	var endExpression = abego.parseNamedParameter(&quot;end&quot;, parameter, p);
	if (endExpression !== null) 
		p += 2;
	var noneExpression = abego.parseNamedParameter(&quot;none&quot;, parameter, p);
	if (noneExpression !== null) 
		p += 2;

	// Parse the &quot;toFile&quot; option
	var filename = null;
	var lineSeparator = undefined;
	if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;toFile&quot;) {
		p++;
		if (p &gt;= parameter.length) {
			this.handleError(place, &quot;Filename expected behind 'toFile' of 'write' action.&quot;);
			return;
		}
		
		filename = config.macros.forEachTiddler.getLocalPath(config.macros.forEachTiddler.paramEncode(parameter[p]));
		p++;
		if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;withLineSeparator&quot;) {
			p++;
			if (p &gt;= parameter.length) {
				this.handleError(place, &quot;Line separator text expected behind 'withLineSeparator' of 'write' action.&quot;);
				return;
			}
			lineSeparator = config.macros.forEachTiddler.paramEncode(parameter[p]);
			p++;
		}
	}
	
	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;write&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(textExpression, context);
	var count = tiddlers.length;
	var text = &quot;&quot;;
	if (count &gt; 0 &amp;&amp; beginExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(beginExpression, context)(undefined, context, count, undefined);
	
	for (var i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		text += func(tiddler, context, count, i);
	}
	
	if (count &gt; 0 &amp;&amp; endExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(endExpression, context)(undefined, context, count, undefined);

	if (count == 0 &amp;&amp; noneExpression) 
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(noneExpression, context)(undefined, context, count, undefined);
		

	if (filename) {
		if (lineSeparator !== undefined) {
			lineSeparator = lineSeparator.replace(/\\n/mg, &quot;\n&quot;).replace(/\\r/mg, &quot;\r&quot;);
			text = text.replace(/\n/mg,lineSeparator);
		}
		saveFile(filename, convertUnicodeToUTF8(text));
	} else {
		var wrapper = createTiddlyElement(place, &quot;span&quot;);
		wikify(text, wrapper, null/* highlightRegExp */, context.inTiddler);
	}
};


// ---------------------------------------------------------------------------
//  Helpers
// ---------------------------------------------------------------------------

// Internal.
//
config.macros.forEachTiddler.createContext = function(placeParam, whereClauseParam, sortClauseParam, sortAscendingParam, actionNameParam, actionParameterParam, scriptText, tiddlyWikiPathParam, inTiddlerParam) {
	return {
		place : placeParam, 
		whereClause : whereClauseParam, 
		sortClause : sortClauseParam, 
		sortAscending : sortAscendingParam, 
		script : scriptText,
		actionName : actionNameParam, 
		actionParameter : actionParameterParam,
		tiddlyWikiPath : tiddlyWikiPathParam,
		inTiddler : inTiddlerParam, // the tiddler containing the &lt;&lt;forEachTiddler ...&gt;&gt; macro call.
		viewerTiddler : config.macros.forEachTiddler.getContainingTiddler(placeParam) // the tiddler showing the forEachTiddler result
	};
};

// Internal.
//
// Returns a TiddlyWiki with the tiddlers loaded from the TiddlyWiki of 
// the given path.
//
config.macros.forEachTiddler.loadTiddlyWiki = function(path, idPrefix) {
	if (!idPrefix) {
		idPrefix = &quot;store&quot;;
	}
	var lenPrefix = idPrefix.length;
	
	// Read the content of the given file
	var content = loadFile(this.getLocalPath(path));
	if(content === null) {
		throw &quot;TiddlyWiki '&quot;+path+&quot;' not found.&quot;;
	}
	
	var tiddlyWiki = new TiddlyWiki();

	// Starting with TW 2.2 there is a helper function to import the tiddlers
	if (tiddlyWiki.importTiddlyWiki) {
		if (!tiddlyWiki.importTiddlyWiki(content))
			throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
		tiddlyWiki.dirty = false;
		return tiddlyWiki;
	}
	
	// The legacy code, for TW &lt; 2.2
	
	// Locate the storeArea div's
	var posOpeningDiv = content.indexOf(startSaveArea);
	var posClosingDiv = content.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1)) {
		throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
	}
	var storageText = content.substr(posOpeningDiv + startSaveArea.length, posClosingDiv);
	
	// Create a &quot;div&quot; element that contains the storage text
	var myStorageDiv = document.createElement(&quot;div&quot;);
	myStorageDiv.innerHTML = storageText;
	myStorageDiv.normalize();
	
	// Create all tiddlers in a new TiddlyWiki
	// (following code is modified copy of TiddlyWiki.prototype.loadFromDiv)
	var store = myStorageDiv.childNodes;
	for(var t = 0; t &lt; store.length; t++) {
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute(&quot;tiddler&quot;);
		if(!title &amp;&amp; e.id &amp;&amp; e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title &amp;&amp; title !== &quot;&quot;) {
			var tiddler = tiddlyWiki.createTiddler(title);
			tiddler.loadFromDiv(e,title);
		}
	}
	tiddlyWiki.dirty = false;

	return tiddlyWiki;
};


	
// Internal.
//
// Returns a function that has a function body returning the given javaScriptExpression.
// The function has the parameters:
// 
//	 (tiddler, context, count, index)
//
config.macros.forEachTiddler.getEvalTiddlerFunction = function (javaScriptExpression, context) {
	var script = context[&quot;script&quot;];
	var functionText = &quot;var theFunction = function(tiddler, context, count, index) { return &quot;+javaScriptExpression+&quot;}&quot;;
	var fullText = (script ? script+&quot;;&quot; : &quot;&quot;)+functionText+&quot;;theFunction;&quot;;
	return eval(fullText);
};

// Internal.
//
config.macros.forEachTiddler.findTiddlers = function(whereClause, context, tiddlyWiki) {
	var result = [];
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(whereClause, context);
	tiddlyWiki.forEachTiddler(function(title,tiddler) {
		if (func(tiddler, context, undefined, undefined)) {
			result.push(tiddler);
		}
	});
	return result;
};

// Internal.
//
config.macros.forEachTiddler.createExtraParameterErrorElement = function(place, actionName, parameter, firstUnusedIndex) {
	var message = &quot;Extra parameter behind '&quot;+actionName+&quot;':&quot;;
	for (var i = firstUnusedIndex; i &lt; parameter.length; i++) {
		message += &quot; &quot;+parameter[i];
	}
	this.handleError(place, message);
};

// Internal.
//
config.macros.forEachTiddler.sortAscending = function(tiddlerA, tiddlerB) {
	var result = 
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue) 
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? -1 
			   : +1; 
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortDescending = function(tiddlerA, tiddlerB) {
	var result = 
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue) 
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? +1 
			   : -1; 
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortTiddlers = function(tiddlers, sortClause, ascending, context) {
	// To avoid evaluating the sortClause whenever two items are compared 
	// we pre-calculate the sortValue for every item in the array and store it in a 
	// temporary property (&quot;forEachTiddlerSortValue&quot;) of the tiddlers.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(sortClause, context);
	var count = tiddlers.length;
	var i;
	for (i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		tiddler.forEachTiddlerSortValue = func(tiddler,context, undefined, undefined);
	}

	// Do the sorting
	tiddlers.sort(ascending ? this.sortAscending : this.sortDescending);

	// Delete the temporary property that holds the sortValue.	
	for (i = 0; i &lt; tiddlers.length; i++) {
		delete tiddlers[i].forEachTiddlerSortValue;
	}
};


// Internal.
//
config.macros.forEachTiddler.trace = function(message) {
	displayMessage(message);
};

// Internal.
//
config.macros.forEachTiddler.traceMacroCall = function(place,macroName,params) {
	var message =&quot;&lt;&lt;&quot;+macroName;
	for (var i = 0; i &lt; params.length; i++) {
		message += &quot; &quot;+params[i];
	}
	message += &quot;&gt;&gt;&quot;;
	displayMessage(message);
};


// Internal.
//
// Creates an element that holds an error message
// 
config.macros.forEachTiddler.createErrorElement = function(place, exception) {
	var message = (exception.description) ? exception.description : exception.toString();
	return createTiddlyElement(place,&quot;span&quot;,null,&quot;forEachTiddlerError&quot;,&quot;&lt;&lt;forEachTiddler ...&gt;&gt;: &quot;+message);
};

// Internal.
//
// @param place [may be null]
//
config.macros.forEachTiddler.handleError = function(place, exception) {
	if (place) {
		this.createErrorElement(place, exception);
	} else {
		throw exception;
	}
};

// Internal.
//
// Encodes the given string.
//
// Replaces 
//	 &quot;$))&quot; to &quot;&gt;&gt;&quot;
//	 &quot;$)&quot; to &quot;&gt;&quot;
//
config.macros.forEachTiddler.paramEncode = function(s) {
	var reGTGT = new RegExp(&quot;\\$\\)\\)&quot;,&quot;mg&quot;);
	var reGT = new RegExp(&quot;\\$\\)&quot;,&quot;mg&quot;);
	return s.replace(reGTGT, &quot;&gt;&gt;&quot;).replace(reGT, &quot;&gt;&quot;);
};

// Internal.
//
// Returns the given original path (that is a file path, starting with &quot;file:&quot;)
// as a path to a local file, in the systems native file format.
//
// Location information in the originalPath (i.e. the &quot;#&quot; and stuff following)
// is stripped.
// 
config.macros.forEachTiddler.getLocalPath = function(originalPath) {
	// Remove any location part of the URL
	var hashPos = originalPath.indexOf(&quot;#&quot;);
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert to a native file format assuming
	// &quot;file:///x:/path/path/path...&quot; - pc local file --&gt; &quot;x:\path\path\path...&quot;
	// &quot;file://///server/share/path/path/path...&quot; - FireFox pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	// &quot;file:///path/path/path...&quot; - mac/unix local file --&gt; &quot;/path/path/path...&quot;
	// &quot;file://server/share/path/path/path...&quot; - pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	var localPath;
	if(originalPath.charAt(9) == &quot;:&quot;) // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file://///&quot;) === 0) // FireFox pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(10)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file:///&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf(&quot;file:/&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(7)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);	
	return localPath;
};

// ---------------------------------------------------------------------------
// Stylesheet Extensions (may be overridden by local StyleSheet)
// ---------------------------------------------------------------------------
//
setStylesheet(
	&quot;.forEachTiddlerError{color: #ffffff;background-color: #880000;}&quot;,
	&quot;forEachTiddler&quot;);

//============================================================================
// End of forEachTiddler Macro
//============================================================================


//============================================================================
// String.startsWith Function
//============================================================================
//
// Returns true if the string starts with the given prefix, false otherwise.
//
version.extensions[&quot;String.startsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.startsWith = function(prefix) {
	var n =  prefix.length;
	return (this.length &gt;= n) &amp;&amp; (this.slice(0, n) == prefix);
};



//============================================================================
// String.endsWith Function
//============================================================================
//
// Returns true if the string ends with the given suffix, false otherwise.
//
version.extensions[&quot;String.endsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.endsWith = function(suffix) {
	var n = suffix.length;
	return (this.length &gt;= n) &amp;&amp; (this.right(n) == suffix);
};


//============================================================================
// String.contains Function
//============================================================================
//
// Returns true when the string contains the given substring, false otherwise.
//
version.extensions[&quot;String.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.contains = function(substring) {
	return this.indexOf(substring) &gt;= 0;
};

//============================================================================
// Array.indexOf Function
//============================================================================
//
// Returns the index of the first occurance of the given item in the array or 
// -1 when no such item exists.
//
// @param item [may be null]
//
version.extensions[&quot;Array.indexOf&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.indexOf = function(item) {
	for (var i = 0; i &lt; this.length; i++) {
		if (this[i] == item) {
			return i;
		}
	}
	return -1;
};

//============================================================================
// Array.contains Function
//============================================================================
//
// Returns true when the array contains the given item, otherwise false. 
//
// @param item [may be null]
//
version.extensions[&quot;Array.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.contains = function(item) {
	return (this.indexOf(item) &gt;= 0);
};

//============================================================================
// Array.containsAny Function
//============================================================================
//
// Returns true when the array contains at least one of the elements 
// of the item. Otherwise (or when items contains no elements) false is returned.
//
version.extensions[&quot;Array.containsAny&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAny = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (this.contains(items[i])) {
			return true;
		}
	}
	return false;
};


//============================================================================
// Array.containsAll Function
//============================================================================
//
// Returns true when the array contains all the items, otherwise false.
// 
// When items is null false is returned (even if the array contains a null).
//
// @param items [may be null] 
//
version.extensions[&quot;Array.containsAll&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAll = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (!this.contains(items[i])) {
			return false;
		}
	}
	return true;
};


} // of &quot;install only once&quot;

// Used Globals (for JSLint) ==============
// ... DOM
/*global 	document */
// ... TiddlyWiki Core
/*global 	convertUnicodeToUTF8, createTiddlyElement, createTiddlyLink, 
			displayMessage, endSaveArea, hasClass, loadFile, saveFile, 
			startSaveArea, store, wikify */
//}}}


/***
!Licence and Copyright
Copyright (c) abego Software ~GmbH, 2005 ([[www.abego-software.de|http://www.abego-software.de]])

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of abego Software nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
***/

</pre>
</div>
<div title="Fullscreen font changing" modifier="Mingos" created="201009182107" tags="issueTracker bug open" changecount="1">
<pre>Changing the font when in fullscreen mode reverts back to windowed mode. While not a fatal bug, this can be annoying.
The source of the bug may be Umbra or libtcod - to be investigated.</pre>
</div>
<div title="Initialisation versus activation" modifier="Mingos" created="200911162110" modified="201007271722" tags="tutorial module" changecount="6">
<pre>The [[UmbraModule]] provides two virtual methods which can be overridden in a custom module. These are [[UmbraModule::initialise]] and [[UmbraModule::activate]]. The difference between the two might seem a bit blurry, so let's have a closer look at what they do.
!Initialisation
The [[UmbraModule::initialise]] method is run only once per module in the entire execution time of the application. In fact, for some modules, it might never be run, but in this case, the module simply never gets activated. What we need to bear in mind is that the method will be run only when the module is activated ''for the first time''. Every subsequent activation will not trigger initialisation anymore.

What's the practical use of this feature? The initialisation might as well be handled in the constructor, one might remark. The answer is simple: the module might depend on information that's not available at the moment the constructor is run. Sure, in most cases it won't. But what if it does? Well, that's when this method can provide a delayed initialisation or a &quot;second constructor&quot;.
!Activation
The activation of a module consists essentially of putting the module on the activation list, and commencing to run it, starting from the subsequent frame (or main loop iteration). During activation, it might be necessary to run some sort of custom code. This is when [[UmbraModule::activate]] comes in. It is run once per module activation.

A simple example of its practical use would be a module with a timeout, such as the [[BSOD]]. During the activation of the [[BSOD]], the module needs to check and store the elapsed time from application start. This value is set every time the module is activated in order to know when it's supposed to be deactivated. Until it's actually deactivated, the value will not change. The effect is a timeout: the module deactivates itself X time after activation.

Paired with [[UmbraModule::activate]] is also [[UmbraModule::deactivate]]. In case a module needs to run some special code upon deactivation, it's enough to override this method.</pre>
</div>
<div title="Internal callbacks" modifier="Mingos" created="201008111256" tags="tutorial callback" changecount="1">
<pre>Umbra has a couple of predefined callbacks. You can see the full list [[here|Callbacks]].

These are the internal callbacks, which can be registered automatically, providing the engine is initialised with a [[flag|UmbraRegisterCallbackFlag]] that enables this. They can also be registered manually - please refer to the individual callbacks in order to check how they can be registered.</pre>
</div>
<div title="Issue tracker" modifier="Mingos" created="201008111302" modified="201008191746" tags="issueTracker" changecount="8">
<pre>&lt;&lt;tabs api
    &quot;Bug reports&quot; &quot;Bug reports&quot; [[IssueTrackerBugs]]
    &quot;RFEs&quot; &quot;Requests for enhancement&quot; [[IssueTrackerRfes]]
&gt;&gt;</pre>
</div>
<div title="IssueTrackerBugs" modifier="Mingos" created="201008111303" modified="201008191749" tags="issueTracker bug" changecount="8">
<pre>&lt;&lt;tabs bugs
    &quot;Open&quot; &quot;Open bugs&quot; [[IssueTrackerBugsOpen]]
    &quot;Closed&quot; &quot;Closed bugs&quot; [[IssueTrackerBugsClosed]]
&gt;&gt;</pre>
</div>
<div title="IssueTrackerBugsClosed" modifier="Mingos" created="201008191747" tags="issueTracker bug closedBugs" changecount="1">
<pre>&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;issueTracker&quot;,&quot;bug&quot;,&quot;closed&quot;])'&gt;&gt;</pre>
</div>
<div title="IssueTrackerBugsOpen" modifier="Mingos" created="201008191745" modified="201008191745" tags="issueTracker bug openBugs" changecount="3">
<pre>&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;issueTracker&quot;,&quot;bug&quot;,&quot;open&quot;])'&gt;&gt;</pre>
</div>
<div title="IssueTrackerRfes" modifier="Mingos" created="201008111303" modified="201008191751" tags="issueTracker RFE" changecount="6">
<pre>&lt;&lt;tabs rfes
    &quot;Open&quot; &quot;Open RFEs&quot; [[IssueTrackerRfesOpen]]
    &quot;Closed&quot; &quot;Closed RFEs&quot; [[IssueTrackerRfesClosed]]
&gt;&gt;</pre>
</div>
<div title="IssueTrackerRfesClosed" modifier="Mingos" created="201008191750" tags="issueTracker RFE closedRFE" changecount="1">
<pre>&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;issueTracker&quot;,&quot;RFE&quot;,&quot;closed&quot;])'&gt;&gt;</pre>
</div>
<div title="IssueTrackerRfesOpen" modifier="Mingos" created="201008191749" tags="issueTracker RFE openRFE" changecount="1">
<pre>&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;issueTracker&quot;,&quot;RFE&quot;,&quot;open&quot;])'&gt;&gt;</pre>
</div>
<div title="MainMenu" modifier="Mingos" created="200910241817" modified="201008111259" changecount="3">
<pre>[[About Umbra]]
[[Using Umbra]]
[[API reference]]
[[Issue tracker]]
[[Change log]]
[[Credits]]</pre>
</div>
<div title="Methods" modifier="Mingos" created="200911042331" modified="201008171122" tags="api method" changecount="42">
<pre>&lt;&lt;tabs methods
    &quot;UmbraEngine&quot; &quot;UmbraEngine methods&quot; [[UmbraEngineMethods]]
    &quot;UmbraModule&quot; &quot;UmbraModule methods&quot; [[UmbraModuleMethods]]
    &quot;UmbraWidget&quot; &quot;UmbraWidget methods&quot; [[UmbraWidgetMethods]]
    &quot;UmbraCallback&quot; &quot;UmbraCallback methods&quot; [[UmbraCallbackMethods]]
    &quot;UmbraKey&quot; &quot;UmbraKey methods&quot; [[UmbraKeyMethods]]
    &quot;UmbraPoint&quot; &quot;UmbraPoint methods&quot; [[UmbraPointMethods]]
    &quot;UmbraRect&quot; &quot;UmbraRect methods&quot; [[UmbraRectMethods]]
    &quot;UmbraError&quot; &quot;UmbraError methods&quot; [[UmbraErrorMethods]]
&gt;&gt;</pre>
</div>
<div title="Mingos" modifier="Mingos" created="200910241825" modified="201007252151" changecount="5">
<pre>One of the developers of this humble engine. Please visit my websites for more details about what I do.
*http://www.umbraprojekt.pl/
*http://umbrarumregnum.110mb.com/</pre>
</div>
<div title="Module ID" modifier="Mingos" created="201009182113" modified="201009182157" tags="tutorial module" changecount="8">
<pre>Module ID, as the name implies, is a unique identification number assigned to a module.

The ID numbers are integers, assigned to the modules in an ascending order, starting from 0. The assignment is done automatically when [[registering modules|Registering modules]]. The first module that is registered in the engine will be given an ID of 0, the next one will have an ID of 1 and so on.

The ID numbers are then used for [[referencing modules|Accessing modules and widgets]].

There are different approaches to managing the module ID numbers in an application:
!Manual assignment
Since the way the engine assigns ID numbers is predictable, one can register modules in a predetermined order an then simply use constants:
&lt;code C++&gt;
enum {
    MOD_INTRO,
    MOD_MENU,
    MOD_GAME
};
UmbraEngine engine;
engine.registerModule(new moduleIntro());
engine.registerModule(new moduleMenu());
engine.registerModule(new moduleGame());
UmbraModule * currentModule = engine.getModule(MOD_INTRO);
&lt;/code&gt;
The modules need to be registered in the exact same order as specified in the enum.
!Hash table
It's also possible to create a hash table or an associative array and call the modules by their key, typically a string. A decent way of achieving this is the {{{std::map}}} class.
&lt;code C++&gt;
UmbraEngine engine;
std::map&lt;std::string, int&gt; modules;
modules.insert(&quot;intro&quot;,engine.registerModule(new moduleIntro()));
modules.insert(&quot;menu&quot;,engine.registerModule(new moduleMenu()));
modules.insert(&quot;game&quot;,engine.registerModule(new moduleGame()));
UmbraModule * currentModule = engine.getModule(modules[&quot;intro&quot;]);
&lt;/code&gt;
!Variables
Module ID numbers can be stored in variables, although it would be important to make their scope large enough so that they are accessible from any place in the code.
&lt;code C++&gt;
UmbraEngine engine;
int moduleIntroID = engine.registerModule(new moduleIntro());
int moduleMenuID = engine.registerModule(new moduleMenu());
int moduleGameID = engine.registerModule(new moduleGame());
UmbraModule * currentModule = engine.getModule(moduleIntroID);
&lt;/code&gt;</pre>
</div>
<div title="Module timeout" modifier="Mingos" created="201010051123" modified="201010051123" tags="issueTracker RFE open" changecount="2">
<pre>There should be an ~UmbraModule method for setting a timeout on a module.
The module would store the activation time and deactivate itself automatically after the time specified in the timeout has passed.
Good for things like credits screens that are supposed to be displayed only during a few seconds.</pre>
</div>
<div title="Operators" modifier="Mingos" created="201008152255" modified="201008191017" tags="api operator" changecount="33">
<pre>*[[UmbraKey::operator ==]]
*[[UmbraPoint::operator ==]]</pre>
</div>
<div title="PageTemplate" modifier="Mingos" created="200701130013" modified="201008171336" server.type="file" server.host="tiddlythemes.com/empties/Monochrome.html" server.page.revision="200708091512" changecount="18">
<pre>&lt;div id='header' class='header' macro='gradient vert   #555555       #3b3b3b '&gt;
        &lt;div class='siteTitle'&gt;
                &lt;div class='siteTitleInner' refresh='content' tiddler='SiteTitle'&gt;&lt;/div&gt;
                &lt;div class='siteSubtitleInner' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;span id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Referencing the engine" modifier="Mingos" created="200911110037" modified="201007271423" tags="tutorial engine engineReference" changecount="14">
<pre>Since the engine is the basic and most important class in all Umbra-powered applications, it is obvious that it needs to be referenced across the code. There are three ways of achieving this:
#Via a global variable,
#Via a static engine instance getter,
#Via a helper method.
!Global variable

The simplest way to create a universal engine reference valid in all parts of code is to create a global engine instance. It will be available to all the classes throughout the source code. The global instance can be created by adding a declaration in {{{main.hpp}}}:
&lt;code C++&gt;
extern UmbraEngine engine;
&lt;/code&gt;
and an implementation in {{{main.cpp}}}, before {{{main()}}}. This will allow to reference the engine by its global variable name:
&lt;code C++&gt;
#include &lt;main.hpp&gt;
UmbraEngine engine (&quot;data/cfg/umbra.txt&quot;,true,false);
...
int main (void) {
    engine.setWindowTitle(&quot;Umbra demo&quot;);
    ...
}
&lt;/code&gt;
!Engine instance getter

The engine has a static getter method that will retrieve a pointer to the engine instance: [[UmbraEngine::getInstance]]. Since it is a static method, it can be called anywhere throughout the code. If the engine has not been create, the first call to this function will create it with default parameters. Example:
&lt;code C++&gt;
class Example {
    inline void title (void) {
        UmbraEngine::getInstance()-&gt;setWindowTitle(&quot;Umbra demo&quot;);
    }
};
&lt;/code&gt;
!Helper methods

There are two special cases where helper methods have been introduced in order to spare the developer the necessity to write the entire code of the above method call. In [[UmbraModule]] and [[UmbraCallback]] special methods are available: [[UmbraModule::getEngine]] and [[UmbraCallback::getEngine]]. All classes that inherit either of the two may use this simplified syntax to retrieve a pointer to the engine:
&lt;code C++&gt;
class MyModule : public UmbraModule {
    inline void title (void) {
        getEngine()-&gt;setWindowTitle(&quot;Umbra demo&quot;);
    }
};
&lt;/code&gt;
Please note that [[UmbraWidget]] inherits [[UmbraModule]] and thus the [[UmbraModule::getEngine]] method is also available inside widgets.</pre>
</div>
<div title="Registering fonts" modifier="Mingos" created="200911112244" modified="201007272149" tags="tutorial font init" changecount="4">
<pre>As with the modules, registering a font &quot;tells&quot; the engine that there is a font file ready to be used. It has nothing to do with actually using the font.

Registering a font can be done using [[UmbraEngine::registerFont]] method. It is necessary to specify the font file, as well as the number of columns and rows. Optionally, the layout can also be specified, although this is not necessary for fonts that use the default TCOD layout.

Once the fonts are registered, the engine will be able to choose the correct font file to load.</pre>
</div>
<div title="Registering modules" modifier="Mingos" created="200911112149" modified="201007272149" tags="tutorial module init" changecount="4">
<pre>Registering a module is basically &quot;telling&quot; the engine that a module has been instantiated and that you would like to make it useable. Registering a module can be done by calling [[UmbraEngine::registerModule]] method.

Note that you may both instantiate the module before calling [[UmbraEngine::registerModule]] and pass the method a reference to the module, or you may simply instantiate the module inside the method's argument.
&lt;code C++&gt;
UmbraEngine engine();
UmbraModule * mod1 = new MyModule1();
engine.registerModule(mod1);
int mod2id = engine.registerModule(new MyModule2());
&lt;/code&gt;
In the above example, we can access both modules in different ways:
&lt;code C++&gt;
mod1-&gt;method();
engine.getModule(mod2)-&gt;method();
&lt;/code&gt;
Please read [[Accessing modules and widgets]] for more detailed information on this topic.
</pre>
</div>
<div title="Reporting an error" modifier="Mingos" created="200911111608" modified="201010021201" tags="tutorial error" changecount="4">
<pre>Reporting an error is extremely easy in Umbra. It's enough to add this line of code:
&lt;code C++&gt;
UmbraError::add(UMBRA_ERRORLEVEL_ERROR, &quot;Error message&quot;);
&lt;/code&gt;
This method will send the specified error message to stderr, append it to the error list and also save the file {{{errorlog.txt}}}, containing all of the error messages registered so far, to the hard disc.

Bear in mind that this method accepts printf-like text formatting. Ultimately, you can also pass a {{{std::string}}} as the argument instead of {{{const char*}}}.</pre>
</div>
<div title="Scautura" modifier="Scautura" created="200911111208" changecount="1">
<pre>Proofreader. Nothing more.</pre>
</div>
<div title="Setting the renderer" modifier="Mingos" created="201010051127" tags="issueTracker bug open" changecount="1">
<pre>The renderer should be specified in the config file, not passed to the engine's initialisation function. The user should be able to change it in case the default one doesn't work.</pre>
</div>
<div title="SideBarOptions" modifier="Mingos" created="200701130013" modified="201008111353" server.type="file" server.host="tiddlythemes.com/empties/LewcidOrange.html" server.page.revision="200708091512" changecount="15">
<pre>&lt;&lt;closeAll&gt;&gt;
&lt;&lt;saveChanges&gt;&gt;
&lt;&lt;newTiddler&gt;&gt;
&lt;&lt;newTiddler
 label:&quot;new bug report&quot;
 tag:&quot;issueTracker&quot;
 tag:&quot;bug&quot;
 tag:&quot;open&quot;
&gt;&gt;
&lt;&lt;newTiddler
 label:&quot;new RFE&quot;
 tag:&quot;issueTracker&quot;
 tag:&quot;RFE&quot;
 tag:&quot;open&quot;
&gt;&gt;
&lt;&lt;slider chkSliderOptionsPanel OptionsPanel 'options ' 'Change TiddlyWiki advanced options'&gt;&gt;</pre>
</div>
<div title="SideBarTabs" modifier="Mingos" created="201007252144" modified="201007271447" server.type="file" server.host="tiddlythemes.com/empties/Monochrome.html" changecount="2">
<pre>&lt;&lt;tabs txtMainTab &quot;Tags&quot; &quot;All tags&quot; TabTags &quot;Timeline&quot; &quot;Timeline&quot; TabTimeline &quot;All&quot; &quot;All tiddlers&quot; TabAll &quot;More&quot; &quot;More lists&quot; TabMore&gt;&gt;</pre>
</div>
<div title="SideBarWG" modifier="Mingos" created="200701130013" modified="201008020034" server.type="file" server.host="tiddlythemes.com/empties/LewcidOrange.html" server.page.revision="200708091512" changecount="2">
<pre>/***
This CSS by ~DaveBirss.
***/
/*{{{*/


.tabSelected {
 background: #fff;
}

.tabUnselected {
 background: #eee;
}

#sidebar {
 color: #000;
 background: transparent; 
}

#sidebarOptions {
 background: #fff;
}

#sidebarOptions input {
	border: 1px solid #ccc;
}

#sidebarOptions input:hover, #sidebarOptions input:active,  #sidebarOptions input:focus {
	border: 1px solid #000;
}

#sidebarOptions .button {
 color: #999;
}

#sidebarOptions .button:hover {
 color: #000;
 background: #fff;
 border-color:white;
}

#sidebarOptions .button:active {
 color: #000;
 background: #fff;
}

#sidebarOptions .sliderPanel {
 background: transparent;
}

#sidebarOptions .sliderPanel A {
 color: #999;
}

#sidebarOptions .sliderPanel A:hover {
 color: #000;
 background: #fff;
}

#sidebarOptions .sliderPanel A:active {
 color: #000;
 background: #fff;
}

.sidebarSubHeading {
 color: #000;
}

#sidebarTabs {`
 background: #fff
}

#sidebarTabs .tabSelected {
 color: #000;
 background: #fff;
 border-top: solid 1px #ccc;
 border-left: solid 1px #ccc;
 border-right: solid 1px #ccc;
 border-bottom: none;
}

#sidebarTabs .tabUnselected {
 color: #999;
 background: #eee;
 border-top: solid 1px #ccc;
 border-left: solid 1px #ccc;
 border-right: solid 1px #ccc;
 border-bottom: none;
}

#sidebarTabs .tabContents {
 background: #fff;
}


#sidebarTabs .txtMoreTab .tabSelected {
 background: #fff;
}

#sidebarTabs .txtMoreTab .tabUnselected {
 background: #eee;
}

#sidebarTabs .txtMoreTab .tabContents {
 background: #fff;
}

#sidebarTabs .tabContents .tiddlyLink {
 color: #999;
 border:none;
}

#sidebarTabs .tabContents .tiddlyLink:hover {
 background: #fff;
 color: #000;
 border:none;
}

#sidebarTabs .tabContents {
 color: #000;
}

#sidebarTabs .button {
 color: #666;
}

#sidebarTabs .tabContents .button:hover {
 color: #000;
 background: #fff;
}

#sidebar {color:#999;}
/*}}}*/</pre>
</div>
<div title="SiteSubtitle" modifier="Mingos" created="200910241742" modified="201008191015" changecount="3">
<pre>powering libtcod-based applications</pre>
</div>
<div title="SiteTitle" modifier="Mingos" created="200910241741" modified="201008171331" changecount="5">
<pre>Umbra</pre>
</div>
<div title="Speed-o-meter" modifier="Mingos" created="201003301739" modified="201007272129" tags="tutorial internalModule" changecount="16">
<pre>The Speed-o-meter, or &quot;Speedo&quot;, is a benchmarking tool. It removes the frames per second limit so that the usage of the CPU core running the main program thread can go up to 100%. It also displays a small window with a graph depicting the time spent on various calculations:
* ''update'' - time spent inside your active modules' [[update()|UmbraModule::update]] method,
* ''render'' - time spent inside your active modules' [[render()|UmbraModule::render]] method,
* ''system'' - the time spent on &quot;system calls&quot; (everything not belonging to the above two).
Apart fromt this information, Speedo will also tell you how long it took to render the last frame (in milliseconds - constant values of 40ms and above should be considered a warning, especially on a fast CPU) and how many frames per second your program manages to render (if this value is much higher than your usual frames per second limit, you have no performance issues).

When turned off, Speedo will set the frames per second limit back to its previous value.

If UmbraEngine is initialised with the additional callbacks enabled (see [[UmbraEngine::UmbraEngine]]), Speedo will turn itself on and off when you press F5.

Please remember to use a code profiler, such as gprof, to profile your code. Speedo is not a profiler, it can merely inform you of possible performance issues, but will not identify any bottlenecks in the program.</pre>
</div>
<div title="Starting a project using Umbra" modifier="Mingos" created="201003301731" modified="201009182212" tags="tutorial basics init" changecount="9">
<pre>Umbra is not a library, but a framework in the form of a collection of C++ source code files. As such, absolutely no linking is required to start using Umbra.

What is necessary, however, is adding the code that comes with Umbra to your project. Since you're not likely to want to modify Umbra files, save in some corner cases where you might need a higher grade of customisation, you are advised to place Umbra files in a separate directory so that they don't distract you from your own code.

Once you have done that, all you need to do to be able to start using Umbra is including its main header file in your code:
&lt;code C++&gt;
#include &quot;umbra.hpp&quot;
&lt;/code&gt;
Remember that ''Umbra requires libtcod to run''!</pre>
</div>
<div title="StyleSheet" modifier="Mingos" created="200701130013" modified="201008190950" server.type="file" server.host="tiddlythemes.com/empties/Monochrome.html" server.page.revision="200708091512" changecount="53">
<pre>[[StyleSheetSyntaxHighlighter]]

/*{{{*/
/*Monochrome Theme for TiddlyWiki*/
/*Design and CSS by Saq Imtiaz*/
/*Version 1.0*/
/*}}}*/
/*{{{*/

body {background:#3B3B3B; color:#C3C3C3; font:12px Verdana, Helvetica, sans-serif;
	}

#header {padding: 0em 0em 0em 0em; background:transparent;	font-family: arial,helvetica; font-size:12px;
 }

.siteTitle {
padding-top: 32px;
padding-bottom: 32px;
float:left;
font-family: 'Trebuchet MS' sans-serif;
font-weight: bold;
font-size: 48px;
color: #ccc; margin-right:1em;margin-left:0.5em;
}

.siteTitleInner {
    margin-bottom: -8px;
}

.siteSubtitleInner {
    font-size: 12px;
    font-weight: normal;
    border-top: 2px solid #ccc;
}

#topMenu br {display:none;}
#topMenu a, #topMenu .tiddlyLink, #topMenu .button {margin:0em; color:#666; padding: 92px 15px 15px 15px; border:none; border-right: 1px solid #666;float:left;}
#topMenu {border-left: 1px solid #666;  float:left;margin:0;}
#topMenu a:hover {color:#ccc; background:#3b3b3b;}

#displayArea {margin-left:1.35em; margin-right:17.65em; margin-top:0.5em; padding-top:1em; padding-bottom:10px;}

.tiddler {background:#454545; margin-bottom:20px; padding:1em 2em 1em 2em; -moz-border-radius: 10px; -webkit-border-radius: 10px; border-radius: 10px; }

a, a:hover{
color:#fff;
text-decoration: none; background:transparent;
}

.viewer a, .viewer a:hover{border-bottom:1px dotted #fff; font-weight:normal;}

.viewer .button, .editorFooter .button{
color: #fff;
border: 1px solid #fff;
}

.viewer .button:hover,
.editorFooter .button:hover, .viewer .button:active, .viewer .highlight,.editorFooter .button:active, .editorFooter .highlight{
color: #fff;
background: #3B3B3B;
border-color: #3B3B3B;
}

.title {color:#ccc; font-family:'Lucida Grande', Verdana, Sans-Serif; font-size:1.5em;
}

.subtitle, .subtitle a { color: #777; font-size: 0.95em;margin:0.2em;}
.shadow .title{color:#777;}

.toolbar {font-size:90%; margin-bottom: 5px;}
.selected .toolbar a {color:#666;border:0;}
.selected .toolbar a:hover {color:#999; background:transparent;border:0;}

.toolbar .button:hover, .toolbar .highlight, .toolbar .marked, .toolbar a.button:active{color:#666;border:0; background:transparent;border:0;}

.tagging, .tagged {
border: 1px solid #555;
background-color: 	#444;
-moz-border-radius: 10px; -webkit-border-radius: 10px; border-radius: 10px;
}

.selected .tagging, .selected .tagged {
background-color: 	#3B3B3B;
border: 1px solid #666;
}

.tagging .listTitle, .tagged .listTitle {
color: #666;
}

.selected .tagging .listTitle, .selected .tagged .listTitle {
color: #aaa;
}

.tagging .button, .tagged .button {
color:		#838383;
}
.selected .tagging .button, .selected .tagged .button {
color:#c3c3c3;
}

.highlight, .marked {background:transparent; color:#111; border:none; text-decoration:underline;}

.tagging .button:hover, .tagged .button:hover, .tagging .button:active, .tagged .button:active {
border: none; background:transparent; text-decoration:underline; color:#333;
}

#sidebarOptions {margin-top:1em;}
#sidebar {margin-right:1.35em;}

#sidebarTabs .tabContents {	
	font-family: arial,helvetica;}

#sidebarOptions a, #sidebarOptions a:hover{border:none;color:#666;}
#sidebarOptions a:hover, #sidebarOptions a:active {background:#454545; color:#ccc;}
#sidebarTabs .tabContents {background:#454545;border:0px solid #666; border-right:1px solid #454545;}
#sidebarOptions input {background:#ccc; border:1px solid #666;}

#sidebarTabs .tabContents .tiddlyLink, #sidebarTabs .tabContents .button{color:#666;font-weight:normal;}
#sidebarTabs .tabContents .tiddlyLink:hover, #sidebarTabs .tabContents .button:hover {color:#ccc; background:transparent;}
.listTitle {color:#777;}

#sidebarTabs .tabSelected,#sidebarTabs .tabSelected:hover{background:#454545;border:none;color:#ccc; border:1px solid #454545;}
#sidebarTabs .tabUnselected{background:#3B3B3B; border:1px solid #454545; color:#666;}

   #sidebarTabs .txtMoreTab .tabSelected,
   #sidebarTabs .txtMoreTab .tab:hover,
   #sidebarTabs .txtMoreTab .tabContents{
color: #ccc;
background: #3B3B3B; border:1px solid #3B3B3B;
}

   #sidebarTabs .txtMoreTab .tabUnselected {

color: #777; border:1px solid #3B3B3B;
background: #454545;
}


#sidebarTabs .tabContents .button:hover, #sidebarTabs .tabContents .highlight, #sidebarTabs .tabContents .marked, #sidebarTabs .tabContents a.button:active{color:#ccc; background:transparent;}

   #sidebarOptions .sliderPanel {
background: #454545; font-size: .9em;
}

#sidebarOptions .sliderPanel input {border:1px solid #666; background:#ccc;}
#sidebarOptions .sliderPanel .txtOptionInput {border:1px solid #666;width:9em;}

#sidebarOptions .sliderPanel a {font-weight:normal; color:#666;background-color: #454545; border-bottom:1px dotted #333;}

#sidebarOptions .sliderPanel a:hover {
color:#ccc;
background-color: #454545;
border:none;
border-bottom:1px dotted #111;
}

.popup {
background: #3B3B3B;
border: 1px solid #454545;
}

.popup li.disabled {
color: #000;
}

.popup li a, .popup li a:visited {
color: #777;
border: none;
}

.popup li a:hover {
background: #3b3b3b;
color: #c3c3c3;
border: none;
}
.popup hr {
	color: #777;
	background: #777;
	border-bottom: 1px;
}

.listBreak div{
	border-bottom: 1px solid #777;
}

#messageArea {
border: 4px dotted #ccc;
background: #454545;
color: #777;
font-size:90%;
}

#messageArea .button{

color: #3B3B3B;
background:#ccc;
border: 1px solid #ccc;
}

#messageArea .button:hover {

color: #ccc;
background: #3B3B3B;
border-color: #3B3B3B;
}

.viewer blockquote {
border-left: 5px solid 		#3B3B3B; background:#3B3B3B
}

.viewer table, .viewer td {
border: 1px solid 	#2E2E2E;
}

.viewer th, thead td {
background: #3B3B3B;
border: 1px solid #3B3B3B;
color: #ccc;
}
.viewer pre {
border: 1px solid #3b3b3b;
background: #5F5F5F;
}

.viewer code {
color: #c3c3c3; background:#5f5f5f;
}

.viewer hr {
border-top: dashed 1px #222; margin:0 1em;
}

.editor input {
border: 1px solid #ccc; margin-top:5px;
}

.editor textarea {
border: 1px solid #ccc;
}

h1,h2,h3,h4,h5 { color: 		#9c9c9c; background: transparent; padding-bottom:2px; font-family: Arial, Helvetica, sans-serif; }
h1 {font-size:18px;}
h2 {font-size:16px;}
h3 {font-size: 14px;}

a.tiddlyLinkExisting, a.tiddlyLinkExisting:hover {
    font-weight: bold;
}

.viewer .tabset {
    padding: 12px 0px;
}

.viewer a.tab {
    padding: 10px 5px;
    border-top-right-radius: 10px; -moz-border-radius-topright: 10px; -webkit-border-top-right-radius: 10px;
    border: 2px solid #888888;
    font-size: 80%;
}

.viewer .tabContents {
    background: #383838;
    color: #C3C3C3;
}

.viewer ul {
    list-style: none;
}

.viewer ul li {
    padding-left: 20px;
    margin-bottom: 3px;
    background: url(data:image/png;base64,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) left top no-repeat transparent;
}

#tiddlerDisplay .title {
    padding-left: 40px;
    padding-top: 15px;
    border-top: 3px solid #666666;
    background: url(data:image/png;base64,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%3D) left bottom no-repeat #505050;
}

#tiddlerDisplay .subtitle { background: #505050; padding: 5px 40px; margin: 0 0 10px 0; border-bottom: 3px solid #666666; }

.siteTitle {
    padding-left: 32px;
    background: url(data:image/png;base64,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) left center no-repeat;
}</pre>
</div>
<div title="StyleSheetSyntaxHighlighter" modifier="Mingos" created="200904132302" modified="201007202130" server.type="file" server.host="dl.getdropbox.com/u/52078/Notes/Notes.html" server.page.revision="200904132302" changecount="3">
<pre>/***
StyleSheet for ~SyntaxHighlighter
***/

/*{{{*/
.dp-highlighter
{
	font-family: &quot;Consolas&quot;, &quot;Courier New&quot;, Courier, mono, serif;
	font-size: 12px;
	background-color: #E7E5DC;
	width: 99%;
	overflow: auto;
	margin: 18px 0 18px 0 !important;
	padding-top: 1px; /* adds a little border on top when controls are hidden */
}

/* clear styles */
.dp-highlighter ol,
.dp-highlighter ol li,
.dp-highlighter ol li span 
{
	margin: 0;
	padding: 0;
	border: none;
}

.dp-highlighter a,
.dp-highlighter a:hover
{
	background: none;
	border: none;
	padding: 0;
	margin: 0;
}

.dp-highlighter .bar
{
	padding-left: 45px;
}

.dp-highlighter.collapsed .bar,
.dp-highlighter.nogutter .bar
{
	padding-left: 0px;
}

.dp-highlighter ol
{
	list-style: decimal; /* for ie */
	background-color: #fff;
	margin: 0px 0px 1px 45px !important; /* 1px bottom margin seems to fix occasional Firefox scrolling */
	padding: 0px;
	color: #5C5C5C;
}

.dp-highlighter.nogutter ol,
.dp-highlighter.nogutter ol li
{
	list-style: none !important;
	margin-left: 0px !important;
}

.dp-highlighter ol li,
.dp-highlighter .columns div
{
	list-style: decimal-leading-zero; /* better look for others, override cascade from OL */
	list-style-position: outside !important;
	border-left: 3px solid #6CE26C;
	background-color: #F8F8F8;
	color: #5C5C5C;
	padding: 0 3px 0 10px !important;
	margin: 0 !important;
	line-height: 14px;
}

.dp-highlighter.nogutter ol li,
.dp-highlighter.nogutter .columns div
{
	border: 0;
}

.dp-highlighter .columns
{
	background-color: #F8F8F8;
	color: gray;
	overflow: hidden;
	width: 100%;
}

.dp-highlighter .columns div
{
	padding-bottom: 5px;
}

.dp-highlighter ol li.alt
{
	background-color: #FFF;
	color: inherit;
}

.dp-highlighter ol li span
{
	color: black;
	background-color: inherit;
}

/* Adjust some properties when collapsed */

.dp-highlighter.collapsed ol
{
	margin: 0px;
}

.dp-highlighter.collapsed ol li
{
	display: none;
}

/* Additional modifications when in print-view */

.dp-highlighter.printing
{
	border: none;
}

.dp-highlighter.printing .tools
{
	display: none !important;
}

.dp-highlighter.printing li
{
	display: list-item !important;
}

/* Styles for the tools */

.dp-highlighter .tools
{
	padding: 3px 8px 3px 10px;
	font: 9px Verdana, Geneva, Arial, Helvetica, sans-serif;
	color: silver;
	background-color: #f8f8f8;
	padding-bottom: 10px;
	border-left: 3px solid #6CE26C;
}

.dp-highlighter.nogutter .tools
{
	border-left: 0;
}

.dp-highlighter.collapsed .tools
{
	border-bottom: 0;
}

.dp-highlighter .tools a
{
	font-size: 9px;
	color: #a0a0a0;
	background-color: inherit;
	text-decoration: none;
	margin-right: 10px;
}

.dp-highlighter .tools a:hover
{
	color: red;
	background-color: inherit;
	text-decoration: underline;
}

/* About dialog styles */

.dp-about { background-color: #fff; color: #333; margin: 0px; padding: 0px; }
.dp-about table { width: 100%; height: 100%; font-size: 11px; font-family: Tahoma, Verdana, Arial, sans-serif !important; }
.dp-about td { padding: 10px; vertical-align: top; }
.dp-about .copy { border-bottom: 1px solid #ACA899; height: 95%; }
.dp-about .title { color: red; background-color: inherit; font-weight: bold; }
.dp-about .para { margin: 0 0 4px 0; }
.dp-about .footer { background-color: #ECEADB; color: #333; border-top: 1px solid #fff; text-align: right; }
.dp-about .close { font-size: 11px; font-family: Tahoma, Verdana, Arial, sans-serif !important; background-color: #ECEADB; color: #333; width: 60px; height: 22px; }

/* Language specific styles */

.dp-highlighter .comment, .dp-highlighter .comments { color: #808080; background-color: inherit; }
.dp-highlighter .string { color: blue; background-color: inherit; }
.dp-highlighter .keyword { color: navy; font-weight: bold; background-color: inherit; }
.dp-highlighter .preprocessor { color: green; background-color: inherit; }

/*}}}*/</pre>
</div>
<div title="SyntaxHighlighterPlugin" modifier="Mingos" created="200904132309" modified="201007252138" tags="systemConfig" server.type="file" server.host="dl.getdropbox.com/u/52078/Notes/Notes.html" server.page.revision="200904132309" changecount="2">
<pre>/***
!Metadata:
|''Name:''|SyntaxHighlighterPlugin|
|''Description:''|Code Syntax Highlighter Plugin for TiddlyWiki.|
|''Version:''|1.1.3|
|''Date:''|Oct 24, 2008|
|''Source:''|http://www.coolcode.cn/show-310-1.html|
|''Author:''|Ma Bingyao (andot (at) ujn (dot) edu (dot) cn)|
|''License:''|[[GNU Lesser General Public License|http://www.gnu.org/licenses/lgpl.txt]]|
|''~CoreVersion:''|2.4.1|
|''Browser:''|Firefox 1.5+; InternetExplorer 6.0; Safari; Opera; Chrome; etc.|

!Syntax:
{{{
&lt;code options&gt;
codes
&lt;/code&gt;
}}}

!Examples:
{{{
&lt;code java&gt;
public class HelloWorld {
    public static void main(String args[]) {
        System.out.println(&quot;HelloWorld!&quot;);
    }
}
&lt;/code&gt;
}}}

!Revision History:
|''Version''|''Date''|''Note''|
|1.1.2|Oct 15, 2008|Optimize Highlight|
|1.0.0|Oct 13, 2008|Initial release|

!Code section:
***/
//{{{
var dp={sh:{Toolbar:{},Utils:{},RegexLib:{},Brushes:{},Strings:{AboutDialog:&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;About...&lt;/title&gt;&lt;/head&gt;&lt;body class=\&quot;dp-about\&quot;&gt;&lt;table cellspacing=\&quot;0\&quot;&gt;&lt;tr&gt;&lt;td class=\&quot;copy\&quot;&gt;&lt;p class=\&quot;title\&quot;&gt;dp.SyntaxHighlighter&lt;/div&gt;&lt;div class=\&quot;para\&quot;&gt;Version: {V}&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;http://www.dreamprojections.com/syntaxhighlighter/?ref=about\&quot; target=\&quot;_blank\&quot;&gt;http://www.dreamprojections.com/syntaxhighlighter&lt;/a&gt;&lt;/p&gt;&amp;copy;2004-2007 Alex Gorbatchev.&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=\&quot;footer\&quot;&gt;&lt;input type=\&quot;button\&quot; class=\&quot;close\&quot; value=\&quot;OK\&quot; onClick=\&quot;window.close()\&quot;/&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;&quot;},ClipboardSwf:null,Version:&quot;1.5.1&quot;}};dp.SyntaxHighlighter=dp.sh;dp.sh.Toolbar.Commands={ExpandSource:{label:&quot;+ expand source&quot;,check:function($){return $.collapse},func:function($,_){$.parentNode.removeChild($);_.div.className=_.div.className.replace(&quot;collapsed&quot;,&quot;&quot;)}},ViewSource:{label:&quot;view plain&quot;,func:function($,_){var A=dp.sh.Utils.FixForBlogger(_.originalCode).replace(/&lt;/g,&quot;&amp;lt;&quot;),B=window.open(&quot;&quot;,&quot;_blank&quot;,&quot;width=750, height=400, location=0, resizable=1, menubar=0, scrollbars=0&quot;);B.document.write(&quot;&lt;textarea style=\&quot;width:99%;height:99%\&quot;&gt;&quot;+A+&quot;&lt;/textarea&gt;&quot;);B.document.close()}},CopyToClipboard:{label:&quot;copy to clipboard&quot;,check:function(){return window.clipboardData!=null||dp.sh.ClipboardSwf!=null},func:function($,A){var B=dp.sh.Utils.FixForBlogger(A.originalCode).replace(/&amp;lt;/g,&quot;&lt;&quot;).replace(/&amp;gt;/g,&quot;&gt;&quot;).replace(/&amp;amp;/g,&quot;&amp;&quot;);if(window.clipboardData)window.clipboardData.setData(&quot;text&quot;,B);else if(dp.sh.ClipboardSwf!=null){var _=A.flashCopier;if(_==null){_=document.createElement(&quot;div&quot;);A.flashCopier=_;A.div.appendChild(_)}_.innerHTML=&quot;&lt;embed src=\&quot;&quot;+dp.sh.ClipboardSwf+&quot;\&quot; FlashVars=\&quot;clipboard=&quot;+encodeURIComponent(B)+&quot;\&quot; width=\&quot;0\&quot; height=\&quot;0\&quot; type=\&quot;application/x-shockwave-flash\&quot;&gt;&lt;/embed&gt;&quot;}alert(&quot;The code is in your clipboard now&quot;)}},PrintSource:{label:&quot;print&quot;,func:function($,B){var _=document.createElement(&quot;IFRAME&quot;),A=null;_.style.cssText=&quot;position:absolute;width:0px;height:0px;left:-500px;top:-500px;&quot;;document.body.appendChild(_);A=_.contentWindow.document;dp.sh.Utils.CopyStyles(A,window.document);A.write(&quot;&lt;div class=\&quot;&quot;+B.div.className.replace(&quot;collapsed&quot;,&quot;&quot;)+&quot; printing\&quot;&gt;&quot;+B.div.innerHTML+&quot;&lt;/div&gt;&quot;);A.close();_.contentWindow.focus();_.contentWindow.print();alert(&quot;Printing...&quot;);document.body.removeChild(_)}},About:{label:&quot;?&quot;,func:function(_){var A=window.open(&quot;&quot;,&quot;_blank&quot;,&quot;dialog,width=300,height=150,scrollbars=0&quot;),$=A.document;dp.sh.Utils.CopyStyles($,window.document);$.write(dp.sh.Strings.AboutDialog.replace(&quot;{V}&quot;,dp.sh.Version));$.close();A.focus()}}};dp.sh.Toolbar.Create=function(B){var A=document.createElement(&quot;DIV&quot;);A.className=&quot;tools&quot;;for(var _ in dp.sh.Toolbar.Commands){var $=dp.sh.Toolbar.Commands[_];if($.check!=null&amp;&amp;!$.check(B))continue;A.innerHTML+=&quot;&lt;a href=\&quot;#\&quot; onclick=\&quot;dp.sh.Toolbar.Command('&quot;+_+&quot;',this);return false;\&quot;&gt;&quot;+$.label+&quot;&lt;/a&gt;&quot;}return A};dp.sh.Toolbar.Command=function(_,$){var A=$;while(A!=null&amp;&amp;A.className.indexOf(&quot;dp-highlighter&quot;)==-1)A=A.parentNode;if(A!=null)dp.sh.Toolbar.Commands[_].func($,A.highlighter)};dp.sh.Utils.CopyStyles=function(A,_){var $=_.getElementsByTagName(&quot;link&quot;);for(var B=0;B&lt;$.length;B++)if($[B].rel.toLowerCase()==&quot;stylesheet&quot;)A.write(&quot;&lt;link type=\&quot;text/css\&quot; rel=\&quot;stylesheet\&quot; href=\&quot;&quot;+$[B].href+&quot;\&quot;&gt;&lt;/link&gt;&quot;)};dp.sh.Utils.FixForBlogger=function($){return(dp.sh.isBloggerMode==true)?$.replace(/&lt;br\s*\/?&gt;|&amp;lt;br\s*\/?&amp;gt;/gi,&quot;\n&quot;):$};dp.sh.RegexLib={MultiLineCComments:new RegExp(&quot;/\\*[\\s\\S]*?\\*/&quot;,&quot;gm&quot;),SingleLineCComments:new RegExp(&quot;//.*$&quot;,&quot;gm&quot;),SingleLinePerlComments:new RegExp(&quot;#.*$&quot;,&quot;gm&quot;),DoubleQuotedString:new RegExp(&quot;\&quot;(?:\\.|(\\\\\\\&quot;)|[^\\\&quot;\&quot;\\n])*\&quot;&quot;,&quot;g&quot;),SingleQuotedString:new RegExp(&quot;'(?:\\.|(\\\\\\')|[^\\''\\n])*'&quot;,&quot;g&quot;)};dp.sh.Match=function(_,$,A){this.value=_;this.index=$;this.length=_.length;this.css=A};dp.sh.Highlighter=function(){this.noGutter=false;this.addControls=true;this.collapse=false;this.tabsToSpaces=true;this.wrapColumn=80;this.showColumns=true};dp.sh.Highlighter.SortCallback=function($,_){if($.index&lt;_.index)return-1;else if($.index&gt;_.index)return 1;else if($.length&lt;_.length)return-1;else if($.length&gt;_.length)return 1;return 0};dp.sh.Highlighter.prototype.CreateElement=function(_){var $=document.createElement(_);$.highlighter=this;return $};dp.sh.Highlighter.prototype.GetMatches=function(_,B){var $=0,A=null;while((A=_.exec(this.code))!=null)this.matches[this.matches.length]=new dp.sh.Match(A[0],A.index,B)};dp.sh.Highlighter.prototype.AddBit=function($,A){if($==null||$.length==0)return;var C=this.CreateElement(&quot;SPAN&quot;);$=$.replace(/ /g,&quot;&amp;nbsp;&quot;);$=$.replace(/&lt;/g,&quot;&amp;lt;&quot;);$=$.replace(/\n/gm,&quot;&amp;nbsp;&lt;br&gt;&quot;);if(A!=null){if((/br/gi).test($)){var _=$.split(&quot;&amp;nbsp;&lt;br&gt;&quot;);for(var B=0;B&lt;_.length;B++){C=this.CreateElement(&quot;SPAN&quot;);C.className=A;C.innerHTML=_[B];this.div.appendChild(C);if(B+1&lt;_.length)this.div.appendChild(this.CreateElement(&quot;BR&quot;))}}else{C.className=A;C.innerHTML=$;this.div.appendChild(C)}}else{C.innerHTML=$;this.div.appendChild(C)}};dp.sh.Highlighter.prototype.IsInside=function(_){if(_==null||_.length==0)return false;for(var A=0;A&lt;this.matches.length;A++){var $=this.matches[A];if($==null)continue;if((_.index&gt;$.index)&amp;&amp;(_.index&lt;$.index+$.length))return true}return false};dp.sh.Highlighter.prototype.ProcessRegexList=function(){for(var $=0;$&lt;this.regexList.length;$++)this.GetMatches(this.regexList[$].regex,this.regexList[$].css)};dp.sh.Highlighter.prototype.ProcessSmartTabs=function(E){var B=E.split(&quot;\n&quot;),$=&quot;&quot;,D=4,A=&quot;\t&quot;;function _(A,E,_){var B=A.substr(0,E),C=A.substr(E+1,A.length),$=&quot;&quot;;for(var D=0;D&lt;_;D++)$+=&quot; &quot;;return B+$+C}function C(B,C){if(B.indexOf(A)==-1)return B;var D=0;while((D=B.indexOf(A))!=-1){var $=C-D%C;B=_(B,D,$)}return B}for(var F=0;F&lt;B.length;F++)$+=C(B[F],D)+&quot;\n&quot;;return $};dp.sh.Highlighter.prototype.SwitchToList=function(){var C=this.div.innerHTML.replace(/&lt;(br)\/?&gt;/gi,&quot;\n&quot;),B=C.split(&quot;\n&quot;);if(this.addControls==true)this.bar.appendChild(dp.sh.Toolbar.Create(this));if(this.showColumns){var A=this.CreateElement(&quot;div&quot;),_=this.CreateElement(&quot;div&quot;),E=10,G=1;while(G&lt;=150)if(G%E==0){A.innerHTML+=G;G+=(G+&quot;&quot;).length}else{A.innerHTML+=&quot;&amp;middot;&quot;;G++}_.className=&quot;columns&quot;;_.appendChild(A);this.bar.appendChild(_)}for(var G=0,D=this.firstLine;G&lt;B.length-1;G++,D++){var $=this.CreateElement(&quot;LI&quot;),F=this.CreateElement(&quot;SPAN&quot;);$.className=(G%2==0)?&quot;alt&quot;:&quot;&quot;;F.innerHTML=B[G]+&quot;&amp;nbsp;&quot;;$.appendChild(F);this.ol.appendChild($)}this.div.innerHTML=&quot;&quot;};dp.sh.Highlighter.prototype.Highlight=function(C){function A($){return $.replace(/^\s*(.*?)[\s\n]*$/g,&quot;$1&quot;)}function $($){return $.replace(/\n*$/,&quot;&quot;).replace(/^\n*/,&quot;&quot;)}function _(B){var E=dp.sh.Utils.FixForBlogger(B).split(&quot;\n&quot;),C=new Array(),D=new RegExp(&quot;^\\s*&quot;,&quot;g&quot;),$=1000;for(var F=0;F&lt;E.length&amp;&amp;$&gt;0;F++){if(A(E[F]).length==0)continue;var _=D.exec(E[F]);if(_!=null&amp;&amp;_.length&gt;0)$=Math.min(_[0].length,$)}if($&gt;0)for(F=0;F&lt;E.length;F++)E[F]=E[F].substr($);return E.join(&quot;\n&quot;)}function D(A,$,_){return A.substr($,_-$)}var F=0;if(C==null)C=&quot;&quot;;this.originalCode=C;this.code=$(_(C));this.div=this.CreateElement(&quot;DIV&quot;);this.bar=this.CreateElement(&quot;DIV&quot;);this.ol=this.CreateElement(&quot;OL&quot;);this.matches=new Array();this.div.className=&quot;dp-highlighter&quot;;this.div.highlighter=this;this.bar.className=&quot;bar&quot;;this.ol.start=this.firstLine;if(this.CssClass!=null)this.ol.className=this.CssClass;if(this.collapse)this.div.className+=&quot; collapsed&quot;;if(this.noGutter)this.div.className+=&quot; nogutter&quot;;if(this.tabsToSpaces==true)this.code=this.ProcessSmartTabs(this.code);this.ProcessRegexList();if(this.matches.length==0){this.AddBit(this.code,null);this.SwitchToList();this.div.appendChild(this.bar);this.div.appendChild(this.ol);return}this.matches=this.matches.sort(dp.sh.Highlighter.SortCallback);for(var E=0;E&lt;this.matches.length;E++)if(this.IsInside(this.matches[E]))this.matches[E]=null;for(E=0;E&lt;this.matches.length;E++){var B=this.matches[E];if(B==null||B.length==0)continue;this.AddBit(D(this.code,F,B.index),null);this.AddBit(B.value,B.css);F=B.index+B.length}this.AddBit(this.code.substr(F),null);this.SwitchToList();this.div.appendChild(this.bar);this.div.appendChild(this.ol)};dp.sh.Highlighter.prototype.GetKeywords=function($){return&quot;\\b&quot;+$.replace(/ /g,&quot;\\b|\\b&quot;)+&quot;\\b&quot;};dp.sh.BloggerMode=function(){dp.sh.isBloggerMode=true};dp.sh.HighlightAll=function(N,B,K,I,O,E){function A(){var $=arguments;for(var _=0;_&lt;$.length;_++){if($[_]==null)continue;if(typeof($[_])==&quot;string&quot;&amp;&amp;$[_]!=&quot;&quot;)return $[_]+&quot;&quot;;if(typeof($[_])==&quot;object&quot;&amp;&amp;$[_].value!=&quot;&quot;)return $[_].value+&quot;&quot;}return null}function J($,_){for(var A=0;A&lt;_.length;A++)if(_[A]==$)return true;return false}function L(A,B,C){var _=new RegExp(&quot;^&quot;+A+&quot;\\[(\\w+)\\]$&quot;,&quot;gi&quot;),$=null;for(var D=0;D&lt;B.length;D++)if(($=_.exec(B[D]))!=null)return $[1];return C}function C(B,A,_){var $=document.getElementsByTagName(_);for(var C=0;C&lt;$.length;C++)if($[C].getAttribute(&quot;name&quot;)==A)B.push($[C])}var T=[],P=null,M={},$=&quot;innerHTML&quot;;C(T,N,&quot;pre&quot;);C(T,N,&quot;textarea&quot;);if(T.length==0)return;for(var R in dp.sh.Brushes){var F=dp.sh.Brushes[R].Aliases;if(F==null)continue;for(var G=0;G&lt;F.length;G++)M[F[G]]=R}for(G=0;G&lt;T.length;G++){var _=T[G],U=A(_.attributes[&quot;class&quot;],_.className,_.attributes[&quot;language&quot;],_.language),Q=&quot;&quot;;if(U==null)continue;U=U.split(&quot;:&quot;);Q=U[0].toLowerCase();if(M[Q]==null)continue;P=new dp.sh.Brushes[M[Q]]();_.style.display=&quot;none&quot;;P.noGutter=(B==null)?J(&quot;nogutter&quot;,U):!B;P.addControls=(K==null)?!J(&quot;nocontrols&quot;,U):K;P.collapse=(I==null)?J(&quot;collapse&quot;,U):I;P.showColumns=(E==null)?J(&quot;showcolumns&quot;,U):E;var D=document.getElementsByTagName(&quot;head&quot;)[0];if(P.Style&amp;&amp;D){var S=document.createElement(&quot;style&quot;);S.setAttribute(&quot;type&quot;,&quot;text/css&quot;);if(S.styleSheet)S.styleSheet.cssText=P.Style;else{var H=document.createTextNode(P.Style);S.appendChild(H)}D.appendChild(S)}P.firstLine=(O==null)?parseInt(L(&quot;firstline&quot;,U,1)):O;P.Highlight(_[$]);P.source=_;_.parentNode.insertBefore(P.div,_)}};version.extensions.SyntaxHighLighterPlugin={major:1,minor:1,revision:3,date:new Date(2008,10,24)};dp.sh.ClipboardSwf=&quot;clipboard.swf&quot;;dp.sh.Highlight=function(_,Q,B,J,H,M,D){function A(){var $=arguments;for(var _=0;_&lt;$.length;_++){if($[_]==null)continue;if(typeof($[_])==&quot;string&quot;&amp;&amp;$[_]!=&quot;&quot;)return $[_]+&quot;&quot;;if(typeof($[_])==&quot;object&quot;&amp;&amp;$[_].value!=&quot;&quot;)return $[_].value+&quot;&quot;}return null}function I($,_){for(var A=0;A&lt;_.length;A++)if(_[A]==$)return true;return false}function K(A,B,C){var _=new RegExp(&quot;^&quot;+A+&quot;\\[(\\w+)\\]$&quot;,&quot;gi&quot;),$=null;for(var D=0;D&lt;B.length;D++)if(($=_.exec(B[D]))!=null)return $[1];return C}var N=null,$=&quot;innerHTML&quot;;if(this.registered==undefined){var L={};for(var O in dp.sh.Brushes){var E=dp.sh.Brushes[O].Aliases;if(E==null)continue;for(var F=0;F&lt;E.length;F++)L[E[F]]=O}this.registered=L}Q=Q.split(&quot;:&quot;);language=Q[0].toLowerCase();if(this.registered[language]==null)return;N=new dp.sh.Brushes[this.registered[language]]();_.style.display=&quot;none&quot;;N.noGutter=(B==null)?I(&quot;nogutter&quot;,Q):!B;N.addControls=(J==null)?!I(&quot;nocontrols&quot;,Q):J;N.collapse=(H==null)?I(&quot;collapse&quot;,Q):H;N.showColumns=(D==null)?I(&quot;showcolumns&quot;,Q):D;var C=document.getElementsByTagName(&quot;head&quot;)[0],P=document.getElementById(N.CssClass);if(N.Style&amp;&amp;C&amp;&amp;!P){P=document.createElement(&quot;style&quot;);P.setAttribute(&quot;id&quot;,N.CssClass);P.setAttribute(&quot;type&quot;,&quot;text/css&quot;);if(P.styleSheet)P.styleSheet.cssText=N.Style;else{var G=document.createTextNode(N.Style);P.appendChild(G)}C.appendChild(P)}N.firstLine=(M==null)?parseInt(K(&quot;firstline&quot;,Q,1)):M;N.Highlight(_[$]);N.source=_;_.parentNode.insertBefore(N.div,_)};config.formatters.push({name:&quot;SyntaxHighlighter&quot;,match:&quot;^&lt;code[\\s]+[^&gt;]+&gt;\\n&quot;,element:&quot;pre&quot;,handler:function(_){this.lookaheadRegExp=/&lt;code[\s]+([^&gt;]+)&gt;\n((?:^[^\n]*\n)+?)(^&lt;\/code&gt;$\n?)/mg;this.lookaheadRegExp.lastIndex=_.matchStart;var $=this.lookaheadRegExp.exec(_.source);if($&amp;&amp;$.index==_.matchStart){var C=$[1],B=$[2];if(config.browser.isIE)B=B.replace(/\n/g,&quot;\r&quot;);var A=createTiddlyElement(_.output,this.element,null,null,B);dp.sh.Highlight(A,C);_.nextMatch=$.index+$[0].length}}});config.formatterHelpers.enclosedTextHelper=function(_){this.lookaheadRegExp.lastIndex=_.matchStart;var $=this.lookaheadRegExp.exec(_.source);if($&amp;&amp;$.index==_.matchStart){var B=$[1];if(config.browser.isIE)B=B.replace(/\n/g,&quot;\r&quot;);var A=createTiddlyElement(_.output,this.element,null,null,B);switch(_.matchText){case&quot;/*{{{*/\n&quot;:dp.sh.Highlight(A,&quot;css&quot;);break;case&quot;//{{{\n&quot;:dp.sh.Highlight(A,&quot;js&quot;);break;case&quot;&lt;!--{{{--&gt;\n&quot;:dp.sh.Highlight(A,&quot;xml&quot;);break}_.nextMatch=$.index+$[0].length}};dp.sh.Brushes.AS3=function(){var _=&quot;class interface package&quot;,$=&quot;Array Boolean Date decodeURI decodeURIComponent encodeURI encodeURIComponent escape &quot;+&quot;int isFinite isNaN isXMLName Number Object parseFloat parseInt &quot;+&quot;String trace uint unescape XML XMLList &quot;+&quot;Infinity -Infinity NaN undefined &quot;+&quot;as delete instanceof is new typeof &quot;+&quot;break case catch continue default do each else finally for if in &quot;+&quot;label return super switch throw try while with &quot;+&quot;dynamic final internal native override private protected public static &quot;+&quot;...rest const extends function get implements namespace set &quot;+&quot;import include use &quot;+&quot;AS3 flash_proxy object_proxy &quot;+&quot;false null this true &quot;+&quot;void Null&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;blockcomment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^\\s*#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;definition&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(&quot;var&quot;,&quot;gm&quot;),css:&quot;variable&quot;}];this.CssClass=&quot;dp-as&quot;;this.Style=&quot;.dp-as .comment { color: #009900; font-style: italic; }&quot;+&quot;.dp-as .blockcomment { color: #3f5fbf; }&quot;+&quot;.dp-as .string { color: #990000; }&quot;+&quot;.dp-as .preprocessor { color: #0033ff; }&quot;+&quot;.dp-as .definition { color: #9900cc; font-weight: bold; }&quot;+&quot;.dp-as .keyword { color: #0033ff; }&quot;+&quot;.dp-as .variable { color: #6699cc; font-weight: bold; }&quot;};dp.sh.Brushes.AS3.prototype=new dp.sh.Highlighter();dp.sh.Brushes.AS3.Aliases=[&quot;as&quot;,&quot;actionscript&quot;,&quot;ActionScript&quot;,&quot;as3&quot;,&quot;AS3&quot;];dp.sh.Brushes.Bash=function(){var _=&quot;alias bg bind break builtin cd command compgen complete continue &quot;+&quot;declare dirs disown echo enable eval exec exit export fc fg &quot;+&quot;getopts hash help history jobs kill let local logout popd printf &quot;+&quot;pushd pwd read readonly return set shift shopt source &quot;+&quot;suspend test times trap type typeset ulimit umask unalias unset wait&quot;,$=&quot;case do done elif else esac fi for function if in select then &quot;+&quot;time until while&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLinePerlComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;[()[\\]{}]&quot;,&quot;g&quot;),css:&quot;delim&quot;},{regex:new RegExp(&quot;\\$\\w+&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(&quot;\\w+=&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(&quot;\\s-\\w+&quot;,&quot;g&quot;),css:&quot;flag&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;builtin&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-bash&quot;;this.Style=&quot;.dp-bash .builtin {color: maroon; font-weight: bold;}&quot;+&quot;.dp-bash .comment {color: gray;}&quot;+&quot;.dp-bash .delim {font-weight: bold;}&quot;+&quot;.dp-bash .flag {color: green;}&quot;+&quot;.dp-bash .string {color: red;}&quot;+&quot;.dp-bash .vars {color: blue;}&quot;};dp.sh.Brushes.Bash.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Bash.Aliases=[&quot;bash&quot;,&quot;sh&quot;];dp.sh.Brushes.Batch=function(){var _=&quot;APPEND ATTRIB CD CHDIR CHKDSK CHOICE CLS COPY DEL ERASE DELTREE &quot;+&quot;DIR EXIT FC COMP FDISK FIND FORMAT FSUTIL HELP JOIN &quot;+&quot;LABEL LOADFIX MK MKDIR MEM MEMMAKER MORE MOVE MSD PCPARK &quot;+&quot;PRINT RD RMDIR REN SCANDISK SHARE SORT SUBST SYS &quot;+&quot;TIME DATE TREE TRUENAME TYPE UNDELETE VER XCOPY&quot;,$=&quot;DO ELSE FOR IN CALL CHOICE GOTO SHIFT PAUSE ERRORLEVEL &quot;+&quot;IF NOT EXIST LFNFOR START SETLOCAL ENDLOCAL ECHO SET&quot;;this.regexList=[{regex:new RegExp(&quot;REM.*$&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:new RegExp(&quot;::.*$&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;[()[\\]{}]&quot;,&quot;g&quot;),css:&quot;delim&quot;},{regex:new RegExp(&quot;%\\w+%&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(&quot;%%\\w+&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(&quot;\\w+=&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(&quot;@\\w+&quot;,&quot;g&quot;),css:&quot;keyword&quot;},{regex:new RegExp(&quot;:\\w+&quot;,&quot;g&quot;),css:&quot;keyword&quot;},{regex:new RegExp(&quot;\\s/\\w+&quot;,&quot;g&quot;),css:&quot;flag&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;builtin&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-batch&quot;;this.Style=&quot;.dp-batch .builtin {color: maroon; font-weight: bold;}&quot;+&quot;.dp-batch .comment {color: gray;}&quot;+&quot;.dp-batch .delim {font-weight: bold;}&quot;+&quot;.dp-batch .flag {color: green;}&quot;+&quot;.dp-batch .string {color: red;}&quot;+&quot;.dp-batch .vars {color: blue;font-weight: bold;}&quot;};dp.sh.Brushes.Batch.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Batch.Aliases=[&quot;batch&quot;,&quot;dos&quot;];dp.sh.Brushes.ColdFusion=function(){this.CssClass=&quot;dp-coldfusion&quot;;this.Style=&quot;.dp-coldfusion { font: 13px \&quot;Courier New\&quot;, Courier, monospace; }&quot;+&quot;.dp-coldfusion .tag, .dp-coldfusion .tag-name { color: #990033; }&quot;+&quot;.dp-coldfusion .attribute { color: #990033; }&quot;+&quot;.dp-coldfusion .attribute-value { color: #0000FF; }&quot;+&quot;.dp-coldfusion .cfcomments { background-color: #FFFF99; color: #000000; }&quot;+&quot;.dp-coldfusion .cfscriptcomments { color: #999999; }&quot;+&quot;.dp-coldfusion .keywords { color: #0000FF; }&quot;+&quot;.dp-coldfusion .mgkeywords { color: #CC9900; }&quot;+&quot;.dp-coldfusion .numbers { color: #ff0000; }&quot;+&quot;.dp-coldfusion .strings { color: green; }&quot;;this.mgKeywords=&quot;setvalue getvalue addresult viewcollection viewstate&quot;;this.keywords=&quot;var eq neq gt gte lt lte not and or true false &quot;+&quot;abs acos addsoaprequestheader addsoapresponseheader &quot;+&quot;arrayappend arrayavg arrayclear arraydeleteat arrayinsertat &quot;+&quot;arrayisempty arraylen arraymax arraymin arraynew &quot;+&quot;arrayprepend arrayresize arrayset arraysort arraysum &quot;+&quot;arrayswap arraytolist asc asin atn binarydecode binaryencode &quot;+&quot;bitand bitmaskclear bitmaskread bitmaskset bitnot bitor bitshln &quot;+&quot;bitshrn bitxor ceiling charsetdecode charsetencode chr cjustify &quot;+&quot;compare comparenocase cos createdate createdatetime createobject &quot;+&quot;createobject createobject createobject createobject createodbcdate &quot;+&quot;createodbcdatetime createodbctime createtime createtimespan &quot;+&quot;createuuid dateadd datecompare dateconvert datediff dateformat &quot;+&quot;datepart day dayofweek dayofweekasstring dayofyear daysinmonth &quot;+&quot;daysinyear de decimalformat decrementvalue decrypt decryptbinary &quot;+&quot;deleteclientvariable directoryexists dollarformat duplicate encrypt &quot;+&quot;encryptbinary evaluate exp expandpath fileexists find findnocase &quot;+&quot;findoneof firstdayofmonth fix formatbasen generatesecretkey &quot;+&quot;getauthuser getbasetagdata getbasetaglist getbasetemplatepath &quot;+&quot;getclientvariableslist getcontextroot getcurrenttemplatepath &quot;+&quot;getdirectoryfrompath getencoding getexception getfilefrompath &quot;+&quot;getfunctionlist getgatewayhelper gethttprequestdata gethttptimestring &quot;+&quot;getk2serverdoccount getk2serverdoccountlimit getlocale &quot;+&quot;getlocaledisplayname getlocalhostip getmetadata getmetricdata &quot;+&quot;getpagecontext getprofilesections getprofilestring getsoaprequest &quot;+&quot;getsoaprequestheader getsoapresponse getsoapresponseheader &quot;+&quot;gettempdirectory gettempfile gettemplatepath gettickcount &quot;+&quot;gettimezoneinfo gettoken hash hour htmlcodeformat htmleditformat &quot;+&quot;iif incrementvalue inputbasen insert int isarray isbinary isboolean &quot;+&quot;iscustomfunction isdate isdebugmode isdefined isk2serverabroker &quot;+&quot;isk2serverdoccountexceeded isk2serveronline isleapyear islocalhost &quot;+&quot;isnumeric isnumericdate isobject isquery issimplevalue issoaprequest &quot;+&quot;isstruct isuserinrole isvalid isvalid isvalid iswddx isxml &quot;+&quot;isxmlattribute isxmldoc isxmlelem isxmlnode isxmlroot javacast &quot;+&quot;jsstringformat lcase left len listappend listchangedelims listcontains &quot;+&quot;listcontainsnocase listdeleteat listfind listfindnocase listfirst &quot;+&quot;listgetat listinsertat listlast listlen listprepend listqualify &quot;+&quot;listrest listsetat listsort listtoarray listvaluecount &quot;+&quot;listvaluecountnocase ljustify log log10 lscurrencyformat lsdateformat &quot;+&quot;lseurocurrencyformat lsiscurrency lsisdate lsisnumeric lsnumberformat &quot;+&quot;lsparsecurrency lsparsedatetime lsparseeurocurrency lsparsenumber &quot;+&quot;lstimeformat ltrim max mid min minute month monthasstring now &quot;+&quot;numberformat paragraphformat parameterexists parsedatetime pi &quot;+&quot;preservesinglequotes quarter queryaddcolumn queryaddrow querynew &quot;+&quot;querysetcell quotedvaluelist rand randomize randrange refind &quot;+&quot;refindnocase releasecomobject removechars repeatstring replace &quot;+&quot;replacelist replacenocase rereplace rereplacenocase reverse right &quot;+&quot;rjustify round rtrim second sendgatewaymessage setencoding &quot;+&quot;setlocale setprofilestring setvariable sgn sin spanexcluding &quot;+&quot;spanincluding sqr stripcr structappend structclear structcopy &quot;+&quot;structcount structdelete structfind structfindkey structfindvalue &quot;+&quot;structget structinsert structisempty structkeyarray structkeyexists &quot;+&quot;structkeylist structnew structsort structupdate tan timeformat &quot;+&quot;tobase64 tobinary toscript tostring trim ucase urldecode urlencodedformat &quot;+&quot;urlsessionformat val valuelist week wrap writeoutput xmlchildpos &quot;+&quot;xmlelemnew xmlformat xmlgetnodetype xmlnew xmlparse xmlsearch xmltransform &quot;+&quot;xmlvalidate year yesnoformat&quot;;this.stringMatches=new Array();this.attributeMatches=new Array()};dp.sh.Brushes.ColdFusion.prototype=new dp.sh.Highlighter();dp.sh.Brushes.ColdFusion.Aliases=[&quot;coldfusion&quot;,&quot;cf&quot;];dp.sh.Brushes.ColdFusion.prototype.ProcessRegexList=function(){function B(_,$){_[_.length]=$}function A(A,$){for(var _=0;_&lt;A.length;_++)if(A[_]==$)return _;return-1}var _=null,$=null;this.GetMatches(new RegExp(&quot;\\b(\\d+)&quot;,&quot;gm&quot;),&quot;numbers&quot;);this.GetMatches(new RegExp(this.GetKeywords(this.mgKeywords),&quot;igm&quot;),&quot;mgkeywords&quot;);this.GetMatches(dp.sh.RegexLib.SingleLineCComments,&quot;cfscriptcomments&quot;);this.GetMatches(dp.sh.RegexLib.MultiLineCComments,&quot;cfscriptcomments&quot;);this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)!---[\\s\\S]*?---(&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;cfcomments&quot;);$=new RegExp(&quot;(cfset\\s*)?([:\\w-.]+)\\s*=\\s*(\&quot;.*?\&quot;|'.*?')*&quot;,&quot;gm&quot;);while((_=$.exec(this.code))!=null){if(_[1]!=undefined&amp;&amp;_[1]!=&quot;&quot;)continue;if(_[3]!=undefined&amp;&amp;_[3]!=&quot;&quot;&amp;&amp;_[3]!=&quot;\&quot;\&quot;&quot;&amp;&amp;_[3]!=&quot;''&quot;){B(this.matches,new dp.sh.Match(_[2],_.index,&quot;attribute&quot;));B(this.matches,new dp.sh.Match(_[3],_.index+_[0].indexOf(_[3]),&quot;attribute-value&quot;));B(this.stringMatches,_[3]);B(this.attributeMatches,_[2])}}this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)/*\\?*(?!\\!)|/*\\?*(&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;tag&quot;);$=new RegExp(&quot;(?:&amp;lt;|&lt;)/*\\?*\\s*([:\\w-.]+)&quot;,&quot;gm&quot;);while((_=$.exec(this.code))!=null)B(this.matches,new dp.sh.Match(_[1],_.index+_[0].indexOf(_[1]),&quot;tag-name&quot;));$=new RegExp(this.GetKeywords(this.keywords),&quot;igm&quot;);while((_=$.exec(this.code))!=null)if(A(this.attributeMatches,_[0])==-1)B(this.matches,new dp.sh.Match(_[0],_.index,&quot;keywords&quot;));$=new RegExp(&quot;cfset\\s*.*(\&quot;.*?\&quot;|'.*?')&quot;,&quot;gm&quot;);while((_=$.exec(this.code))!=null)if(_[1]!=undefined&amp;&amp;_[1]!=&quot;&quot;){B(this.matches,new dp.sh.Match(_[1],_.index+_[0].indexOf(_[1]),&quot;strings&quot;));B(this.stringMatches,_[1])}while((_=dp.sh.RegexLib.DoubleQuotedString.exec(this.code))!=null)if(A(this.stringMatches,_[0])==-1)B(this.matches,new dp.sh.Match(_[0],_.index,&quot;strings&quot;));while((_=dp.sh.RegexLib.SingleQuotedString.exec(this.code))!=null)if(A(this.stringMatches,_[0])==-1)B(this.matches,new dp.sh.Match(_[0],_.index,&quot;strings&quot;))};dp.sh.Brushes.Cpp=function(){var _=&quot;ATOM BOOL BOOLEAN BYTE CHAR COLORREF DWORD DWORDLONG DWORD_PTR &quot;+&quot;DWORD32 DWORD64 FLOAT HACCEL HALF_PTR HANDLE HBITMAP HBRUSH &quot;+&quot;HCOLORSPACE HCONV HCONVLIST HCURSOR HDC HDDEDATA HDESK HDROP HDWP &quot;+&quot;HENHMETAFILE HFILE HFONT HGDIOBJ HGLOBAL HHOOK HICON HINSTANCE HKEY &quot;+&quot;HKL HLOCAL HMENU HMETAFILE HMODULE HMONITOR HPALETTE HPEN HRESULT &quot;+&quot;HRGN HRSRC HSZ HWINSTA HWND INT INT_PTR INT32 INT64 LANGID LCID LCTYPE &quot;+&quot;LGRPID LONG LONGLONG LONG_PTR LONG32 LONG64 LPARAM LPBOOL LPBYTE LPCOLORREF &quot;+&quot;LPCSTR LPCTSTR LPCVOID LPCWSTR LPDWORD LPHANDLE LPINT LPLONG LPSTR LPTSTR &quot;+&quot;LPVOID LPWORD LPWSTR LRESULT PBOOL PBOOLEAN PBYTE PCHAR PCSTR PCTSTR PCWSTR &quot;+&quot;PDWORDLONG PDWORD_PTR PDWORD32 PDWORD64 PFLOAT PHALF_PTR PHANDLE PHKEY PINT &quot;+&quot;PINT_PTR PINT32 PINT64 PLCID PLONG PLONGLONG PLONG_PTR PLONG32 PLONG64 POINTER_32 &quot;+&quot;POINTER_64 PSHORT PSIZE_T PSSIZE_T PSTR PTBYTE PTCHAR PTSTR PUCHAR PUHALF_PTR &quot;+&quot;PUINT PUINT_PTR PUINT32 PUINT64 PULONG PULONGLONG PULONG_PTR PULONG32 PULONG64 &quot;+&quot;PUSHORT PVOID PWCHAR PWORD PWSTR SC_HANDLE SC_LOCK SERVICE_STATUS_HANDLE SHORT &quot;+&quot;SIZE_T SSIZE_T TBYTE TCHAR UCHAR UHALF_PTR UINT UINT_PTR UINT32 UINT64 ULONG &quot;+&quot;ULONGLONG ULONG_PTR ULONG32 ULONG64 USHORT USN VOID WCHAR WORD WPARAM WPARAM WPARAM &quot;+&quot;char bool short int __int32 __int64 __int8 __int16 long float double __wchar_t &quot;+&quot;clock_t _complex _dev_t _diskfree_t div_t ldiv_t _exception _EXCEPTION_POINTERS &quot;+&quot;FILE _finddata_t _finddatai64_t _wfinddata_t _wfinddatai64_t __finddata64_t &quot;+&quot;__wfinddata64_t _FPIEEE_RECORD fpos_t _HEAPINFO _HFILE lconv intptr_t &quot;+&quot;jmp_buf mbstate_t _off_t _onexit_t _PNH ptrdiff_t _purecall_handler &quot;+&quot;sig_atomic_t size_t _stat __stat64 _stati64 terminate_function &quot;+&quot;time_t __time64_t _timeb __timeb64 tm uintptr_t _utimbuf &quot;+&quot;va_list wchar_t wctrans_t wctype_t wint_t signed&quot;,$=&quot;break case catch class const __finally __exception __try &quot;+&quot;const_cast continue private public protected __declspec &quot;+&quot;default delete deprecated dllexport dllimport do dynamic_cast &quot;+&quot;else enum explicit extern if for friend goto inline &quot;+&quot;mutable naked namespace new noinline noreturn nothrow &quot;+&quot;register reinterpret_cast return selectany &quot;+&quot;sizeof static static_cast struct switch template this &quot;+&quot;thread throw true false try typedef typeid typename union &quot;+&quot;using uuid virtual void volatile whcar_t while&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^ *#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;datatypes&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-cpp&quot;;this.Style=&quot;.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }&quot;};dp.sh.Brushes.Cpp.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Cpp.Aliases=[&quot;cpp&quot;,&quot;c&quot;,&quot;c++&quot;];dp.sh.Brushes.CSharp=function(){var $=&quot;abstract as base bool break byte case catch char checked class const &quot;+&quot;continue decimal default delegate do double else enum event explicit &quot;+&quot;extern false finally fixed float for foreach get goto if implicit in int &quot;+&quot;interface internal is lock long namespace new null object operator out &quot;+&quot;override params private protected public readonly ref return sbyte sealed set &quot;+&quot;short sizeof stackalloc static string struct switch this throw true try &quot;+&quot;typeof uint ulong unchecked unsafe ushort using virtual void while&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^\\s*#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-c&quot;;this.Style=&quot;.dp-c .vars { color: #d00; }&quot;};dp.sh.Brushes.CSharp.prototype=new dp.sh.Highlighter();dp.sh.Brushes.CSharp.Aliases=[&quot;c#&quot;,&quot;c-sharp&quot;,&quot;csharp&quot;];dp.sh.Brushes.CSS=function(){var _=&quot;ascent azimuth background-attachment background-color background-image background-position &quot;+&quot;background-repeat background baseline bbox border-collapse border-color border-spacing border-style border-top &quot;+&quot;border-right border-bottom border-left border-top-color border-right-color border-bottom-color border-left-color &quot;+&quot;border-top-style border-right-style border-bottom-style border-left-style border-top-width border-right-width &quot;+&quot;border-bottom-width border-left-width border-width border cap-height caption-side centerline clear clip color &quot;+&quot;content counter-increment counter-reset cue-after cue-before cue cursor definition-src descent direction display &quot;+&quot;elevation empty-cells float font-size-adjust font-family font-size font-stretch font-style font-variant font-weight font &quot;+&quot;height letter-spacing line-height list-style-image list-style-position list-style-type list-style margin-top &quot;+&quot;margin-right margin-bottom margin-left margin marker-offset marks mathline max-height max-width min-height min-width orphans &quot;+&quot;outline-color outline-style outline-width outline overflow padding-top padding-right padding-bottom padding-left padding page &quot;+&quot;page-break-after page-break-before page-break-inside pause pause-after pause-before pitch pitch-range play-during position &quot;+&quot;quotes richness size slope src speak-header speak-numeral speak-punctuation speak speech-rate stemh stemv stress &quot;+&quot;table-layout text-align text-decoration text-indent text-shadow text-transform unicode-bidi unicode-range units-per-em &quot;+&quot;vertical-align visibility voice-family volume white-space widows width widths word-spacing x-height z-index&quot;,$=&quot;above absolute all always aqua armenian attr aural auto avoid baseline behind below bidi-override black blink block blue bold bolder &quot;+&quot;both bottom braille capitalize caption center center-left center-right circle close-quote code collapse compact condensed &quot;+&quot;continuous counter counters crop cross crosshair cursive dashed decimal decimal-leading-zero default digits disc dotted double &quot;+&quot;embed embossed e-resize expanded extra-condensed extra-expanded fantasy far-left far-right fast faster fixed format fuchsia &quot;+&quot;gray green groove handheld hebrew help hidden hide high higher icon inline-table inline inset inside invert italic &quot;+&quot;justify landscape large larger left-side left leftwards level lighter lime line-through list-item local loud lower-alpha &quot;+&quot;lowercase lower-greek lower-latin lower-roman lower low ltr marker maroon medium message-box middle mix move narrower &quot;+&quot;navy ne-resize no-close-quote none no-open-quote no-repeat normal nowrap n-resize nw-resize oblique olive once open-quote outset &quot;+&quot;outside overline pointer portrait pre print projection purple red relative repeat repeat-x repeat-y rgb ridge right right-side &quot;+&quot;rightwards rtl run-in screen scroll semi-condensed semi-expanded separate se-resize show silent silver slower slow &quot;+&quot;small small-caps small-caption smaller soft solid speech spell-out square s-resize static status-bar sub super sw-resize &quot;+&quot;table-caption table-cell table-column table-column-group table-footer-group table-header-group table-row table-row-group teal &quot;+&quot;text-bottom text-top thick thin top transparent tty tv ultra-condensed ultra-expanded underline upper-alpha uppercase upper-latin &quot;+&quot;upper-roman url visible wait white wider w-resize x-fast x-high x-large x-loud x-low x-slow x-small x-soft xx-large xx-small yellow&quot;,A=&quot;[mM]onospace [tT]ahoma [vV]erdana [aA]rial [hH]elvetica [sS]ans-serif [sS]erif&quot;;this.regexList=[{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;\\#[a-zA-Z0-9]{3,6}&quot;,&quot;g&quot;),css:&quot;value&quot;},{regex:new RegExp(&quot;(-?\\d+)(.\\d+)?(px|em|pt|:|%|)&quot;,&quot;g&quot;),css:&quot;value&quot;},{regex:new RegExp(&quot;!important&quot;,&quot;g&quot;),css:&quot;important&quot;},{regex:new RegExp(this.GetKeywordsCSS(_),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetValuesCSS($),&quot;g&quot;),css:&quot;value&quot;},{regex:new RegExp(this.GetValuesCSS(A),&quot;g&quot;),css:&quot;value&quot;}];this.CssClass=&quot;dp-css&quot;;this.Style=&quot;.dp-css .value { color: black; }&quot;+&quot;.dp-css .important { color: red; }&quot;};dp.sh.Highlighter.prototype.GetKeywordsCSS=function($){return&quot;\\b([a-z_]|)&quot;+$.replace(/ /g,&quot;(?=:)\\b|\\b([a-z_\\*]|\\*|)&quot;)+&quot;(?=:)\\b&quot;};dp.sh.Highlighter.prototype.GetValuesCSS=function($){return&quot;\\b&quot;+$.replace(/ /g,&quot;(?!-)(?!:)\\b|\\b()&quot;)+&quot;:\\b&quot;};dp.sh.Brushes.CSS.prototype=new dp.sh.Highlighter();dp.sh.Brushes.CSS.Aliases=[&quot;css&quot;];dp.sh.Brushes.Delphi=function(){var $=&quot;abs addr and ansichar ansistring array as asm begin boolean byte cardinal &quot;+&quot;case char class comp const constructor currency destructor div do double &quot;+&quot;downto else end except exports extended false file finalization finally &quot;+&quot;for function goto if implementation in inherited int64 initialization &quot;+&quot;integer interface is label library longint longword mod nil not object &quot;+&quot;of on or packed pansichar pansistring pchar pcurrency pdatetime pextended &quot;+&quot;pint64 pointer private procedure program property pshortstring pstring &quot;+&quot;pvariant pwidechar pwidestring protected public published raise real real48 &quot;+&quot;record repeat set shl shortint shortstring shr single smallint string then &quot;+&quot;threadvar to true try type unit until uses val var varirnt while widechar &quot;+&quot;widestring with word write writeln xor&quot;;this.regexList=[{regex:new RegExp(&quot;\\(\\*[\\s\\S]*?\\*\\)&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:new RegExp(&quot;{(?!\\$)[\\s\\S]*?}&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;\\{\\$[a-zA-Z]+ .+\\}&quot;,&quot;g&quot;),css:&quot;directive&quot;},{regex:new RegExp(&quot;\\b[\\d\\.]+\\b&quot;,&quot;g&quot;),css:&quot;number&quot;},{regex:new RegExp(&quot;\\$[a-zA-Z0-9]+\\b&quot;,&quot;g&quot;),css:&quot;number&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-delphi&quot;;this.Style=&quot;.dp-delphi .number { color: blue; }&quot;+&quot;.dp-delphi .directive { color: #008284; }&quot;+&quot;.dp-delphi .vars { color: #000; }&quot;};dp.sh.Brushes.Delphi.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Delphi.Aliases=[&quot;delphi&quot;,&quot;pascal&quot;];dp.sh.Brushes.Java=function(){var $=&quot;abstract assert boolean break byte case catch char class const &quot;+&quot;continue default do double else enum extends &quot;+&quot;false final finally float for goto if implements import &quot;+&quot;instanceof int interface long native new null &quot;+&quot;package private protected public return &quot;+&quot;short static strictfp super switch synchronized this throw throws true &quot;+&quot;transient try void volatile while&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;\\b([\\d]+(\\.[\\d]+)?|0x[a-f0-9]+)\\b&quot;,&quot;gi&quot;),css:&quot;number&quot;},{regex:new RegExp(&quot;(?!\\@interface\\b)\\@[\\$\\w]+\\b&quot;,&quot;g&quot;),css:&quot;annotation&quot;},{regex:new RegExp(&quot;\\@interface\\b&quot;,&quot;g&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-j&quot;;this.Style=&quot;.dp-j .annotation { color: #646464; }&quot;+&quot;.dp-j .number { color: #C00000; }&quot;};dp.sh.Brushes.Java.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Java.Aliases=[&quot;java&quot;];dp.sh.Brushes.JScript=function(){var $=&quot;abstract boolean break byte case catch char class const continue debugger &quot;+&quot;default delete do double else enum export extends false final finally float &quot;+&quot;for function goto if implements import in instanceof int interface long native &quot;+&quot;new null package private protected public return short static super switch &quot;+&quot;synchronized this throw throws transient true try typeof var void volatile while with&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^\\s*#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-c&quot;};dp.sh.Brushes.JScript.prototype=new dp.sh.Highlighter();dp.sh.Brushes.JScript.Aliases=[&quot;js&quot;,&quot;jscript&quot;,&quot;javascript&quot;];dp.sh.Brushes.Lua=function(){var $=&quot;break do end else elseif function if local nil not or repeat return and then until while this&quot;,_=&quot;math\\.\\w+ string\\.\\w+ os\\.\\w+ debug\\.\\w+ io\\.\\w+ error fopen dofile coroutine\\.\\w+ arg getmetatable ipairs loadfile loadlib loadstring longjmp print rawget rawset seek setmetatable assert tonumber tostring&quot;;this.regexList=[{regex:new RegExp(&quot;--\\[\\[[\\s\\S]*\\]\\]--&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:new RegExp(&quot;--[^\\[]{2}.*$&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;func&quot;},];this.CssClass=&quot;dp-lua&quot;};dp.sh.Brushes.Lua.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Lua.Aliases=[&quot;lua&quot;];dp.sh.Brushes.Mxml=function(){this.CssClass=&quot;dp-mxml&quot;;this.Style=&quot;.dp-mxml .cdata { color: #000000; }&quot;+&quot;.dp-mxml .tag { color : #0000ff; }&quot;+&quot;.dp-mxml .tag-name { color: #0000ff; }&quot;+&quot;.dp-mxml .script { color: green; }&quot;+&quot;.dp-mxml .metadata { color: green; }&quot;+&quot;.dp-mxml .attribute { color: #000000; }&quot;+&quot;.dp-mxml .attribute-value { color: #990000; }&quot;+&quot;.dp-mxml .trace { color: #cc6666; }&quot;+&quot;.dp-mxml .var { color: #6699cc; }&quot;+&quot;.dp-mxml .comment { color: #009900; }&quot;+&quot;.dp-mxml .string { color: #990000; }&quot;+&quot;.dp-mxml .keyword { color: blue; }&quot;};dp.sh.Brushes.Mxml.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Mxml.Aliases=[&quot;mxml&quot;];dp.sh.Brushes.Mxml.prototype.ProcessRegexList=function(){function H(_,$){_[_.length]=$}function B(B,_){var A=0,$=false;for(A=0;A&lt;B.length;A++)if(_.index&gt;B[A].firstIndex&amp;&amp;_.index&lt;B[A].lastIndex)$=true;return $}var $=0,F=null,D=null,A=null,C=&quot;&quot;,E=new Array(),_=&quot;abstract boolean break byte case catch char class const continue debugger &quot;+&quot;default delete do double else enum export extends false final finally float &quot;+&quot;for function goto if implements import in instanceof int interface long native &quot;+&quot;new null package private protected public return short static super switch &quot;+&quot;synchronized this throw throws transient true try typeof var void volatile while with&quot;,G=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^\\s*#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords(&quot;trace&quot;),&quot;gm&quot;),css:&quot;trace&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;keyword&quot;}];A=new RegExp(&quot;&amp;lt;\\!\\[CDATA\\[(.|\\s)*?\\]\\]&amp;gt;&quot;,&quot;gm&quot;);while((F=A.exec(this.code))!=null){C=F[0].substr(0,12);H(this.matches,new dp.sh.Match(C,F.index,&quot;cdata&quot;));C=F[0].substr(12,F[0].length-12-6);for(var I=0;I&lt;G.length;I++)while((D=G[I].regex.exec(C))!=null)H(this.matches,new dp.sh.Match(D[0],F.index+12+D.index,G[I].css));C=F[0].substr(F[0].length-6,6);H(this.matches,new dp.sh.Match(C,F.index+F[0].length-6,&quot;cdata&quot;));E.push({firstIndex:F.index,lastIndex:F.index+F[0].length-1})}this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)!--\\s*.*?\\s*--(&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;comments&quot;);A=new RegExp(&quot;([:\\w-.]+)\\s*=\\s*(\&quot;.*?\&quot;|'.*?'|\\w+)*|(\\w+)&quot;,&quot;gm&quot;);while((F=A.exec(this.code))!=null){if(F[1]==null)continue;if(B(E,F))continue;H(this.matches,new dp.sh.Match(F[1],F.index,&quot;attribute&quot;));if(F[2]!=undefined)H(this.matches,new dp.sh.Match(F[2],F.index+F[0].indexOf(F[2]),&quot;attribute-value&quot;))}A=new RegExp(&quot;(?:&amp;lt;|&lt;)/*\\?*\\s*([:\\w-.]+)&quot;,&quot;gm&quot;);while((F=A.exec(this.code))!=null){if(B(E,F))continue;C=F[0].substr(4,F[0].length-4);switch(C){case&quot;mx:Script&quot;:case&quot;/mx:Script&quot;:H(this.matches,new dp.sh.Match(F[0]+&quot;&amp;gt;&quot;,F.index,&quot;script&quot;));break;case&quot;mx:Metadata&quot;:case&quot;/mx:Metadata&quot;:H(this.matches,new dp.sh.Match(F[0]+&quot;&amp;gt;&quot;,F.index,&quot;metadata&quot;));break;default:H(this.matches,new dp.sh.Match(F[0],F.index,&quot;tag-name&quot;));break}}A=new RegExp(&quot;\\?&amp;gt;|&amp;gt;|/&amp;gt;&quot;,&quot;gm&quot;);while((F=A.exec(this.code))!=null){if(B(E,F))continue;H(this.matches,new dp.sh.Match(F[0],F.index,&quot;tag&quot;))}};dp.sh.Brushes.Perl=function(){var _=&quot;abs accept alarm atan2 bind binmode bless caller chdir chmod chomp chop chown chr chroot close closedir connect cos crypt dbmclose dbmopen defined delete dump each endgrent endhostent endnetent endprotoent endpwent endservent eof exec exists exp fcntl fileno flock fork format formline getc getgrent getgrgid getgrnam gethostbyaddr gethostbyname gethostent getlogin getnetbyaddr getnetbyname getnetent getpeername getpgrp getppid getpriority getprotobyname getprotobynumber getprotoent getpwent getpwnam getpwuid getservbyname getservbyport getservent getsockname getsockopt glob gmtime grep hex import index int ioctl join keys kill lc lcfirst length link listen localtime lock log lstat m map mkdir msgctl msgget msgrcv msgsnd no oct open opendir ord pack pipe pop pos print printf prototype push q qq quotemeta qw qx rand read readdir readline readlink readpipe recv ref rename reset reverse rewinddir rindex rmdir scalar seek seekdir semctl semget semop send setgrent sethostent setnetent setpgrp setpriority setprotoent setpwent setservent setsockopt shift shmctl shmget shmread shmwrite shutdown sin sleep socket socketpair sort splice split sprintf sqrt srand stat study sub substr symlink syscall sysopen sysread sysseek system syswrite tell telldir tie tied time times tr truncate uc ucfirst umask undef unlink unpack unshift untie utime values vec waitpid wantarray warn write qr&quot;,$=&quot;s select goto die do package redo require return continue for foreach last next wait while use if else elsif eval exit unless switch case&quot;,A=&quot;my our local&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLinePerlComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;(\\$|@|%)\\w+&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gmi&quot;),css:&quot;func&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetKeywords(A),&quot;gm&quot;),css:&quot;declarations&quot;}];this.CssClass=&quot;dp-perl&quot;};dp.sh.Brushes.Perl.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Perl.Aliases=[&quot;perl&quot;];dp.sh.Brushes.Php=function(){var _=&quot;abs acos acosh addcslashes addslashes &quot;+&quot;array_change_key_case array_chunk array_combine array_count_values array_diff &quot;+&quot;array_diff_assoc array_diff_key array_diff_uassoc array_diff_ukey array_fill &quot;+&quot;array_filter array_flip array_intersect array_intersect_assoc array_intersect_key &quot;+&quot;array_intersect_uassoc array_intersect_ukey array_key_exists array_keys array_map &quot;+&quot;array_merge array_merge_recursive array_multisort array_pad array_pop array_product &quot;+&quot;array_push array_rand array_reduce array_reverse array_search array_shift &quot;+&quot;array_slice array_splice array_sum array_udiff array_udiff_assoc &quot;+&quot;array_udiff_uassoc array_uintersect array_uintersect_assoc &quot;+&quot;array_uintersect_uassoc array_unique array_unshift array_values array_walk &quot;+&quot;array_walk_recursive atan atan2 atanh base64_decode base64_encode base_convert &quot;+&quot;basename bcadd bccomp bcdiv bcmod bcmul bindec bindtextdomain bzclose bzcompress &quot;+&quot;bzdecompress bzerrno bzerror bzerrstr bzflush bzopen bzread bzwrite ceil chdir &quot;+&quot;checkdate checkdnsrr chgrp chmod chop chown chr chroot chunk_split class_exists &quot;+&quot;closedir closelog copy cos cosh count count_chars date decbin dechex decoct &quot;+&quot;deg2rad delete ebcdic2ascii echo empty end ereg ereg_replace eregi eregi_replace error_log &quot;+&quot;error_reporting escapeshellarg escapeshellcmd eval exec exit exp explode extension_loaded &quot;+&quot;feof fflush fgetc fgetcsv fgets fgetss file_exists file_get_contents file_put_contents &quot;+&quot;fileatime filectime filegroup fileinode filemtime fileowner fileperms filesize filetype &quot;+&quot;floatval flock floor flush fmod fnmatch fopen fpassthru fprintf fputcsv fputs fread fscanf &quot;+&quot;fseek fsockopen fstat ftell ftok getallheaders getcwd getdate getenv gethostbyaddr gethostbyname &quot;+&quot;gethostbynamel getimagesize getlastmod getmxrr getmygid getmyinode getmypid getmyuid getopt &quot;+&quot;getprotobyname getprotobynumber getrandmax getrusage getservbyname getservbyport gettext &quot;+&quot;gettimeofday gettype glob gmdate gmmktime ini_alter ini_get ini_get_all ini_restore ini_set &quot;+&quot;interface_exists intval ip2long is_a is_array is_bool is_callable is_dir is_double &quot;+&quot;is_executable is_file is_finite is_float is_infinite is_int is_integer is_link is_long &quot;+&quot;is_nan is_null is_numeric is_object is_readable is_real is_resource is_scalar is_soap_fault &quot;+&quot;is_string is_subclass_of is_uploaded_file is_writable is_writeable mkdir mktime nl2br &quot;+&quot;parse_ini_file parse_str parse_url passthru pathinfo readlink realpath rewind rewinddir rmdir &quot;+&quot;round str_ireplace str_pad str_repeat str_replace str_rot13 str_shuffle str_split &quot;+&quot;str_word_count strcasecmp strchr strcmp strcoll strcspn strftime strip_tags stripcslashes &quot;+&quot;stripos stripslashes stristr strlen strnatcasecmp strnatcmp strncasecmp strncmp strpbrk &quot;+&quot;strpos strptime strrchr strrev strripos strrpos strspn strstr strtok strtolower strtotime &quot;+&quot;strtoupper strtr strval substr substr_compare&quot;,$=&quot;and or xor __FILE__ __LINE__ array as break case &quot;+&quot;cfunction class const continue declare default die do else &quot;+&quot;elseif empty enddeclare endfor endforeach endif endswitch endwhile &quot;+&quot;extends for foreach function include include_once global if &quot;+&quot;new old_function return static switch use require require_once &quot;+&quot;var while __FUNCTION__ __CLASS__ &quot;+&quot;__METHOD__ abstract interface public implements extends private protected throw&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.MultiLineCComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;\\$\\w+&quot;,&quot;g&quot;),css:&quot;vars&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gmi&quot;),css:&quot;func&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-c&quot;};dp.sh.Brushes.Php.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Php.Aliases=[&quot;php&quot;];dp.sh.Brushes.Python=function(){var $=&quot;and assert break class continue def del elif else &quot;+&quot;except exec finally for from global if import in is &quot;+&quot;lambda not or pass print raise return try yield while&quot;,_=&quot;None True False self cls class_&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLinePerlComments,css:&quot;comment&quot;},{regex:new RegExp(&quot;^\\s*@\\w+&quot;,&quot;gm&quot;),css:&quot;decorator&quot;},{regex:new RegExp(&quot;(['\&quot;]{3})([^\\1])*?\\1&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:new RegExp(&quot;\&quot;(?!\&quot;)(?:\\.|\\\\\\\&quot;|[^\\\&quot;\&quot;\\n\\r])*\&quot;&quot;,&quot;gm&quot;),css:&quot;string&quot;},{regex:new RegExp(&quot;'(?!')*(?:\\.|(\\\\\\')|[^\\''\\n\\r])*'&quot;,&quot;gm&quot;),css:&quot;string&quot;},{regex:new RegExp(&quot;\\b\\d+\\.?\\w*&quot;,&quot;g&quot;),css:&quot;number&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;special&quot;}];this.CssClass=&quot;dp-py&quot;;this.Style=&quot;.dp-py .builtins { color: #ff1493; }&quot;+&quot;.dp-py .magicmethods { color: #808080; }&quot;+&quot;.dp-py .exceptions { color: brown; }&quot;+&quot;.dp-py .types { color: brown; font-style: italic; }&quot;+&quot;.dp-py .commonlibs { color: #8A2BE2; font-style: italic; }&quot;};dp.sh.Brushes.Python.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Python.Aliases=[&quot;py&quot;,&quot;python&quot;];dp.sh.Brushes.Ruby=function(){var $=&quot;alias and BEGIN begin break case class def define_method defined do each else elsif &quot;+&quot;END end ensure false for if in module new next nil not or raise redo rescue retry return &quot;+&quot;self super then throw true undef unless until when while yield&quot;,_=&quot;Array Bignum Binding Class Continuation Dir Exception FalseClass File::Stat File Fixnum Fload &quot;+&quot;Hash Integer IO MatchData Method Module NilClass Numeric Object Proc Range Regexp String Struct::TMS Symbol &quot;+&quot;ThreadGroup Thread Time TrueClass&quot;;this.regexList=[{regex:dp.sh.RegexLib.SingleLinePerlComments,css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;:[a-z][A-Za-z0-9_]*&quot;,&quot;g&quot;),css:&quot;symbol&quot;},{regex:new RegExp(&quot;(\\$|@@|@)\\w+&quot;,&quot;g&quot;),css:&quot;variable&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gm&quot;),css:&quot;builtin&quot;}];this.CssClass=&quot;dp-rb&quot;;this.Style=&quot;.dp-rb .symbol { color: #a70; }&quot;+&quot;.dp-rb .variable { color: #a70; font-weight: bold; }&quot;};dp.sh.Brushes.Ruby.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Ruby.Aliases=[&quot;ruby&quot;,&quot;rails&quot;,&quot;ror&quot;];dp.sh.Brushes.Sql=function(){var _=&quot;abs avg case cast coalesce convert count current_timestamp &quot;+&quot;current_user day isnull left lower month nullif replace right &quot;+&quot;session_user space substring sum system_user upper user year&quot;,$=&quot;absolute action add after alter as asc at authorization begin bigint &quot;+&quot;binary bit by cascade char character check checkpoint close collate &quot;+&quot;column commit committed connect connection constraint contains continue &quot;+&quot;create cube current current_date current_time cursor database date &quot;+&quot;deallocate dec decimal declare default delete desc distinct double drop &quot;+&quot;dynamic else end end-exec escape except exec execute false fetch first &quot;+&quot;float for force foreign forward free from full function global goto grant &quot;+&quot;group grouping having hour ignore index inner insensitive insert instead &quot;+&quot;int integer intersect into is isolation key last level load local max min &quot;+&quot;minute modify move name national nchar next no numeric of off on only &quot;+&quot;open option order out output partial password precision prepare primary &quot;+&quot;prior privileges procedure public read real references relative repeatable &quot;+&quot;restrict return returns revoke rollback rollup rows rule schema scroll &quot;+&quot;second section select sequence serializable set size smallint static &quot;+&quot;statistics table temp temporary then time timestamp to top transaction &quot;+&quot;translation trigger true truncate uncommitted union unique update values &quot;+&quot;varchar varying view when where with work&quot;,A=&quot;all and any between cross in join like not null or outer some&quot;;this.regexList=[{regex:new RegExp(&quot;--(.*)$&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:dp.sh.RegexLib.SingleQuotedString,css:&quot;string&quot;},{regex:new RegExp(this.GetKeywords(_),&quot;gmi&quot;),css:&quot;func&quot;},{regex:new RegExp(this.GetKeywords(A),&quot;gmi&quot;),css:&quot;op&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gmi&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-sql&quot;;this.Style=&quot;.dp-sql .func { color: #ff1493; }&quot;+&quot;.dp-sql .op { color: #808080; }&quot;};dp.sh.Brushes.Sql.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Sql.Aliases=[&quot;sql&quot;];dp.sh.Brushes.Vb=function(){var $=&quot;AddHandler AddressOf AndAlso Alias And Ansi As Assembly Auto &quot;+&quot;Boolean ByRef Byte ByVal Call Case Catch CBool CByte CChar CDate &quot;+&quot;CDec CDbl Char CInt Class CLng CObj Const CShort CSng CStr CType &quot;+&quot;Date Decimal Declare Default Delegate Dim DirectCast Do Double Each &quot;+&quot;Else ElseIf End Enum Erase Error Event Exit False Finally For Friend &quot;+&quot;Function Get GetType GoSub GoTo Handles If Implements Imports In &quot;+&quot;Inherits Integer Interface Is Let Lib Like Long Loop Me Mod Module &quot;+&quot;MustInherit MustOverride MyBase MyClass Namespace New Next Not Nothing &quot;+&quot;NotInheritable NotOverridable Object On Option Optional Or OrElse &quot;+&quot;Overloads Overridable Overrides ParamArray Preserve Private Property &quot;+&quot;Protected Public RaiseEvent ReadOnly ReDim REM RemoveHandler Resume &quot;+&quot;Return Select Set Shadows Shared Short Single Static Step Stop String &quot;+&quot;Structure Sub SyncLock Then Throw To True Try TypeOf Unicode Until &quot;+&quot;Variant When While With WithEvents WriteOnly Xor&quot;;this.regexList=[{regex:new RegExp(&quot;'.*$&quot;,&quot;gm&quot;),css:&quot;comment&quot;},{regex:dp.sh.RegexLib.DoubleQuotedString,css:&quot;string&quot;},{regex:new RegExp(&quot;^\\s*#.*&quot;,&quot;gm&quot;),css:&quot;preprocessor&quot;},{regex:new RegExp(this.GetKeywords($),&quot;gm&quot;),css:&quot;keyword&quot;}];this.CssClass=&quot;dp-vb&quot;};dp.sh.Brushes.Vb.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Vb.Aliases=[&quot;vb&quot;,&quot;vb.net&quot;];dp.sh.Brushes.Xml=function(){this.CssClass=&quot;dp-xml&quot;;this.Style=&quot;.dp-xml .cdata { color: #ff1493; }&quot;+&quot;.dp-xml .tag, .dp-xml .tag-name { color: #069; font-weight: bold; }&quot;+&quot;.dp-xml .attribute { color: red; }&quot;+&quot;.dp-xml .attribute-value { color: blue; }&quot;};dp.sh.Brushes.Xml.prototype=new dp.sh.Highlighter();dp.sh.Brushes.Xml.Aliases=[&quot;xml&quot;,&quot;xhtml&quot;,&quot;xslt&quot;,&quot;html&quot;,&quot;xhtml&quot;];dp.sh.Brushes.Xml.prototype.ProcessRegexList=function(){function B(_,$){_[_.length]=$}var $=0,A=null,_=null;this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)\\!\\[[\\w\\s]*?\\[(.|\\s)*?\\]\\](&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;cdata&quot;);this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)!--\\s*.*?\\s*--(&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;comments&quot;);_=new RegExp(&quot;([:\\w-.]+)\\s*=\\s*(\&quot;.*?\&quot;|'.*?'|\\w+)*|(\\w+)&quot;,&quot;gm&quot;);while((A=_.exec(this.code))!=null){if(A[1]==null)continue;B(this.matches,new dp.sh.Match(A[1],A.index,&quot;attribute&quot;));if(A[2]!=undefined)B(this.matches,new dp.sh.Match(A[2],A.index+A[0].indexOf(A[2]),&quot;attribute-value&quot;))}this.GetMatches(new RegExp(&quot;(&amp;lt;|&lt;)/*\\?*(?!\\!)|/*\\?*(&amp;gt;|&gt;)&quot;,&quot;gm&quot;),&quot;tag&quot;);_=new RegExp(&quot;(?:&amp;lt;|&lt;)/*\\?*\\s*([:\\w-.]+)&quot;,&quot;gm&quot;);while((A=_.exec(this.code))!=null)B(this.matches,new dp.sh.Match(A[1],A.index+A[0].indexOf(A[1]),&quot;tag-name&quot;))}
//}}}</pre>
</div>
<div title="The engine" modifier="Mingos" created="200911082356" modified="201007252130" tags="tutorial engine" changecount="3">
<pre>Umbra's heart is contained within the [[UmbraEngine]] class. It is a very special class that must be instantiated in order for Umbra to run any program.

[[UmbraEngine]] contains a series of public methods that the developer has at his disposal. These methods will be used to register new modules, activate and deactivate them, register fonts, add callbacks containing global keybindings along with their respective custom code, display error messages (hopefully not!) and so on.

There needs to be one and only one instance of the engine, no more, no less. After having registered modules, fonts and callbacks and having configured other things the developer might need, the engine can then be initialised. The initialisation process contains a series of self checks and will only be successful if no obstacles are encountered. In case there are problems, an error log will be created in a text file in the working directory. The file will contain the error(s) the engine has encountered.

Once the initialisation is successful, the engine can be run. Running the engine initiates the main program loop. In it, modules are executed, activated and deactivated, mouse and keyboard input is read and so on. This is when the program is actually executed.</pre>
</div>
<div title="Umbra Hello World" modifier="Mingos" created="200911082305" modified="201010021621" tags="tutorial basics init" changecount="18">
<pre>Let's begin with source code for a //Hello world// program. First, let's create the following {{{main.hpp}}} file:
&lt;code C++&gt;
#include &quot;umbra.hpp&quot; //assumes its search directory is known

class HelloWorld : public UmbraModule {
    void render ();
};
&lt;/code&gt;
Then, let's create the following {{{main.cpp}}} file:
&lt;code C++&gt;
#include &quot;main.hpp&quot;

void HelloWorld::render () {
    TCODConsole::root-&gt;print(0,0,&quot;Hello world!&quot;);
}

int main (void) {
    UmbraEngine engine;
    engine.registerModule(new HelloWorld());
    engine.activateModule(0);
    if (engine.initialise()) return engine.run();
    else return 1;
}
&lt;/code&gt;
This is the simplest program one can create using Umbra. All it does is display the line &quot;Hello world!&quot; and wait patiently for the user to close the program window. Now, let's analyse the program.

The file {{{main.hpp}}} starts with an {{{#include &quot;umbra.hpp&quot;}}} statement. Obviously, the compiler needs to know where to look for the file, so it's best you specify it as one of your search directories. This is Umbra's main header file and contains all the other header files required by the library. This is the only header you will need to include to make Umbra work.

The next statement is {{{class HelloWorld : public UmbraModule}}}. This creates a class called {{{HelloWorld}}} that inherits an [[UmbraModule]]. Please refer to the [[What is a module]] and [[Creating a module]] sections to learn the details. All we need to know right now is that Umbra will not recognise our class if it doesn't inherit an [[UmbraModule]].

One of the methods we can define and implement is {{{void render (void)}}}. This is the method that Umbra will call internally in order to make our module render things on the screen. As you can see, we don't have to call it manually anywhere in the code. All it contains is a libtcod-specific method call {{{TCODConsole::root-&gt;printLeft(0,0,TCOD_BKGND_NONE,&quot;Hello world!&quot;);}}}. This is what prints the line &quot;Hello world!&quot; on the console. ''Note that we don't include [[libtcod|http://doryen.eptalys.net/libtcod]] anywhere in the code - Umbra does it internally.''

After implementing the method in {{{main.cpp}}}, we can finally write the heart of our program. First thing we need to do is to create an instance of [[UmbraEngine]], conveniently called {{{engine}}}. Lines 09. and 10. are crucial for the engine to start running. The first one creates an instance of our {{{HelloWorld}}} class and registers it as a module inside the engine. The next line makes the engine activate the newly registered module. The argument we pass it is an integer value of 0 - this is the ID that our module was assigned. Please refer to [[UmbraModule::registerModule]] for more details on how module ID numbers are assigned.

Finally, we reach the point where the module is registered and active, and the only missing thing is running the engine. First, we need to initialise it, and if the initialisation is successful, run the engine. That's it, this is the code that powers a &quot;Hello world&quot; program made with Umbra.</pre>
</div>
<div title="UmbraCallback" modifier="Mingos" created="201008050906" modified="201008050918" tags="api class callback" changecount="6">
<pre>~UmbraCallback is a mother class that should be inherited by all [[callbacks|What are callbacks]]. It provides a basic set of methods necessary to create a callback and make it work.

When a callback is [[created|Creating a callback]], the class that inherits ~UmbraCallback, it should specify the keystroke that the callback should listen to, as well as custom code that will be launched when the keystroke the listener listens to is detected.

This class contains a pure virtual method and thus cannot be instantiated without it being inherited by a child class.
!Methods
&lt;&lt;tiddler UmbraCallbackMethods&gt;&gt;</pre>
</div>
<div title="UmbraCallback::action" modifier="Mingos" created="201008050951" modified="201008111309" tags="api method callback autoCalling" changecount="4">
<pre>!Description
Contains custom code, executed when the callback listener detects the keystroke it listens to.
!Construction
&lt;code C++&gt;
virtual void action (
) = 0;
&lt;/code&gt;
!Remarks
This method is declared as pure virtual, thus it is mandatory to override it. It should never be called manually, as the engine will take care of calling it when it's necessary to do so.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraCallback::evaluate" modifier="Mingos" created="201008111208" modified="201008111309" tags="api method callback autoCalling" changecount="2">
<pre>!Description
Custom code for the callback listener, evaluating whether the keystroke it catches matches the keystroke it is supposed to be listening to.
!Construction
&lt;code C++&gt;
virtual bool evaluate (
    UmbraKey k
);
&lt;/code&gt;
!Parametres
*{{{UmbraKey k}}}: the keystroke the listener will compare with what it is listening to. This is passed automatically by the engine.
!Return value
{{{bool}}}: {{{true}}} if the keystroke matches the one(s) the callback listens to, {{{false}}} otherwise.
!Remarks
This method is called automatically by the engine. It should not be overlodaded unless the callback should listen to something unusual, such as two different keystrokes.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraCallback::getEngine" modifier="Mingos" created="201008111211" modified="201008111845" tags="api method callback engineReference" changecount="4">
<pre>!Description
Provides a pointer to the engine.
!Construction
&lt;code C++&gt;
UmbraEngine * getEngine (
);
&lt;/code&gt;
!Return value
{{{UmbraEngine *}}}: a pointer to the engine.
!Remarks:
This method is included in the {{{UmbraCallback}}} to make communication with the game engine easier. Using it enables you to call the engine's methods from within the module (for instance, module activation).
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;tutorial&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraCallbackFontDown" modifier="Mingos" created="201008050832" modified="201008152346" tags="api callback internalCallback font" changecount="3">
<pre>!Description
Activates previous font from the fonts list.
!Keybinding
{{{PgDn}}}
!Action
&lt;code C++&gt;
if (getEngine()-&gt;activateFont(-1)) getEngine()-&gt;reinitialise();
&lt;/code&gt;
!Remarks
If the currently used font is the first on the list, the callback has no effect. Otherwise, the font is activated and the engine is reinitialised.
Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackFontDown());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackFontUp" modifier="Mingos" created="201008050831" modified="201008152346" tags="api callback internalCallback font" changecount="3">
<pre>!Description
Activates next font from the fonts list.
!Keybinding
{{{PgUp}}}
!Action
&lt;code C++&gt;
if (getEngine()-&gt;activateFont(1)) getEngine()-&gt;reinitialise();
&lt;/code&gt;
!Remarks
If the currently used font is the last on the list, the callback has no effect. Otherwise, the font is activated and the engine is reinitialised.
Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackFontUp());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackFullscreen" modifier="Mingos" created="201008050821" modified="201008050952" tags="api callback internalCallback" changecount="4">
<pre>!Description
Toggle fullscreen/windowed mode.
!Keybinding
{{{Alt + Enter}}}
!Action
&lt;code C++&gt;
TCODConsole::setFullscreen(!TCODConsole::isFullscreen());
&lt;/code&gt;
!Remarks
Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackFullscreen());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackMethods" modifier="Mingos" created="201008050917" modified="201008111215" tags="methodlist" changecount="2">
<pre>*[[UmbraCallback::action]]
*[[UmbraCallback::evaluate]]
*[[UmbraCallback::getEngine]]</pre>
</div>
<div title="UmbraCallbackPause" modifier="Mingos" created="201008050827" modified="201008050952" tags="api callback internalCallback" changecount="2">
<pre>!Description
Toggles engine pause on and off.
!Keybinding
{{{Pause}}}
!Action
&lt;code C++&gt;
getEngine()-&gt;setPause(!getEngine()-&gt;getPause());
&lt;/code&gt;
!Remarks
Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackPause());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackQuit" modifier="Mingos" created="201008031510" modified="201008050952" tags="api callback internalCallback" changecount="4">
<pre>!Description
Quits the application.
!Keybinding
{{{Alt + F4}}} or {{{Ctrl + q}}}
!Action
&lt;code C++&gt;
getEngine()-&gt;deactivateAll();
&lt;/code&gt;
!Remarks
Listens to two different keystroke combinations. Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackQuit());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackScreenshot" modifier="Mingos" created="201008020101" modified="201008050952" tags="api callback internalCallback" changecount="7">
<pre>!Description
Saves a screenshot.
!Keybinding
{{{PrtSc}}}
!Action
&lt;code C++&gt;
TCODSystem::saveScreenshot(NULL);
&lt;/code&gt;
!Remarks
Registered automatically if default callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackScreenshot());
&lt;/code&gt;</pre>
</div>
<div title="UmbraCallbackSpeedometer" modifier="Mingos" created="201008050825" modified="201008050952" tags="api callback internalModule internalCallback" changecount="3">
<pre>!Description
Toggles the Speed-o-meter internal module on and off.
!Keybinding
{{{F5}}}
!Action
&lt;code C++&gt;
if (getEngine()-&gt;getModule(UMBRA_INTERNAL_SPEEDOMETER)-&gt;getActive()) {
    getEngine()-&gt;deactivateModule(UMBRA_INTERNAL_SPEEDOMETER);
}
else {
    getEngine()-&gt;activateModule(UMBRA_INTERNAL_SPEEDOMETER);
}
&lt;/code&gt;
!Remarks
Registered automatically if additional callbacks are enabled during engine initialisation. If not, it can be registered manually:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new UmbraCallbackSpeedometer());
&lt;/code&gt;</pre>
</div>
<div title="UmbraEngine" modifier="Mingos" created="200910241822" modified="201008050918" tags="api class engine" changecount="58">
<pre>The class UmbraEngine contains the heart of Umbra. An instance of UmbraEngine needs to be created in order for Umbra to become alive:
&lt;code C++&gt;
UmbraEngine engine;
&lt;/code&gt;
Umbra will look for its {{{umbra.txt}}} configuration file in {{{./data/cfg/}}} by default. If you want it in another directory, use this syntax ;
&lt;code C++&gt;
UmbraEngine engine(&quot;./config&quot;);
&lt;/code&gt;
Then, several [[UmbraModule]]s need to be declared. The modules are assigned unique id numbers. The first registered module has {{{id=0}}}, the second one has {{{id=1}}} and so on. Make sure you can refer to those modules in some way, for instance, by creating an enumeration with unique names. The registerModule function also returns the registered module id.
&lt;code C++&gt;
engine.registerModule(new Credits());
&lt;/code&gt;
You can also register a module with a fallback module that will be automatically activated when the current module is deactivated (when its update function returns {{{false}}}):
&lt;code C++&gt;
int mainMenuId = engine.registerModule(new MainMenu());
engine.registerModule(new Credits(), mainMenuId);
&lt;/code&gt;
Then you have to activate at least one module, the game starting screen.
&lt;code C++&gt;
engine.activateModule(mainMenuId);
&lt;/code&gt;
Finally, the engine is initialised and run:
&lt;code C++&gt;
if (engine.init()) return engine.run();
else return 1;
&lt;/code&gt;
The [[UmbraEngine::initialise]] method actually creates the game window. The [[UmbraEngine::run]] method contains the main game loop, which exits when all modules are deactivated.
See [[Font autodetection]] for details about how font are loaded by Umbra.
&lt;code C++&gt;
UmbraEngine engine;
engine.registerModule(new Credits());
int mainMenuId = engine.registerModule(new MainMenu());
engine.registerModule(new Credits(), mainMenuId);
engine.activateModule(mainMenuId);
if (engine.init()) return engine.run();
else return 1;
&lt;/code&gt;
!Methods
&lt;&lt;tiddler UmbraEngineMethods&gt;&gt;</pre>
</div>
<div title="UmbraEngine::UmbraEngine" modifier="Mingos" created="201008111830" modified="201008111840" tags="api method engineClass constructor" changecount="2">
<pre>!Description
Constructor for the engine.
!Construction
&lt;code C++&gt;
UmbraEngine (
    const char *fileName = &quot;data/cfg/umbra.txt&quot;,
    UmbraRegisterCallbackFlag flag = UMBRA_REGISTER_DEFAULT
);
&lt;/code&gt;
!Parametres
*{{{const char *fileName}}}: the string containing the file name (with path) to Umbra's configuration file. Defaults to {{{&quot;data/cfg/umbra.txt&quot;}}}.
*{{{UmbraRegisterCallbackFlag flag}}}: the flag, as defined in [[UmbraRegisterCallbackFlag]], telling the engine which [[internal callbacks|Internal callbacks]] should be registered.
!Remarks
Before being initialised, the engine needs to be instantiated. The constructor may take 2, 1 or no arguments, as they both have default values.
!Example
&lt;code C++&gt;
//use default values
UmbraEngine engine;
&lt;/code&gt;
&lt;code C++&gt;
//specify the config file, but leave callbacks at default
UmbraEngine engine(&quot;path/to/config/file.txt&quot;);
&lt;/code&gt;
&lt;code C++&gt;
//specify which callbacks to register, but leave path at default
UmbraEngine engine(UMBRA_REGISTER_ALL);
&lt;/code&gt;
&lt;code C++&gt;
//specify everything explicitly
UmbraEngine engine(&quot;path/to/config/file.txt&quot;,UMBRA_REGISTER_ALL);
&lt;/code&gt;</pre>
</div>
<div title="UmbraEngine::activateFont" modifier="Mingos" created="201007201539" modified="201007271605" tags="api method engineClass font" changecount="38">
<pre>!Description
Activates a previously registered font.
!Construction
&lt;code C++&gt;
bool activateFont (
    int shift = 0
);
&lt;/code&gt;
!Parametres
*{{{int shift}}}: a value of 0 will cause no effect at all. This is the default value, so specifying none will also cause no effect. A positive value will switch to the next font in the registered fonts list. A negative value will switch to the previous font in the registered fonts list.
!Return value
{{{bool}}}: {{{true}}} if the requested font could be activated, {{{false}}} otherwise.
!Remarks:
This method will reinitialise the root console.
If the engine is created with the {{{registerDefaultCallbacks}}} parametre set to {{{true}}}, this method can be accessed anytime during the application runtime by pressing the page up and page down keys.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;tutorial&quot;])'&gt;&gt;

</pre>
</div>
<div title="UmbraEngine::activateModule" modifier="Mingos" created="200911081445" modified="201008111840" tags="api method engineClass module moduleStatus init" changecount="23">
<pre>!Description
Puts a module on the activation list. It will be activated in the next main game loop iteration (next frame).
!Construction
&lt;code C++&gt;
void activateModule (
    int moduleId
);
&lt;/code&gt;
&lt;code C++&gt;
void activateModule (
    UmbraModule * mod
);
&lt;/code&gt;
&lt;code C++&gt;
void activateModule (
    UmbraInternalModuleID id
);
&lt;/code&gt;
!Parametres
*{{{int moduleId}}} - the ID number of a module, returned by the [[UmbraEngine::registerModule]] method.
*{{{UmbraModule * mod}}} - pointer to a module, returned by the [[UmbraEngine::getModule]] methods.
*{{{UmbraInternalModuleID id}}} - the ID number of an internal module, as defined in the [[UmbraInternalModuleID]] enum.
!Remarks:
You may use three ways of specifying a module: either specify the integer user module ID, pass a reference to the module in question, or specify an internal module ID.
!Example:
&lt;code c++&gt;
//module IDs
enum {
    MOD_CREDITS,
    MOD_MAIN_MENU
};
UmbraEngine engine;  
engine.registerModule (new Module1(), MOD_CREDITS);
UmbraModule * mod = new Module2();
engine.registerModule (mod, MOD_MAIN_MENU);
engine.activateModule(MOD_CREDITS); //user module ID
engine.activateModule(mod); //module reference
engine.activateModule(UMBRA_INTERNAL_SPEEDOMETER); //internal module ID
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::deactivateAll" modifier="Mingos" created="200911082255" modified="201007271606" tags="api method engineClass module moduleStatus" changecount="14">
<pre>!Description
Deactivates all active modules in order to end the program.
!Construction
&lt;code C++&gt;
void deactivateAll (
);
&lt;/code&gt;
!Remarks
If the program is supposed to end, calling this method will deactivate all modules and thus end the main program loop.
!Example
&lt;code c++&gt;
class MyModule : public UmbraModule {
    ...
    void MyModule::shutdown (void) {
        getEngine()-&gt;deactivateAll();
    }
};
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::deactivateModule" modifier="Mingos" created="200911081458" modified="201008111841" tags="api method engineClass module moduleStatus" changecount="18">
<pre>!Description
Puts a module on the deactivation list. It will be deactivated in the next main game loop iteration (next frame).
!Construction
&lt;code C++&gt;
void deactivateModule (
    int moduleId
);
&lt;/code&gt;
&lt;code C++&gt;
void deactivateModule (
    UmbraModule * mod
);
&lt;/code&gt;
&lt;code C++&gt;
void deactivateModule (
    UmbraInternalModuleID id
);
&lt;/code&gt;
!Parametres
*{{{int moduleId}}} - the ID number of a module, returned by the [[UmbraEngine::registerModule]] method.
*{{{UmbraModule * mod}}} - pointer to a module, returned by the [[UmbraEngine::getModule]] methods.
*{{{UmbraInternalModuleID id}}} - the ID number of an internal module, as defined in the [[UmbraInternalModuleID]] enum.
!Remarks
You may use three ways of specifying a module: either specify the integer user module ID, pass a reference to the module in question, or specify an internal module ID.
!Example
&lt;code c++&gt;
//module IDs
enum {
    MOD_CREDITS,
    MOD_MAIN_MENU
};
UmbraEngine engine;  
engine.registerModule (new Module1(), MOD_CREDITS);
UmbraModule * mod = new Module2();
engine.registerModule (mod, MOD_MAIN_MENU);
engine.activateModule(MOD_CREDITS); //user module ID
engine.activateModule(mod); //module reference
engine.activateModule(UMBRA_INTERNAL_SPEEDOMETER); //internal module ID
engine.deactivateModule(MOD_CREDITS); //user module ID
engine.deactivateModule(mod); //module reference
engine.deactivateModule(UMBRA_INTERNAL_SPEEDOMETER); //internal module ID
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::displayError" modifier="Mingos" created="201007302135" modified="201007302137" tags="api method engineClass error" changecount="2">
<pre>!Description
Displays a [[BSOD]] with the last error in the [[error log|Error log]].
!Construction
&lt;code C++&gt;
void displayError (
);
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getFontDir" modifier="Mingos" created="201007252102" modified="201007271606" tags="api method engineClass font" changecount="9">
<pre>!Description
Retrieves the path to the directory where font files are stored.
!Construction
&lt;code C++&gt;
const char * getFontDir (
);
&lt;/code&gt;
!Return value
{{{const char*}}}: the path to the font directory.
!Remarks
The path will be relative to the application's working directory. For instance, if the working directory is {{{/home/mingos/Documents/umbra/}}} and the font files are kept in {{{/home/mingos/Documents/umbra/data/img/}}}, this method will return {{{/data/img/}}}.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getFontID" modifier="Mingos" created="201007220558" modified="201007302347" tags="api method engineClass font" changecount="9">
<pre>!Description
Gets the ID number of the font that is currently in use.
!Construction
&lt;code C++&gt;
int getFontID (
);
&lt;/code&gt;
!Return value
{{{int}}}: the ID number of the currently used font
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getInstance" modifier="Mingos" created="200911091623" modified="201007272125" tags="api method engineClass engineReference" changecount="17">
<pre>!Description
Returns a pointer the the engine.
!Construction
&lt;code C++&gt;
static UmbraEngine * getInstance (
);
&lt;/code&gt;
!Return value
{{{UmbraEngine*}}}: a pointer to the engine.
!Remarks
Since modules aren't intrinsically aware of the engine, this static method hands them a possibility to access the engine's methods.
This method is static, so it can be called without having to use the engine instance's name.
It can be called from anywhere in the code.
!Example:
&lt;code c++&gt;
UmbraEngine engine;
UmbraEngine::getInstance()-&gt;registerFont(32,8,&quot;data/img/font10x10.png&quot;);
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getKeyboardMode" modifier="Mingos" created="201007252205" modified="201007272135" tags="api method engineClass keyboard keyboardMode" changecount="5">
<pre>!Description
Retrieves the currently used keyboard mode (the way the engine reacts to keyboard events).
!Construction
&lt;code C++&gt;
UmbraKeyboardMode getKeyboardMode (
);
&lt;/code&gt;
!Return value
{{{UmbraKeyboardMode}}}: the keyboard mode, as defined in the [[UmbraKeyboardMode]] enum.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getModule" modifier="Mingos" created="200911081506" modified="201007271607" tags="api method engineClass module moduleReference" changecount="13">
<pre>!Description
Retrieves a reference to the module with the ID passed in the argument.
!Construction
&lt;code C++&gt;
UmbraModule *  getModule (
    int moduleId
);

UmbraModule * getModule (
    UmbraInternalModuleID id
);
&lt;/code&gt;
!Parametres
*{{{int moduleId}}}: the ID number of a module, returned by the [[UmbraEngine::registerModule]] method.
*{{{UmbraInternalModuleID id}}}: the ID number of an internal module, as defined in the [[UmbraInternalModuleID]] enum.
!Return value
{{{UmbraModule*}}}: reference to the UmbraModule object with the specified ID
!Remarks
Both user modules (integer ID) and internal modules (UmbraInternalModuleID) can be retrieved that way.
Modules need to be registered to be retrieved. They needn't be active or even initialised.
!Example
&lt;code C++&gt;
const int modID = 0;
UmbraEngine engine;
engine.registerModule (new Module(), modID);
UmbraModule * mod = engine.getModule (modID); //registered user module
UmbraModule * mod2 = engine.getModule (UMBRA_INTERNAL_SPEEDOMETER); //an internal module
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleReference&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleReference&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleReference&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getNbFonts" modifier="Mingos" created="201007221228" modified="201007272117" tags="api method engineClass font" changecount="8">
<pre>!Description
Gets the total number of registered fonts.
!Construction
&lt;code C++&gt;
int getNbFonts (
);
&lt;/code&gt;
!Return value
{{{int}}}: the number of fonts that are currently registered and ready for use.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getPause" modifier="Mingos" created="201007302343" modified="201008031450" tags="api method engineClass engineSettings" changecount="5">
<pre>!Description
Checks whether the engine is paused or not.
!Construction
&lt;code C++&gt;
bool getPause (
);
&lt;/code&gt;
!Return value
{{{bool}}}: {{{true}}} if the engine is paused, {{{false}}} otherwise.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getRootHeight" modifier="Mingos" created="201007302351" tags="api method engineClass engineSettings" changecount="1">
<pre>!Description
Gets the height of the root console.
!Construction
&lt;code C++&gt;
int getRootHeight (
);
&lt;/code&gt;
!Return value
{{{int}}}: the height of the root console in cells.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::getRootWidth" modifier="Mingos" created="201007310015" tags="api method engineClass engineSettings" changecount="1">
<pre>!Description
Gets the width of the root console.
!Construction
&lt;code C++&gt;
int getRootWidth (
);
&lt;/code&gt;
!Return value
{{{int}}}: the width of the root console in cells.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::initialise" modifier="Mingos" created="200911091904" modified="201007310022" tags="api method engine engineClass init" changecount="15">
<pre>!Description
Initialises the engine.
!Construction
&lt;code C++&gt;
bool initialise (
    TCOD_renderer_t renderer = TCOD_RENDERER_SDL
);
&lt;/code&gt;
!Parametres
*{{{TCOD_renderer_t renderer}}}: the renderer libtcod should use. For a list of available renderers, please refer to [[libtcod documentation|http://doryen.eptalys.net/data/libtcod/doc/1.5.1/html2/console_init_root.html?c=false&amp;cpp=true&amp;cs=false&amp;py=false&amp;lua=false]]. Defaults to SDL.
!Return value
{{{bool}}}: {{{true}}} if the engine has been initialised successfully, {{{false}}} otherwise.
!Remarks
The engine needs to be initialised before registering any modules and fonts. It cannot run if it is not initialised.
!Example
&lt;code c++&gt;
UmbraEngine engine;
engine.registerModule(new MyModule());
engine.activateModule(0);
if (engine.initialise()) return engine.run();
else return 1;
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;engineClass&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::registerCallback" modifier="Mingos" created="201008111159" tags="api method engineClass init callback" changecount="1">
<pre>!Description
Registers a callback, creating an active listener.
!Construction
&lt;code C++&gt;
void registerCallback (
    UmbraCallback * cbk
);
&lt;/code&gt;
!Parametres
*{{{UmbraCallback * cbk}}}: a pointer to a callback.
!Remarks
In order to be registered, a callback needs to be [[created|Creating a callback]]. It can be instantiated using the {{{new}}} operator inside the method's argument.
!Example
&lt;code C++&gt;
UmbraEngine engine;
engine.registerCallback(new MyCallback());
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;callback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::registerFont" modifier="Mingos" created="200911051013" modified="201007272138" tags="api method engineClass font init" changecount="22">
<pre>!Description
Registers a font file to be used by libtcod.
!Construction
&lt;code C++&gt;
void UmbraEngine::registerFont (
    int columns, 
    int rows,
    const char * filename, 
    int flags
);
&lt;/code&gt;
!Parametres
*{{{int columns}}}: the number of columns in the font image file
*{{{int rows}}}: the number of rown int the font image file
*{{{const char * filename}}}: the name of the file containing the font image
*{{{int flags}}}: the flags that should be used to register the font. Please refer to [[libtcod documentation|http://doryen.eptalys.net/data/libtcod/doc/1.5.0/console/console_set_bitmap_font_size.html]] to check the available flags.
!Remarks
If you don't want Umbra to use [[Font autodetection]], you have to register your font(s) manually before initialising the engine.
Use this method to register each font, ordered smallest to biggest. The parametres are the same as in libtcod's {{{setCustomFont}}} method. See libtcod documentation for details.
Each registered font is assigned an ID, starting with 0 and incrementing. The user can change the font by pressing pageUp or pageDown (by default). You can know what font is currently used with [[UmbraEngine::getFontID]].
!Example:
&lt;code C++&gt;
UmbraEngine engine;
engine.registerFont(32,8,&quot;./fonts/arial8x8.png&quot;, TCOD_FONT_LAYOUT_TCOD|TCOD_FONT_GREYSCALE);
engine.registerFont(32,8,&quot;./fonts/arial10x10.png&quot;, TCOD_FONT_LAYOUT_TCOD|TCOD_FONT_GREYSCALE);
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;font&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::registerModule" modifier="Mingos" created="200911091644" modified="201007272138" tags="api method engineClass module fallback init" changecount="16">
<pre>!Description
Registers a user defined module for future activation.
!Construction
&lt;code C++&gt;
int registerModule (
    UmbraModule * module,
    int fallback = (-1)
);
&lt;/code&gt;
!Parametres
*{{{UmbraModule * module}}}: a pointer to the module to be registered.
*{{{int fallback}}}: ID number of the module to be activated once the registered one is deactivated (module fallback). A value of -1 sets the fallback off. Specifying no value also sets the fallback off.
!Return value
{{{int}}}: the registered module's ID number.
!Remarks
The method requires the creation of a pointer to a module. The easiest way to achieve this is to call the {{{new}}} operator inside the method's argument.
The method registers the newly created module for further use and assigns it an ID number. This number is generated automatically: the first registered module gets ID 0, the next is assigned 1, then 2, and so on, progressively. It is always wise to control the order in which the modules are registered.
The second argument is optional. It is a module ID that will be activated once the currently registered module is deactivated. If no fallback ID is specified, no modules will be activated after deactivating the one currently registered.
!Example
&lt;code C++&gt;
UmbraEngine engine;
int mod1 = engine.registerModule(new MyModule()); //mod1 = 0
int mod2 = engine.registerModule(new MyModule2(),mod1); //mod2 = 1; falls back to the previous one
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;module&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;module&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;module&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::reinitialise" modifier="Mingos" created="201007310024" tags="api method engine engineClass init" changecount="1">
<pre>!Description
Reinitialises the engine.
!Construction
&lt;code C++&gt;
void reinitialise (
    TCOD_renderer_t renderer = TCOD_RENDERER_SDL
);
&lt;/code&gt;
!Parametres
*{{{TCOD_renderer_t renderer}}}: the renderer libtcod should use. For a list of available renderers, please refer to [[libtcod documentation|http://doryen.eptalys.net/data/libtcod/doc/1.5.1/html2/console_init_root.html?c=false&amp;cpp=true&amp;cs=false&amp;py=false&amp;lua=false]]. Defaults to SDL.
!Remarks
Reinitialising the engine is necessary when some changes are made to the engine settings that do not take effect until the root console is closed and initialised anew.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;engineClass&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::run" modifier="Mingos" created="200911111442" modified="201007272131" tags="api method engine engineClass" changecount="10">
<pre>!Description
Initiates the main game loop, effectively running the application.
!Construction
&lt;code C++&gt;
int run (
);
&lt;/code&gt;
!Return value
{{{int}}}: 0 on successful exit or other number on abnormal termination. In case a nonzero value is returned, the error log will probably contain the description of what caused the error.
!Remarks
The engine needs to be run to initiate the application's main loop. The engine needs to be instantiated and successfully initialised before it can be run.
!Example
&lt;code c++&gt;
UmbraEngine engine;  
engine.registerModule (new MyModule());
engine.activateModule(0);
if (engine.initialise()) {
    return engine.run();
}
else
    return 1;
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engine&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::setKeyboardMode" modifier="Mingos" created="201007252116" modified="201007272135" tags="api method engineClass keyboard keyboardMode" changecount="8">
<pre>!Description
Sets the keyboard mode (the way the engine reacts to keyboard events).
!Construction
&lt;code C++&gt;
void setKeyboardMode (
    UmbraKeyboardMode mode
);
&lt;/code&gt;
!Parametres
*{{{UmbraKeyboardMode mode}}}: keyboard mode, as defined en the UmbraKeyboardMode enum.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;keyboard&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::setPause" modifier="Mingos" created="201007310112" tags="api method engineClass engineSettings" changecount="1">
<pre>!Description
Pauses or unpauses the engine.
!Construction
&lt;code C++&gt;
void setPause (
    bool pause
);
&lt;/code&gt;
!Parametres
*{{{bool pause}}}: {{{true}}} will pause the engine, while {{{false}}} will unpause it.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::setRootDimensions" modifier="Mingos" created="201007310018" modified="201007310019" tags="api method engineClass engineSettings" changecount="2">
<pre>!Description
Gets the height of the root console.
!Construction
&lt;code C++&gt;
static void setRootDimensions (
    int w,
    int h
);
&lt;/code&gt;
!Parametres
*{{{int w}}}: root console width in cells
*{{{int h}}}: root console height in cells
!Remarks
Calling this method will [[reinitialise|UmbraEngine::reinitialise]] the engine.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineSettings&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngine::setWindowTitle" modifier="Mingos" created="201003302007" modified="201008111842" tags="api method engineClass init" changecount="12">
<pre>!Description
Sets the game window title.
!Construction
&lt;code C++&gt;
void setWindowTitle (
    const char * title,
    ...
);
&lt;/code&gt;
&lt;code C++&gt;
void setWindowTitle (
    std::string title
);
&lt;/code&gt;
!Parametres
*{{{const char * title}}}: the string containing the window's title. Uses {{{printf}}}-like formatting.
*{{{std::string title}}}: the string containing the window's title.
!Remarks
This method should be used prior to calling [[UmbraEngine::initialise]]. Should the title change afterwards, the change will be seen only after calling [[UmbraEngine::reinitialise]].
!Example
&lt;code C++&gt;
UmbraEngine engine;  
engine.registerModule(new MyModule());  
engine.activateModule(0);
engine.setWindowTitle(&quot;My game window title&quot;); 
if (engine.initialise()) return engine.run();  
else return 1;
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;init&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;init&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;init&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraEngineMethods" modifier="Mingos" created="201007271125" modified="201008111830" tags="methodlist" changecount="15">
<pre>*[[UmbraEngine::activateFont]]
*[[UmbraEngine::activateModule]]
*[[UmbraEngine::deactivateAll]]
*[[UmbraEngine::deactivateModule]]
*[[UmbraEngine::displayError]]
*[[UmbraEngine::getFontDir]]
*[[UmbraEngine::getFontID]]
*[[UmbraEngine::getInstance]]
*[[UmbraEngine::getKeyboardMode]]
*[[UmbraEngine::getModule]]
*[[UmbraEngine::getNbFonts]]
*[[UmbraEngine::getPause]]
*[[UmbraEngine::getRootHeight]]
*[[UmbraEngine::getRootWidth]]
*[[UmbraEngine::initialise]]
*[[UmbraEngine::registerCallback]]
*[[UmbraEngine::registerFont]]
*[[UmbraEngine::registerModule]]
*[[UmbraEngine::reinitialise]]
*[[UmbraEngine::run]]
*[[UmbraEngine::setKeyboardMode]]
*[[UmbraEngine::setPause]]
*[[UmbraEngine::setRootDimensions]]
*[[UmbraEngine::setWindowTitle]]
*[[UmbraEngine::UmbraEngine]]</pre>
</div>
<div title="UmbraError" modifier="Mingos" created="201003301723" modified="201008191705" tags="api class error" changecount="11">
<pre>~UmbraError is a class that does not take part in handling game itself. As its name implies, it is there to handle errors and aid in preventing the occurrence of errors. It is essentially a list of all logged errors, which you can use for debugging.

~UmbraError has five public methods, all of which are static. You are welcome to call them at any point in your program.

Umbra uses this class internally in many situations to notify you of any possible mistakes, such as trying to load a module that hasn't been initialised yet. The last logged message can be displayed on {{{stderr}}} (default behaviour), but if Umbra is in debug mode, it will also activate a warning prompt, humorously called the [[BSOD]].

Should any error be logged during the program execution, an error log file called {{{errorlog.txt}}} will be created in the program's execution directory for your review. Please remember to read it if there are any issues, as it may contain indications regarding what you can do to repair the issue.
!Methods
&lt;&lt;tiddler UmbraErrorMethods&gt;&gt;</pre>
</div>
<div title="UmbraError::add" modifier="Mingos" created="201003301902" modified="201010021200" tags="api method error" changecount="20">
<pre>!Description
Appends an error message to the error list in the log.
!Construction
&lt;code C++&gt;
static int add (
    UmbraErrorLevel errLev,
    const char * errStr,
    ...
);
&lt;/code&gt;
&lt;code C++&gt;
static int add (
    UmbraErrorLevel errLev,
    std::string errStr
);
&lt;/code&gt;
!Parametres
*{{{UmbraErrorLevel errLev}}}: the error level, as defined in [[UmbraErrorLevel]] enum.
*{{{const char * errStr}}}: the string contaning the error message. The string uses {{{printf}}}-like formatting.
*{{{std::string errStr}}}: the string contaning the error message.
!Return value
{{{int}}}: error ID number in the error log.
!Remarks
Using this method will append an error the the error log, display it on {{{stderr}}} (typically, the console) and ensure that the error log is saved to a text file.
The returned ID number may be used to retrieve the error later using [[UmbraError::getMessage]].
!Example
&lt;code C++&gt;
if (errorCondition) {
    UmbraError::add(UMBRA_ERRORLEVEL_ERROR, &quot;Oh my God, I'm an error!&quot;);
    UmbraError::add(UMBRA_ERRORLEVEL_NOTICE, &quot;%d, %d, %d, format me!&quot;, 1, 2, 3);
    std::string err = &quot;STL is good for error reporting too!&quot;;
    UmbraError::add(UMBRA_ERRORLEVEL_NOTICE, err);
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraError::fileExists" modifier="Mingos" created="201003301940" modified="201007272255" tags="api method error" changecount="9">
<pre>!Description
Checks whether a given file exists.
!Construction
&lt;code C++&gt;
static bool fileExists (
    const char * filename,
    ...
);
&lt;/code&gt;
!Parametres
*{{{const char * filename}}}: the name of the file whose existence needs to be confirmed. The string accepts {{{printf}}}-like formatting.
!Return value
{{{bool}}}: {{{true}}} if the specified file exists, {{{false}}} otherwise.
!Remarks
:This method is best used to prevent crashes due to a missing file. Useful for confirming the existence of data and configuration files.
!Example
&lt;code C++&gt;
if (!UmbraError::fileExists(&quot;my/directory/missingfile.txt&quot;)) {
    UmbraError::add(&quot;The file is missing!&quot;);
    exit(1);
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraError::getLastMessage" modifier="Mingos" created="201008191716" modified="201008191723" tags="api method error" changecount="4">
<pre>!Description
Retrieves the last error message that has been placed in the message log.
!Construction
&lt;code C++&gt;
static const char * getLastMessage (
);
&lt;/code&gt;
!Return value
{{{const char *}}}: The error message of the last logged error.
!Remarks
If there are no errors in the log, this method will return the string {{{&quot;No errors registered.&quot;}}}. Otherwise, the last error log message is returned.
!Example
&lt;code C++&gt;
int err = UmbraError::getNbErrors();
if (err &gt; 0)
    std::cout &lt;&lt; UmbraError::getLastMessage() &lt;&lt; std::endl;
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraError::getMessage" modifier="Mingos" created="201008191723" modified="201008191725" tags="api method error" changecount="2">
<pre>!Description
Retrieves an error message that has been placed in the message log under the specified index position.
!Construction
&lt;code C++&gt;
static const char * getMessage (
    int idx
);
&lt;/code&gt;
!Parametres
*{{{int idx}}}: The index number of the message in the log.
!Return value
{{{const char *}}}: The error message of the requested error.
!Remarks
Should an invalid index be specified, this method will return the string {{{&quot;Requested wrong error index.&quot;}}}.
!Example
&lt;code C++&gt;
int err = UmbraError::getNbErrors();
if (err &gt; 0) {
    int i;
    for (i = 0; i &lt; err; i++)
        std::cout &lt;&lt; UmbraError::getMessage(i) &lt;&lt; std::endl;
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraError::getNbErrors" modifier="Mingos" created="201008191714" modified="201008191718" tags="api method error" changecount="4">
<pre>!Description
Retrieves the number of errors that have been placed in the error log from the application's start.
!Construction
&lt;code C++&gt;
static int getNbErrors (
);
&lt;/code&gt;
!Return value
{{{int}}}: number of errors that have been logged so far.
!Example
&lt;code C++&gt;
int err = UmbraError::getNbErrors();
if (err &gt; 0)
    std::cout &lt;&lt; err &lt;&lt; &quot; errors have been encountered so far.&quot; &lt;&lt; std::endl;
else
    std::cout &lt;&lt; &quot;No errors so far, you lucky bastard!&quot; &lt;&lt; std::endl;
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;error&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraErrorLevel" modifier="Mingos" created="201010021148" modified="201010021157" tags="api enum error" changecount="3">
<pre>!Description
Error levels are used while logging errors in the error log. Their role is purely informative.
!Construction
&lt;code C++&gt;
enum UmbraErrorLevel {
	UMBRA_ERRORLEVEL_NOTICE,
	UMBRA_ERRORLEVEL_WARNING,
	UMBRA_ERRORLEVEL_ERROR,
	UMBRA_ERRORLEVEL_FATAL_ERROR
};
&lt;/code&gt;
!Values
*{{{UMBRA_ERRORLEVEL_NOTICE}}}: A notice. Used for situations that do not produce ill effects, but a message is nonetheless appropriate.
*{{{UMBRA_ERRORLEVEL_WARNING}}}: A warning. Used for logging situations that don't interrupt the application, but may produce unwanted effects.
*{{{UMBRA_KEYBOARD_RELEASED}}}: An error. Used for logging situations that don't interrupt the application, but are guaranteed to produce unwanted effects.
*{{{UMBRA_KEYBOARD_PRESSED}}}: A fatal error: Used for logging unrecoverable errors that prevent the application from continuing.</pre>
</div>
<div title="UmbraErrorMethods" modifier="Mingos" created="201007271141" modified="201007271252" tags="methodlist" changecount="3">
<pre>*[[UmbraError::add]]
*[[UmbraError::fileExists]]
*[[UmbraError::getLastMessage]]
*[[UmbraError::getMessage]]
*[[UmbraError::getNbErrors]]</pre>
</div>
<div title="UmbraInternalModuleID" modifier="Mingos" created="200911081536" modified="201007271729" tags="api enum module internalModule moduleReference" changecount="13">
<pre>!Description
ID numbers for all internal modules available in Umbra.
!Construction
&lt;code C++&gt;
enum UmbraInternalModuleID {
    UMBRA_INTERNAL_SPEEDOMETER,
    UMBRA_INTERNAL_BSOD,
    UMBRA_INTERNAL_MAX
};
&lt;/code&gt;
!Values
*{{{UMBRA_INTERNAL_SPEEDOMETER}}}: The Speed-o-meter widget.
*{{{UMBRA_INTERNAL_BSOD}}}: The error notification widget.
*{{{UMBRA_INTERNAL_MAX}}}: Total number of internal modules available.
!Example
&lt;code C++&gt;
UmbraEngine engine;
engine.activateModule(UMBRA_INTERNAL_SPEEDOMETER);
&lt;/code&gt;
!See also:
:[[UmbraEngine::displayError]]</pre>
</div>
<div title="UmbraKey" modifier="Mingos" created="201008112301" modified="201008191658" tags="api class callback" changecount="6">
<pre>The ~UmbraKey class serves the sole purpose of recording a key combination in an easy and readable way. It stores the information necessary to represent any simple keystroke combination, such as {{{alt}}} + {{{enter}}}, etc.

Objects of this type are used inside the [[UmbraCallback]].
!Keystroke comparison
~UmbraKey provides a way to compare two keystroke combinations using a single overloaded operator:
&lt;code C++&gt;
UmbraKey k1(TCODK_ENTER,0,true,false,false);
UmbraKey k2(TCODK_F4,0,true,false,false);
UmbraKey k3(TCODK_F4,0,true,false,false);
if (k1 == k2) std::cout &lt;&lt; &quot;Same!&quot; &lt;&lt; std::endl;
else std::cout &lt;&lt; &quot;Different!&quot; &lt;&lt; std::endl;
if (k2 == k3) std::cout &lt;&lt; &quot;Same!&quot; &lt;&lt; std::endl;
else std::cout &lt;&lt; &quot;Different!&quot; &lt;&lt; std::endl;
&lt;/code&gt;
!!!Output:
{{{Different!}}}
{{{Same!}}}</pre>
</div>
<div title="UmbraKey::UmbraKey" modifier="Mingos" created="201008112308" modified="201008112314" tags="api method keyClass constructor" changecount="3">
<pre>!Description
Constructor for a keystroke object.
!Construction
&lt;code C++&gt;
UmbraKey () {
    vk = TCODK_NONE;
    c = 0;
    alt = false;
    ctrl = false;
    shift = false;
}
&lt;/code&gt;
&lt;code C++&gt;
UmbraKey (TCOD_keycode_t vk, char c, bool alt, bool ctrl, bool shift) {
    this-&gt;vk = vk;
    this-&gt;c = c;
    this-&gt;alt = alt;
    this-&gt;ctrl = ctrl;
    this-&gt;shift = shift;
}
&lt;/code&gt;
!Parametres
*{{{TCOD_keycode_t vk}}}: a key code, as defined in [[libtcod documentation|http://doryen.eptalys.net/data/libtcod/doc/1.5.0/console/keycode_t.html]]
*{{{char c}}}: a printable character. A value of {{{0}}} means &quot;no character&quot;.
*{{{bool alt}}}: {{{true}}} for {{{alt}}} key pressed, {{{false}}} otherwise.
*{{{bool ctrl}}}: {{{true}}} for {{{ctrl}}} key pressed, {{{false}}} otherwise.
*{{{bool shift}}}: {{{true}}} for {{{shift}}} key pressed, {{{false}}} otherwise.
!Example
&lt;code C++&gt;
//alt + enter
UmbraKey key(TCODK_ENTER,0,true,false,false);
&lt;/code&gt;</pre>
</div>
<div title="UmbraKey::assign" modifier="Mingos" created="201008132308" modified="201008152229" tags="api method keyClass" changecount="4">
<pre>!Description
Stores a keystroke combination.
!Construction
&lt;code C++&gt;
void assign (
    TCOD_keycode_t vk,
    char c,
    bool alt,
    bool ctrl,
    bool shift
);
&lt;/code&gt;
!Parametres
*{{{TCOD_keycode_t vk}}}: a key code, as defined in [[libtcod documentation|http://doryen.eptalys.net/data/libtcod/doc/1.5.0/console/keycode_t.html]]
*{{{char c}}}: a printable character. A value of {{{0}}} means &quot;no character&quot;.
*{{{bool alt}}}: {{{true}}} for {{{alt}}} key pressed, {{{false}}} otherwise.
*{{{bool ctrl}}}: {{{true}}} for {{{ctrl}}} key pressed, {{{false}}} otherwise.
*{{{bool shift}}}: {{{true}}} for {{{shift}}} key pressed, {{{false}}} otherwise.
!Remarks
Should it be necessary to copy the contents of one UmbraKey object to another, it is best to use the {{{=}}} operator:
&lt;code C++&gt;
UmbraKey key1(TCODK_ENTER,0,true,false,false);
UmbraKey key2 = key1;
&lt;/code&gt;</pre>
</div>
<div title="UmbraKey::operator ==" modifier="Mingos" created="201008160956" modified="201008160957" tags="api operator keyClass" changecount="2">
<pre>!Description
Compares the keystrokes stored in two instances of the UmbraKey class.
!Example
&lt;code C++&gt;
UmbraKey k1(TCODK_ENTER,0,true,false,false);
UmbraKey k2 = k1;
UmbraKey k3(TCODK_F4,0,true,false,false);
printf(&quot;k1 == k2? %s\n&quot;, k1 == k2 ? &quot;true&quot; : &quot;false&quot;);
printf(&quot;k2 == k3? %s\n&quot;, k2 == k3 ? &quot;true&quot; : &quot;false&quot;);
&lt;/code&gt;
!!!Output
{{{k1 == k2? true}}}
{{{k2 == k3? false}}}
</pre>
</div>
<div title="UmbraKeyMethods" modifier="Mingos" created="201008111915" tags="methodlist" changecount="1">
<pre>*[[UmbraKey::assign]]
*[[UmbraKey::UmbraKey]]</pre>
</div>
<div title="UmbraKeyboardMode" modifier="Mingos" created="201007252205" modified="201007271728" tags="api enum keyboard keyboardMode" changecount="7">
<pre>!Description
Keyboard modes are the ways in which Umbra reacts to keyboard input.
!Construction
&lt;code C++&gt;
enum UmbraKeyboardMode {
    UMBRA_KEYBOARD_WAIT,
    UMBRA_KEYBOARD_WAIT_NOFLUSH,
    UMBRA_KEYBOARD_RELEASED,
    UMBRA_KEYBOARD_PRESSED,
    UMBRA_KEYBOARD_PRESSED_RELEASED
};
&lt;/code&gt;
!Values
*{{{UMBRA_KEYBOARD_WAIT}}}: Main loop only executes after some keyboard input has been detected (for turn-based games).
*{{{UMBRA_KEYBOARD_WAIT_NOFLUSH}}}: Same as above, but without flushing the keyboard events.
*{{{UMBRA_KEYBOARD_RELEASED}}}: React only to key release events.
*{{{UMBRA_KEYBOARD_PRESSED}}}: React only to key press events.
*{{{UMBRA_KEYBOARD_PRESSED_RELEASED}}}: React to both key press and key release events.</pre>
</div>
<div title="UmbraModule" modifier="Mingos" created="200910241828" modified="201008050918" tags="api class module" changecount="39">
<pre>UmbraModule is a single &quot;chunk&quot; of the game, with its own renderer and keybindings. It might be the main menu, the character creation screen, the overworld view, the trading screen or whatever might need a separate view. Modules might also be sub-screens like dialogs or widgets (the inventory dialog for example). Finally, modules can be some non-visual game logic one might want to easily enable or disable. In that case, it's only necessary override the {{{update()}}} method and leave an empty {{{render()}}} method.

By default, an activated module will do nothing. It will simply stay there in memory until it's deactivated. Features can be added to it to it by overriding some of its methods:

The [[UmbraModule::initialise]] is called only once: when the module is activated for the first time. All costly resource loading stuff like bitmap loading can be put there.

Modules can be activated by calling one of the [[UmbraEngine::activateModule]] functions. The [[UmbraModule::activate]] is called each time the module is activated. It's possible to reset some internal data in this function.

A module is deactivated when its {{{update()}}} function returns false or when the [[UmbraEngine::deactivateModule]] function is called. The [[UmbraModule::deactivate]] function is called each time the module is deactivated. Module termination code should be placed there.

The main Umbra game loop has 3 phases:
# Control management
# World updating
# World rendering
* During the control management phase, [[UmbraModule::keyboard]] and [[UmbraModule::mouse]] methods are called for each active module.
* During the world updating phase, [[UmbraModule::update]] is called for each active module. In this function, the module can activate or deactivate other modules using [[UmbraEngine::activateModule]] and [[UmbraEngine::deactivateModule]] methods. The updated module can deactivate itself by returning false in this method.
* During the render phase, [[UmbraModule::render]] is called for each active module.
!Methods
&lt;&lt;tiddler UmbraModuleMethods&gt;&gt;</pre>
</div>
<div title="UmbraModule::activate" modifier="Mingos" created="201003312325" modified="201007272143" tags="api method module moduleClass autoCalling" changecount="13">
<pre>!Description
Custom code executed upon module activation.
!Construction
&lt;code C++&gt;
virtual void activate (
);
&lt;/code&gt;
!Remarks
This method will be called automatically whenever the module containing it is activated. It cannot be called manually.
It will typically contain code such as the activation of other modules (for instance, main game view may internally activate a message log).
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::deactivate" modifier="Mingos" created="201003312327" modified="201007272256" tags="api method module moduleClass autoCalling" changecount="11">
<pre>!Description
Custom code executed upon module deactivation.
!Construction
&lt;code C++&gt;
virtual void deactivate (
);
&lt;/code&gt;
!Remarks
This method will be called automatically whenever the module containing it is deactivated. It cannot be called manually.
It will typically contain code such as the deactivation of other modules (for instance, main game view may internally deactivate a message log).
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getActive" modifier="Mingos" created="201004011546" modified="201008031452" tags="api method moduleClass moduleStatus" changecount="8">
<pre>!Description
Checks whether the module is active.
!Construction
&lt;code C++&gt;
bool getActive (
);
&lt;/code&gt;
!Return value
{{{bool}}}: {{{true}}} if the module is active, {{{false}}} otherwise.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getEngine" modifier="Mingos" created="201004021259" modified="201007272300" tags="api method moduleClass engine engineReference" changecount="12">
<pre>!Description
Provides a pointer to the engine.
!Construction
&lt;code C++&gt;
UmbraEngine * getEngine (
);
&lt;/code&gt;
!Return value
{{{UmbraEngine*}}}: a pointer to the engine.
!Remarks:
This method is included in the {{{UmbraModule}}} to make communication with the game engine easier. Using it enables you to call the engine's methods from within the module (for instance, module activation).
!Example
&lt;code C++&gt;
void MyModule::keyboard (TCOD_ket_t &amp;key) {
    if (key.vk == TCODK_ESCAPE) {
        getEngine()-&gt;deactivateAll();
    }
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;engineReference&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getFallback" modifier="Mingos" created="201008111852" modified="201008111854" tags="api method moduleClass fallback" changecount="2">
<pre>!Description
Fetched the ID number of the module's fallback.
!Construction
&lt;code C++&gt;
int getFallback (
);
&lt;/code&gt;
!Return value:
{{{int}}}: fallback module's ID number. In case there is no fallback, the method will return (-1).
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getPause" modifier="Mingos" created="201004011545" modified="201008111853" tags="api module moduleClass moduleStatus" changecount="10">
<pre>!Description
Checks whether the module is paused.
!Construction
&lt;code C++&gt;
bool getPause (
);
&lt;/code&gt;
!Return value:
{{{bool}}}: {{{true}}} if the module is paused, {{{false}}} otherwise.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getPriority" modifier="Mingos" created="201008111904" tags="api method moduleClass priority" changecount="1">
<pre>!Description
Checks whether the module is active.
!Construction
&lt;code C++&gt;
int getPriority (
);
&lt;/code&gt;
!Return value
{{{int}}}: The module's priority.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;priority&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;priority&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::getStatus" modifier="Mingos" created="201008111909" tags="api method moduleClass moduleStatus" changecount="1">
<pre>!Description
Retrieves the module's current status.
!Construction
&lt;code C++&gt;
UmbraModuleStatus getStatus (
);
&lt;/code&gt;
!Return value:
{{{UmbraModuleStatus}}}: the module's current status. The values are defined in the [[UmbraModuleStatus]] enum.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::initialise" modifier="Mingos" created="201003312342" modified="201007272256" tags="api method module moduleClass autoCalling" changecount="12">
<pre>!Description
Custom code executed at module initialisation.
!Construction
&lt;code C++&gt;
virtual void initialise (
);
&lt;/code&gt;
!Remarks
This method will be called automatically when the module is activated for the first time. It shall be called once and only once.
It may contain any code, typically some resource allocation which cannot be done in the module's constructor.
Should memory be allocated in this method, it is wise to deallocate it in the destructor.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::keyboard" modifier="Mingos" created="201003312316" modified="201007272257" tags="api method moduleClass keyboard input autoCalling" changecount="12">
<pre>!Description
Handles keyboard input.
!Construction
&lt;code C++&gt;
virtual void keyboard (
    TCOD_key_t &amp;key
);
&lt;/code&gt;
!Parametres
:{{{TCOD_key_t &amp;key}}}: address of the {{{TCOD_key_t}}} variable, catching keyboard input.
!Remarks
This method will be called automatically each frame. It shouldn't be called manually, but rather overloaded in each module.
You should put only what's relevant to the given module in this method. Each module may react to different keybindings.
It is a good idea to zero the {{{key}}} variable out in case a relevant keystroke is detected so that modules with a lower priority don't parse the same keystroke again.
!Example:
&lt;code C++&gt;
void MyModule::keyboard (TCOD_key_t &amp;key) {
    if (key.vk == TCODK_SPACE) {
        doSomething();
        key.vk = TCODK_NONE;
    }
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::mouse" modifier="Mingos" created="201003312321" modified="201007272259" tags="api method moduleClass mouse input autoCalling" changecount="11">
<pre>!Description
Handles mouse input.
!Construction
&lt;code C++&gt;
virtual void mouse (
    TCOD_mouse_t &amp;ms
);
&lt;/code&gt;
!Parametres
*{{{TCOD_mouse_t &amp;ms}}}: address of the {{{TCOD_mouse_t}}} variable that collects mouse events.
!Remarks
This method will be called automatically each frame. It shouldn't be called manually, but rather overloaded in each module.
It is a good idea to zero the {{{ms}}} variable out in case some relevant input (usually a click in a given area) is parsed, otherwise modules with a lower priority will try to parse the same input.
!Example:
&lt;code C++&gt;
void MyModule::mouse (TCOD_mouse_t &amp;ms) {
    if (ms.lbutton) {
        doSomething();
        ms.lbutton = 0;
    }
}
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;input&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::pause" modifier="Mingos" created="201003312330" modified="201007272256" tags="api method module moduleClass autoCalling" changecount="11">
<pre>!Description
Custom code executed upon module pausing.
!Construction
&lt;code C++&gt;
virtual void pause (
);
&lt;/code&gt;
!Remarks
This method will be called automatically whenever the module containing it is paused. It cannot be called manually.
It may contain any code, for instance, pausing the background music.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::render" modifier="Mingos" created="201003312308" modified="201008111844" tags="api method moduleClass render autoCalling" changecount="9">
<pre>!Description
Handles module rendering on the screen.
!Construction
&lt;code C++&gt;
virtual void render (
);
&lt;/code&gt;
!Remarks
This method will be called automatically each frame. It shouldn't be called manually, but rather overloaded in each module.</pre>
</div>
<div title="UmbraModule::resume" modifier="Mingos" created="201003312331" modified="201007272256" tags="api method module moduleClass autoCalling" changecount="10">
<pre>!Description
Custom code executed upon module unpausing.
!Construction
&lt;code C++&gt;
virtual void resume (
    void
);
&lt;/code&gt;
!Remarks
This method will be called automatically whenever the module containing it is unpaused. It cannot be called manually.
It may contain any code, for instance, unpausing the background music.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;autoCalling&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::setActive" modifier="Mingos" created="201004011536" modified="201007272301" tags="api method moduleClass moduleStatus" changecount="10">
<pre>!Description
Activates or deactivates the module.
!Construction
&lt;code C++&gt;
void setActive (
    bool active
);
&lt;/code&gt;
!Parametres
*{{{bool active}}}: a value of {{{true}}} tells the method to activate the module. A value of {{{false}}} deactivates the module.
!Remarks
Note that when a module is activated or deactivated, [[UmbraModule::activate]] or [[UmbraModule::deactivate]], respectively, are called in the following iteration of the main application loop.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;moduleStatus&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::setFallback" modifier="Mingos" created="201004011604" modified="201007272301" tags="api method module moduleClass fallback" changecount="6">
<pre>!Description
Sets the fallback module (the module that will be activated when the current one is deactivated).
!Construction
&lt;code C++&gt;
void setFallback (
    int fback
);
&lt;/code&gt;
!Parametres
*{{{int fback}}}: the ID number of the fallback module. 
!Remarks
When the module is deactivated, the module with ID number specified as the argument to {{{UmbraModule::setFallback}}} will be activated.
The ID number of the fallback module is the number returned by [[UmbraEngine::registerModule]].
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;fallback&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraModule::setPause" modifier="Mingos" created="201004011543" modified="201007271830" tags="api method moduleClass moduleStatus" changecount="12">
<pre>!Description
Pauses or unpauses the module.
!Construction
&lt;code C++&gt;
void setPause (
    bool paused
);
&lt;/code&gt;
!Parametres
{{{bool paused}}}: {{{true}}} pauses the module, {{{false}}} unpauses it.
!Remarks
Note that when a module is paused or unpaused, [[UmbraModule::pause]] or [[UmbraModule::resume]], respectively, are called in the following iteration of the main application loop.</pre>
</div>
<div title="UmbraModule::update" modifier="Mingos" created="200911121749" modified="201008111844" tags="api method module moduleClass autoCalling" changecount="11">
<pre>!Description
Updates the module's internal logic.
!Construction
&lt;code C++&gt;
virtual bool update (
);
&lt;/code&gt;
!Return value
{{{bool}}}: the method is expected to return {{{true}}} if the module should remain active in the next main loop iteration, {{{false}}} if it should be deactivated.
!Remarks
:This method will be called automatically each frame. It shouldn't be called manually, but rather overloaded in each module.
:The developer is expected to adhere to the rules concerning the return value. Making the method return a value of {{{false}}} will deactivate the module.</pre>
</div>
<div title="UmbraModuleMethods" modifier="Mingos" created="201007271154" modified="201008031453" tags="methodlist" changecount="4">
<pre>*[[UmbraModule::activate]]
*[[UmbraModule::deactivate]]
*[[UmbraModule::getActive]]
*[[UmbraModule::getEngine]]
*[[UmbraModule::getFallback]]
*[[UmbraModule::getPause]]
*[[UmbraModule::getPriority]]
*[[UmbraModule::getStatus]]
*[[UmbraModule::initialise]]
*[[UmbraModule::keyboard]]
*[[UmbraModule::mouse]]
*[[UmbraModule::pause]]
*[[UmbraModule::render]]
*[[UmbraModule::resume]]
*[[UmbraModule::setActive]]
*[[UmbraModule::setFallback]]
*[[UmbraModule::setPause]]
*[[UmbraModule::update]]</pre>
</div>
<div title="UmbraModuleStatus" modifier="Mingos" created="201007271045" modified="201007271728" tags="api enum module moduleStatus" changecount="6">
<pre>!Description
Identifiers for various module states.
!Construction
&lt;code C++&gt;
enum UmbraModuleStatus {
    UMBRA_UNINITIALISED,
    UMBRA_INACTIVE,
    UMBRA_ACTIVE,
    UMBRA_PAUSED
};
&lt;/code&gt;
!Values
*{{{UMBRA_UNINITIALISED}}}: Modules that haven't yet been initialised will have this state.
*{{{UMBRA_INACTIVE}}}: After initialisation, this status is applied to the modules. It's also applied when a module is deactivated.
*{{{UMBRA_ACTIVE}}}: When a module is activated, it will have this state.
*{{{UMBRA_PAUSED}}}: An active module, if paused, will be marked with this status.</pre>
</div>
<div title="UmbraPoint" modifier="Mingos" created="201007211209" modified="201008191659" tags="api class point mouse" changecount="17">
<pre>The class UmbraPoint is one of the additions to the [[UmbraWidget]] that differentiate it from an [[UmbraModule]]. As the name implies, it defines the behaviour of a single point (or, more accurately, a single cell on the console).

The UmbraPoint is used within every [[UmbraWidget]] to define the behaviour of 2 points: the minimise button and the close button. The method [[UmbraWidget::mouse]], which is supposed to be called in each iteration of the main application loop (see below), will automatically register mouse hover and mouse down events, which may then be used to trigger events such as a rollover, etc.
!Constructor
In order to create a point, one of two constructors may be used. The first one takes no arguments at all:
&lt;code C++&gt;
UmbraPoint p;
&lt;/code&gt;
This will create a point at the position {{{[0,0]}}} of the parent widget. The point's position can be then changed using the [[UmbraPoint::set]] method.

The second constructor addresses the necessity of setting a point's position within a widget and accepts the coordinates as parametres:
&lt;code C++&gt;
UmbraPoint p(10,1);
&lt;/code&gt;
The mouse events are set to false initially.
!Mouse events in a widget
A widget declaration should also contain the mouse parser method declaration:
&lt;code C++&gt;
class MyWidget: public UmbraWidget {
    ...
    void mouse(TCOD_mouse_t &amp;ms);
    ...
};
&lt;/code&gt;
The problem is that the developer shouldn't be forced to think about UmbraPoint and [[UmbraRect]] mouse events updating in each widget separately. That's why [[UmbraWidget]] overrides this method as well and takes care of the mouse events for [[UmbraPoint]]s and [[UmbraRect]]s present par default in every widget.

Unfortunately, this method needs to be called manually. This is done by calling [[UmbraWidget::mouse]] at the beginning of the mouse parsing method:
&lt;code C++&gt;
void MyWidget::mouse(TCOD_mouse_t &amp;ms) {
    UmbraWidget::mouse(ms);
    ...
}
&lt;/code&gt;
This ensures the possibility to write custom mouse code (for instance, when defining additional elements that should react to the mouse) while at the same time retaining the functionality of the default widget elements. For more information, please refer to [[UmbraWidget::mouse]].
!Setting and getting mouse events
The UmbraPoint has two boolean members that are used to indicate the mouse status relative to the point: {{{mouseHover}}} and {{{mouseDown}}}. They are public members, so they can be set and retrieved directly:
&lt;code C++&gt;
UmbraPoint p;
... //some code here
p.mouseHover = false;
if (p.mouseDown) doSomething();
&lt;/code&gt;
The member function [[UmbraPoint::is]] is used for detecting mouse hover - please refer to this method description for additional information.
!Methods
&lt;&lt;tiddler UmbraPointMethods&gt;&gt;
!See also
*[[UmbraRect]]
*[[UmbraWidget]]
*[[UmbraWidget::mouse]]</pre>
</div>
<div title="UmbraPoint::UmbraPoint" modifier="Mingos" created="201008160000" modified="201008160001" tags="api method point constructor" changecount="2">
<pre>!Description
Constructor for a point object.
!Construction
&lt;code C++&gt;
UmbraPoint () {
    x = 0;
    y = 0;
    mouseHover = false;
}
&lt;/code&gt;
&lt;code C++&gt;
UmbraPoint (int x, int y) {
    this-&gt;x = x;
    this-&gt;y = y;
    mouseHover = false;
}
&lt;/code&gt;
!Parametres
*{{{int x}}}: the X coordinate of a point
*{{{int y}}}: the Y coordinate of a point
!Example
&lt;code C++&gt;
UmbraPoint p1;
UmbraPoint p2(10,20);
&lt;/code&gt;</pre>
</div>
<div title="UmbraPoint::is" modifier="Mingos" created="201008152221" modified="201008152336" tags="api method point" changecount="6">
<pre>!Description
Checks whether a given set of coordinates match those of an UmbraPoint object.
!Construction
&lt;code C++&gt;
bool is (
    int px,
    int py
);
&lt;/code&gt;
!Parametres
*{{{int px}}}: the X coordinate to be checked
*{{{int py}}}: the Y coordinate to be checked
!Return value
{{{bool}}}: {{{true}}} if the coordinates match those of the UmbraPoint object, {{{false}}} otherwise.
!Remarks:
This method is typically used to check whether the mouse cursor is hovering over a given point.
Should it be necessary to check the coordinates of two UmbraPoint instances against one another, [[UmbraPoint::operator ==]] provides that functionality.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraPoint::operator ==" modifier="Mingos" created="201008152339" modified="201008152341" tags="api operator point" changecount="5">
<pre>!Description
Compares the coordinates of two UmbraPoint instances.
!Remarks
It only takes the coordinates into consideration. Mouse events are ignored.
!Example
&lt;code C++&gt;
UmbraPoint p1(10,20), p2(10,20), p3(11,21);
printf(&quot;p1 == p2? %s\n&quot;, p1 == p2 ? &quot;true&quot; : &quot;false&quot;);
printf(&quot;p1 == p3? %s\n&quot;, p1 == p3 ? &quot;true&quot; : &quot;false&quot;);
&lt;/code&gt;
!!!Output
{{{p1 == p2? true}}}
{{{p1 == p3? false}}}</pre>
</div>
<div title="UmbraPoint::set" modifier="Mingos" created="201008152328" modified="201008152332" tags="api method point" changecount="3">
<pre>!Description
Sets the coordinates of an UmbraPoint object.
!Construction
&lt;code C++&gt;
void set (
    int x,
    int y
);
&lt;/code&gt;
!Parametres
*{{{int x}}}: the X coordinate to be assigned
*{{{int y}}}: the Y coordinate to be assigned
!Remarks:
Should it be necessary to copy an UmbraPoint instance, the {{{=}}} operator can be used:
&lt;code C++&gt;
UmbraPoint p1(10,20);
UmbraPoint p2 = p1;
&lt;/code&gt;
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;point&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraPointMethods" modifier="Mingos" created="201007271204" modified="201008152348" tags="methodlist" changecount="4">
<pre>*[[UmbraPoint::is]]
*[[UmbraPoint::set]]
*[[UmbraPoint::UmbraPoint]]</pre>
</div>
<div title="UmbraRect" modifier="Mingos" created="201008132227" modified="201008191703" tags="api class rect mouse" changecount="9">
<pre>UmbraRect is one of the additions to UmbraWidget, along with UmbraPoint. It defines a rectangle as well as interactions with the mouse cursor and an UmbraPoint. Every UmbraWidget includes two UmbraRect objects: the [[widget area|Widget area]] and the [[drag zone|Drag zone]].
!Constructor
UmbraRect takes four arguments in the constructor: the [x,y] coordinates of the top left corner, the width and the height. It can be instantiated like this:
&lt;code C++&gt;
UmbraRect rectangle(0,0,UmbraEngine::getInstance-&gt;getRootWidth(),UmbraEngine::getInstance-&gt;getRootHeight());
&lt;/code&gt;
The above code will, of course, create a rectangle that occupies the entire root console's area.

Calling the constructor with no arguments will create a rectangle object as well, but all values default to 0 and thus require to be set manually, for instance using [[UmbraRect::set]].
!Mouse events
In case of the rectangles present in an UmbraWidget par default, the mouse events are interpreted automatically, provided the widget's [[UmbraWidget::mouse]] is overridden correctly. For other uses, it is possible to check whether the mouse cursor is within the rectangle using [[UmbraRect::isInside]]. The generalised code may look like this:
&lt;code C++&gt;
SomeClass::mouse(TCOD_mouse_t &amp;ms) {
    if (rectangle.isInside(ms.cx,ms,cy) {
        rectangle.mouseHover = true;
        if (ms.lbutton) rectangle.mouseDown = true;
        else rectangle.mouseDown = false;
    }
    else rectangle.mouseHover = rectangle.mouseDown = false;
}
&lt;/code&gt;
Using code that's functionally equivalent to the example above makes it possible to use the {{{mouseHover}}} and {{{mouseDown}}} public members of the UmbraRect class:
&lt;code C++&gt;
if (rectangle.mouseHover) doSomething();
if (rectangle.mouseDown) doSomethingMore();
&lt;/code&gt;
!Methods
&lt;&lt;tiddler UmbraRectMethods&gt;&gt;
!See also
*[[UmbraPoint]]
*[[UmbraWidget]]
*[[UmbraWidget::mouse]]</pre>
</div>
<div title="UmbraRect::UmbraRect" modifier="Mingos" created="201008171106" tags="api method rect constructor" changecount="1">
<pre>!Description
Constructor for a rectangle object.
!Construction
&lt;code C++&gt;
UmbraRect () {
    x = 0;
    y = 0;
    w = 0;
    h = 0;
    mouseHover = false;
}
&lt;/code&gt;
&lt;code C++&gt;
UmbraRect (int x, int y, int w, int h) {
    this-&gt;x = x;
    this-&gt;y = y;
    this-&gt;w = w;
    this-&gt;h = h;
    mouseHover = false;
}
&lt;/code&gt;
!Parametres
*{{{int x}}}: the X coordinate of the rectangle's top left corner
*{{{int y}}}: the Y coordinate of the rectangle's top left corner
*{{{int w}}}: the rectangle's width
*{{{int h}}}: the rectangle's height
!Example
&lt;code C++&gt;
UmbraRect r1;
UmbraRect r2(10,20,5,10);
&lt;/code&gt;</pre>
</div>
<div title="UmbraRect::contains" modifier="Mingos" created="201008161317" modified="201008161336" tags="api method rect" changecount="6">
<pre>!Description
Checks whether a given set of coordinates or UmbraPoint instance are within a rectangle.
!Construction
&lt;code C++&gt;
bool contains (
    int px,
    int py
);
&lt;/code&gt;
&lt;code C++&gt;
bool contains (
    const UmbraPoint &amp;p
);
&lt;/code&gt;
!Parametres
*{{{int px}}}: the X coordinate to be checked
*{{{int py}}}: the Y coordinate to be checked
*{{{const UmbraPoint &amp;p}}}: an instance of UmbraPoint to be checked
!Return value
{{{bool}}}: {{{true}}} if the coordinates are within the rectangle, {{{false}}} otherwise.
!Remarks:
This method is typically used to check whether the mouse cursor is hovering over a given rectangle.
!Example
&lt;code C++&gt;
UmbraPoint p1(10,10), p2(20,20);
UmbraRect r(5,5,10,10);
printf(&quot;%s, %s, %s, %s\n&quot;,
    r.contains(p1) ? &quot;true&quot; : &quot;false&quot;,
    r.contains(p2) ? &quot;true&quot; : &quot;false&quot;,
    r.contains(12,12),
    r.contains(18,18)
);
&lt;/code&gt;
!!!Output
{{{true, false, true, false}}}
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraRect::set" modifier="Mingos" created="201008161338" modified="201008171053" tags="api method rect" changecount="2">
<pre>!Description
Sets the top left corner's coordinates, as well as the width and the height of a rectangle.
!Construction
&lt;code C++&gt;
void set (
    int x,
    int y,
    int w,
    int h
);
&lt;/code&gt;
!Parametres
*{{{int x}}}: the X coordinate of the rectangle's top left corner
*{{{int y}}}: the Y coordinate of the rectangle's top left corner
*{{{int w}}}: the rectangle's width
*{{{int h}}}: the rectangle's height
!Remarks:
Should it be necessary to only resize a rectangle, it's more convenient to use [[UmbraRect::setSize]].
In case the rectangle only needs to be moved to a different position, without resizing it, it's best to use [[UmbraRect::setPos]].
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraRect::setPos" modifier="Mingos" created="201008171055" tags="api method rect" changecount="1">
<pre>!Description
Moves the rectangle to a different position.
!Construction
&lt;code C++&gt;
void setPos (
    int x,
    int y
);
&lt;/code&gt;
!Parametres
*{{{int x}}}: the X coordinate of the rectangle's top left corner
*{{{int y}}}: the Y coordinate of the rectangle's top left corner
!Remarks:
This method only changes the rectangle's position (or, more precisely, its top left corner's position), but does not resize it.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraRect::setSize" modifier="Mingos" created="201008171103" tags="api method rect" changecount="1">
<pre>!Description
Resizes a rectangle.
!Construction
&lt;code C++&gt;
void setSize (
    int w,
    int h
);
&lt;/code&gt;
!Parametres
*{{{int w}}}: the rectangle's new width
*{{{int h}}}: the rectangle's new height
!Remarks:
This method only resizes a rectangle, leaving its top left corner at the same position it was at before.
!See also
&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;enum&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;method&quot;])'&gt;&gt;&lt;&lt;forEachTiddler where 'tiddler != context.inTiddler &amp;&amp; tiddler.tags.containsAll([&quot;rect&quot;,&quot;tutorial&quot;])'&gt;&gt;</pre>
</div>
<div title="UmbraRectMethods" modifier="Mingos" created="201007271236" modified="201008161258" tags="methodlist" changecount="4">
<pre>*[[UmbraRect::contains]]
*[[UmbraRect::set]]
*[[UmbraRect::setPos]]
*[[UmbraRect::setSize]]
*[[UmbraRect::UmbraRect]]</pre>
</div>
<div title="UmbraRegisterCallbackFlag" modifier="Mingos" created="201008111252" tags="api flag callback engine" changecount="1">
<pre>!Description
Flags that control which internal callbacks should be registered during engine initialisation.
!Construction
&lt;code C++&gt;
enum UmbraRegisterCallbackFlag {
    UMBRA_REGISTER_NONE       = 0x00000000,
    UMBRA_REGISTER_DEFAULT    = 0x00000001,
    UMBRA_REGISTER_ADDITIONAL = 0x00000010,
    UMBRA_REGISTER_ALL        = 0x11111111
};
&lt;/code&gt;
!Values
*{{{UMBRA_REGISTER_NONE}}}: Register no callbacks.
*{{{UMBRA_REGISTER_DEFAULT}}}: Register only the default callbacks: quit, save screenshot, font switcher, pause and toggle fullscreen. This is the default flag in [[UmbraEngine]] constructor.
*{{{UMBRA_REGISTER_ADDITIONAL}}}: Register additional callback: Speed-o-meter.
*{{{UMBRA_REGISTER_ALL}}}: Register all internal callbacks.
!Example
&lt;code C++&gt;
UmbraEngine engine = UmbraEngine(&quot;data/cfg/umbra.txt&quot;,UMBRA_REGISTER_ALL);
&lt;/code&gt;</pre>
</div>
<div title="UmbraWidgetMethods" modifier="Mingos" created="201007271238" modified="201007271251" tags="methodlist" changecount="3">
<pre>*[[UmbraWidget::mouse]]
*[[UmbraWidget::setDragZone]]</pre>
</div>
<div title="Using Umbra" modifier="Mingos" created="200910241814" modified="201009091735" tags="tutorial" changecount="33">
<pre>#Basics
##[[Starting a project using Umbra]]
##[[Umbra Hello World]]
#Engine
##[[The engine]]
##[[Referencing the engine]]
##[[Engine instantiation versus initialisation]]
##Things to do before initialising the engine
###[[Registering modules]]
###[[Registering fonts]]
###[[Font autodetection]]
###[[Activating modules]]
#Modules and widgets
##[[What is a module]]
##[[What is a widget]]
##[[Creating a module]]
##[[Module ID]]
##[[Fallbacks]]
##[[Creating a widget]]
##Internal modules
###[[Speed-o-meter]]
###[[BSOD]]
##[[Accessing modules and widgets]]
##[[Initialisation versus activation]]
##[[Module priority]]
##Input handling
###[[Keyboard input]]
###[[Mouse input in modules]]
###[[Mouse input in widgets]]
####[[Minimise and close buttons]]
####[[Widget area]]
####[[Drag zone]]
#Callbacks
##[[What are callbacks]]
##[[Creating a callback]]
##[[Using a callback]]
##[[Internal callbacks]]
#Errors
##[[Error log]]
##[[Reporting an error]]
##[[Displaying an error]]</pre>
</div>
<div title="Using a callback" modifier="Mingos" created="201008111219" tags="tutorial callback" changecount="1">
<pre>Once a callback is [[created|Creating a callback]], starting to use it is extremely easy. The callback only needs to be registered in the engine:
&lt;code C++&gt;
UmbraEngine::getInstance()-&gt;registerCallback(new MyCallback());
&lt;/code&gt;
Starting from this point, the callback is active and listens to the incoming keystrokes.</pre>
</div>
<div title="What are callbacks" modifier="Mingos" created="201008020014" modified="201008020039" tags="tutorial callback" changecount="4">
<pre>Callbacks are basically global keybindings. The engine provides a listener that will listen to all the registered callbacks and trigger a custom action for each callback in case the listener determines its keybinding has been used.

In order to use a callback, an object of type [[UmbraCallback]] will need to be [[created|Creating a callback]] and [[registered|Using a callback]] in the engine.

Please check the list of [[predefined callbacks|Callbacks]] to see whether the keybinding you would like to create hasn't been created already.</pre>
</div>
<div title="What is a module" modifier="Mingos" created="200911121549" modified="201007252134" tags="tutorial module" changecount="5">
<pre>From the general point of view, a module is a &quot;chunk&quot; of an application that can be clearly separated from the others. For instance, a single screen, such as a menu or a credits screen, will typically be a module. The developer should understand a module as ''a class derived from [[UmbraModule]]'', ie, one that inherits [[UmbraModule]].

Each module has its own set of typical methods that the engine can call, the most important ones being:
#[[UmbraModule::update]]
#[[UmbraModule::render]]
#[[UmbraModule::keyboard]]
#[[UmbraModule::mouse]]
The first of the four is used to update the module's internal logic. For instance, a main map view in a real time roguelike game will update the mobs' position on the map, adjust their reactions towards the player character, calculate their attacks and so on.

The rendering method will represent the above data graphically, ie, will print the map view on the screen, with the mob positions updated, etc.

The next two methods take care of player input. Mouse status and pressed keys will be parsed and correct actions will be taken if a specified input is encountered.

All of the above are absolutely independent from other modules. Modules can be rendered on top of each other, so there can be multiple active modules at all times. For instance, one might prefer to make the message display a separate module, while keeping the map in a different one.

There's also a special kind of module, called widget, that offers extra interactivity. See [[What is a widget]] for more details.</pre>
</div>
<div title="What is a widget" modifier="Mingos" created="200911122041" modified="201007252134" tags="tutorial module widget" changecount="2">
<pre>A widget is, essentially, a module. It inherits the [[UmbraModule]] class, so it can be updated and rendered in the exact same fashion a standard module would. The difference is that a widget offers additional interactivity options.

Widgets include special areas that can be defined to make the widget become interactive. Per default, a widget has a drag zone, a close button and a minimise button. If they are given legal values, they can be shown in the widget, and also react to mouse movement and clicks.

It is not recommended to use widgets in games that only use keyboard control, since they are slower than normal modules and will be able to offer the same functionality.</pre>
</div>
<div title="registerFont should look in the default font directory" modifier="Mingos" created="201010051104" modified="201010051104" tags="issueTracker RFE open" changecount="2">
<pre>The [[UmbraEngine::registerFont]] method currently only accepts the filename with full path. It should also accept the filename with no path and look in the default fonts directory.</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->
<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[
//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

// Adaptors
config.adaptors = {};
config.defaultAdaptor = null;

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkIncrementalSearch: true,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayInstrumentation: false,
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8",
	txtTheme: ""
	};
config.optionsDesc = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","sync","importTask","tweak","upgrade","plugins"];

// Extensions
config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {defaultView: "text"},
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "http://www.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: config.userAgent.indexOf("gecko") != -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true;}
	],
	currBrowser: null,
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields syncing permalink references jump|\n|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|'
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki", action: saveChanges},
	sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	upgrade: {text: "upgrade", tooltip: "Upgrade TiddlyWiki core code", content: '<<upgrade>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtTheme: "Name of the theme to use",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#Download for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<\%0>>",
	macroErrorDetails: "Error while executing macro <<\%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'}
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	openError: "There were problems fetching the tiddlywiki file",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.upgrade,{
	wizardTitle: "Upgrade TiddlyWiki core code",
	step1Title: "Update or repair this TiddlyWiki to the latest release",
	step1Html: "You are about to upgrade to the latest release of the TiddlyWiki core code (from <a href='%0' class='externalLink' target='_blank'>%1</a>). Your content will be preserved across the upgrade.<br><br>Note that core upgrades have been known to interfere with older plugins. If you run into problems with the upgraded file, see <a href='http://www.tiddlywiki.org/wiki/CoreUpgrades' class='externalLink' target='_blank'>http://www.tiddlywiki.org/wiki/CoreUpgrades</a>",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
	});

merge(config.macros.sync,{
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Server Type', field: 'serverType', title: "Server type", type: 'String'},
			{name: 'Server Host', field: 'serverHost', title: "Server host", type: 'String'},
			{name: 'Server Workspace', field: 'serverWorkspace', title: "Server workspace", type: 'String'},
			{name: 'Status', field: 'status', title: "Synchronisation status", type: 'String'},
			{name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
			],
		rowClasses: [
			],
		buttons: [
			{caption: "Sync these tiddlers", name: 'sync'}
			]},
	wizardTitle: "Synchronize with external servers and files",
	step1Title: "Choose the tiddlers you want to synchronize",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	syncLabel: "sync",
	syncPrompt: "Sync these tiddlers",
	hasChanged: "Changed while unplugged",
	hasNotChanged: "Unchanged while unplugged",
	syncStatusList: {
		none: {text: "...", display:null, className:'notChanged'},
		changedServer: {text: "Changed on server", display:null, className:'changedServer'},
		changedLocally: {text: "Changed while unplugged", display:null, className:'changedLocally'},
		changedBoth: {text: "Changed while unplugged and on server", display:null, className:'changedBoth'},
		notFound: {text: "Not found on server", display:null, className:'notFound'},
		putToServer: {text: "Saved update on server", display:null, className:'putToServer'},
		gotFromServer: {text: "Retrieved update from server", display:null, className:'gotFromServer'}
		}
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.syncing,{
	text: "syncing",
	tooltip: "Control synchronisation of this tiddler with a server or external file",
	currentlySyncing: "<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</"+"div><div>host: <span class='popupHighlight'>%1</span></"+"div><div>workspace: <span class='popupHighlight'>%2</span></"+"div>", // Note escaping of closing <div> tag
	notCurrentlySyncing: "Not currently syncing",
	captionUnSync: "Stop synchronising this tiddler",
	chooseServer: "Synchronise this tiddler with another server:",
	currServerMarker: "\u25cf ",
	notCurrServerMarker: "  "});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://www.tiddlywiki.com/",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
	});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = (config.browser.isSafari || config.browser.isOpera) && (document.location.toString().substr(0,4) != "http");

// Starting up
function main()
{
	var t10,t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	jQuery.noConflict();
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	loadShadowTiddlers();
	jQuery().trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea","store",true);
	jQuery().trigger("loadTiddlers");
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins();
	jQuery().trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params,"onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = !readOnly;
	t6 = new Date();
	for(var m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2-t1) + " ms");
		displayMessage("LoadFromDiv " + (t3-t2) + " ms");
		displayMessage("LoadPlugins " + (t5-t4) + " ms");
		displayMessage("Macro init " + (t7-t6) + " ms");
		displayMessage("Notify " + (t8-t7) + " ms");
		displayMessage("Restart " + (t9-t8) + " ms");
		displayMessage("Total: " + (t10-t0) + " ms");
	}
	startingUp = false;
	jQuery().trigger("startup");
}

// Called on unload. All functions called conditionally since they themselves may have been unloaded.
function unload()
{
	if(window.checkUnsavedChanges)
		checkUnsavedChanges();
	if(window.scrubNodes)
		scrubNodes(document.body);
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
	delete shadows;
}

function loadPlugins()
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers("systemConfig");
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name;
		if(n)
			map[n] = p;
		n = p.Source;
		if(n)
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++)
		visit(installedPlugins[i]);
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0],10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1],10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2],10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);
			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		} else {
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURIComponent(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var i=1; i<params.length; i++) {
		var p = config.paramifiers[params[i].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[i].value);
		else {
			var h = config.optionHandlers[params[i].name.substr(0,3)];
			if(h && h.set instanceof Function)
				h.set(params[i].name,params[i].value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		if(!readOnly || store.tiddlerExists(v) || store.isShadowTiddler(v))
			story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers("[tag["+v+"]]"),null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly) {
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(v) {
		story.switchTheme(v);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent= {
	onstart: function(v) {
		var titles=[];
		var tiddlers=store.getTiddlers("modified","excludeLists").reverse();
		for(var i=0; i<v && i<tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null,titles);
	}
};

config.paramifiers.filter = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers(v),null,false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},

	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if(s=="bgcolor")
				s = "backgroundColor";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1 || link.indexOf("#")!=-1) {
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow");
					theRow.onmouseover = function() {addClass(this,"hoverRow");};
					theRow.onmouseout = function() {removeClass(this,"hoverRow");};
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if(!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?|<hr ?/?>\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w)
	{
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w)
	{
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,decodeURIComponent(link),false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,decodeURIComponent(text),false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.unWikiLink+"?"+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink) {
			w.outputText(w.output,w.matchStart+1,w.nextMatch);
			return;
		}
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				addClass(e,"imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3]) {
				img.title = lookaheadMatch[3];
				img.setAttribute("alt",lookaheadMatch[3]);
			}
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if(styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		var t0 = new Date();
		wikifier.subWikify(output);
		if(tiddler && config.options.chkDisplayInstrumentation)
			displayMessage("wikify:" +tiddler.title+ " in " + (new Date()-t0) + " ms");
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"pre");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		if(!tiddler)
			tiddler = new Tiddler("temp");
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikify(e);
		html = e.innerHTML;
		removeNode(e);
	}
	return html;
}

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = getPlainText(e);
	removeNode(e);
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	try {
		if(terminator)
			this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.version.handler = function(place)
{
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] || "all";
	var list = document.createElement("ul");
	place.appendChild(list);
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		createTiddlyLink(li,typeof results[t] == "string" ? results[t] : results[t].title,true);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.list.filter.handler = function(params)
{
	var filter = params[1];
	var results = [];
	if(filter) {
		var tiddlers = store.filterTiddlers(filter);
		for(var t=0; t<tiddlers.length; t++)
			results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
	}
};

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] || "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	var dateFormat = params[2] || this.dateFormat;
	for(var t=tiddlers.length-1; t>=last; t--) {
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay) {
			var ul = document.createElement("ul");
			place.appendChild(ul);
			createTiddlyElement(ul,"li",null,"listTitle",tiddler[field].formatString(dateFormat));
			lastDay = theDay;
		}
		createTiddlyElement(ul,"li",null,"listLink").appendChild(createTiddlyLink(place,tiddler.title,true));
	}
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("name",null,true,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className);
	if(!args) {
		wrapper.setAttribute("refresh","content");
		wrapper.setAttribute("tiddler",tiddlerName);
	}
	var text = store.getTiddlerText(tiddlerName);
	if(text) {
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.indexOf(tiddlerName) !== -1)
			return;
		stack.push(tiddlerName);
		try {
			var n = args ? Math.min(args.length,9) : 0;
			for(var i=0; i<n; i++) {
				var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
				text = text.replace(placeholderRE,args[i]);
			}
			config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
		} finally {
			stack.pop();
		}
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params)
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0],null,params[1],params[2]);
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++) {
		var tag = store.getTiddler(tiddler.tags[t]); 
		if(!tag || !tag.tags.contains("excludeLists")) { 
			createTagButton(createTiddlyElement(ul,"li"),tiddler.tags[t],tiddler.title);
			if(t<tiddler.tags.length-1)
				createTiddlyText(ul,sep);
		}
	}
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	ul.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(ul,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place,macroName,params)
{
	if(!readOnly)
		createTiddlyButton(place,params[0] || this.label,params[1] || this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev)
{
	var e = ev || window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var c = cookie || "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var panel = wikifier ? createTiddlyElement(place,"div",null,"gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	params = paramString.parseParams("color");
	var locolors = [], hicolors = [];
	for(var t=2; t<params.length; t++) {
		var c = params[t].value;
		if(params[t].name == "snap") {
			hicolors[hicolors.length-1] = c;
		} else {
			locolors.push(c);
			hicolors.push(c);
		}
	}
	drawGradient(panel,params[1].value != "vert",locolors,hicolors);
	if(wikifier)
		wikifier.subWikify(panel,">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var names = params[0].split(".");
		var lookupMessage = function(root,nameIndex) {
				if(names[nameIndex] in root) {
					if(nameIndex < names.length-1)
						return (lookupMessage(root[names[nameIndex]],nameIndex+1));
					else
						return root[names[nameIndex]];
				} else
					return null;
			};
		var m = lookupMessage(config,0);
		if(m == null)
			m = lookupMessage(window,0);
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};


config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value,place,highlightHack,tiddler);
	},
	link: function(value,place,params,wikifier,paramString,tiddler) {
		createTiddlyLink(place,value,true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if(params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value,place,highlightHack,tiddler);
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value) {
			var type = params[1] || config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if(handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if(field != "text" && !rows) {
			e = createTiddlyElement(null,"input");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.setAttribute("edit",field);
			e.setAttribute("type","text");
			e.value = store.getValue(tiddler,field) || defVal;
			e.setAttribute("size","40");
			e.setAttribute("autocomplete","off");
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			e = createTiddlyElement(wrapper2,"textarea");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.value = v = store.getValue(tiddler,field) || defVal;
			rows = rows || 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev)
{
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));
	if(tags.length == 0)
		jQuery("<li/>").text(lingo.popupNone).appendTo(jQuery(popup));
	for(var t=0; t<tags.length; t++) {
		var tag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag",tags[t][0]);
		tag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev)
{
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",tiddler.title);
		btn.setAttribute("tags",params[0]);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	for(var t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined)
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title,"text"))
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick,"searchButton");
	var txt = createTiddlyElement(null,"input",null,"txtOptionInput searchField");
	if(params[0])
		txt.value = params[0];
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
	place.appendChild(txt);
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",params[1] || this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev)
{
	var e = ev || window.event;
	switch(e.keyCode) {
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			config.macros.search.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(config.macros.search.timeout)
					clearTimeout(config.macros.search.timeout);
				var txt = this;
				config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
			}
		} else {
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
		}
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,"tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			removeNode(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
		}
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,className)
{
	if(typeof commandName != "string") {
		var c = null;
		for(var t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd;
			switch(command.type) {
			case "popup":
				cmd = this.onClickPopup;
				break;
			case "command":
			default:
				cmd = this.onClickCommand;
				break;
			}
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			addClass(btn,"command_" + commandName);
			if(className)
				addClass(btn,className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyText || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyTooltip || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	var tiddler = store.fetchTiddler(title);
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,className,event)
{
	var children = place.getElementsByTagName("a");
	for(var t=0; t<children.length; t++) {
		var c = children[t];
		if(hasClass(c,className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev)
{
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++) {
		var c = params[t];
		switch(c) {
		case "!":
			createTiddlyText(place,this.separator);
			break;
		case "*":
			createTiddlyElement(place,"br");
			break;
		case "<":
			var btn = createTiddlyButton(place,this.lessLabel,this.lessPrompt,config.macros.toolbar.onClickLess);
			addClass(btn,"lessCommand");
			break;
		case ">":
			var btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
			addClass(btn,"moreCommand");
			var e = createTiddlyElement(place,"span",null,"moreCommand");
			e.style.display = "none";
			place = e;
			break;
		default:
			var className = "";
			switch(c.substr(0,1)) {
			case "+":
				className = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				className = "cancelCommand";
				c = c.substr(1);
				break;
			}
			if(c in config.commands)
				this.createCommand(place,c,tiddler,className);
			break;
		}
	}
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	story.focusTiddler(title,config.options.txtEditorFocus||"text");
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if(config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if(deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	for(var r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyElement(popup,"li",null,"disabled",this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.syncing.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var serverType = tiddler.getServerType();
	var serverHost = tiddler.fields["server.host"];
	var serverWorkspace = tiddler.fields["server.workspace"];
	if(!serverWorkspace)
		serverWorkspace = "";
	if(serverType) {
		var e = createTiddlyElement(popup,"li",null,"popupMessage");
		e.innerHTML = config.commands.syncing.currentlySyncing.format([serverType,serverHost,serverWorkspace]);
	} else {
		createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.notCurrentlySyncing);
	}
	if(serverType) {
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var btn = createTiddlyButton(createTiddlyElement(popup,"li"),this.captionUnSync,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type","");
	}
	createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
	createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.chooseServer);
	var feeds = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<feeds.length; t++) {
		var f = feeds[t];
		var feedServerType = store.getTiddlerSlice(f.title,"Type");
		if(!feedServerType)
			feedServerType = "file";
		var feedServerHost = store.getTiddlerSlice(f.title,"URL");
		if(!feedServerHost)
			feedServerHost = "";
		var feedServerWorkspace = store.getTiddlerSlice(f.title,"Workspace");
		if(!feedServerWorkspace)
			feedServerWorkspace = "";
		var caption = f.title;
		if(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {
			caption = config.commands.syncing.currServerMarker + caption;
		} else {
			caption = config.commands.syncing.notCurrServerMarker + caption;
		}
		btn = createTiddlyButton(createTiddlyElement(popup,"li"),caption,null,config.commands.syncing.onChooseServer);
		btn.setAttribute("tiddler",title);
		btn.setAttribute("server.type",feedServerType);
		btn.setAttribute("server.host",feedServerHost);
		btn.setAttribute("server.workspace",feedServerWorkspace);
	}
};

config.commands.syncing.onChooseServer = function(e)
{
	var tiddler = this.getAttribute("tiddler");
	var serverType = this.getAttribute("server.type");
	if(serverType) {
		store.addTiddlerFields(tiddler,{
			"server.type": serverType,
			"server.host": this.getAttribute("server.host"),
			"server.workspace": this.getAttribute("server.workspace")
			});
	} else {
		store.setValue(tiddler,"server",null);
	}
	return false;
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var items = [];
	store.forEachField(tiddler,function(tiddler,fieldName,value){items.push({field:fieldName,value:value});},true);
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = "";
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	for(var i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c,10) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function()
{
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changeCount = this.fields['changecount'];
	if(changeCount === undefined)
		changeCount = 0;
	return changeCount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
	this.assign(title,text,modifier,modified,tags,created,fields);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g,"").
		replace(/\{{3}((?:.|\n)*?)\}{3}/g,"").
		replace(/"""((?:.|\n)*?)"""/g,"").
		replace(/\<nowiki\>((?:.|\n)*?)\<\/nowiki\>/g,"").
		replace(/\<html\>((?:.|\n)*?)\<\/html\>/g,"").
		replace(/\<script((?:.|\n)*?)\<\/script\>/g,"");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var modifier = this.modifier;
	if(!modifier)
		modifier = config.messages.subtitleUnknown;
	var modified = this.modified;
	if(modified)
		modified = modified.toLocaleString();
	else
		modified = config.messages.subtitleUnknown;
	return config.messages.tiddlerLinkTooltip.format([this.title,modifier,modified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki() object contains Tiddler()s
//--

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title)
{
	if(typeof config.shadowTiddlers[title] == "string")
		return config.shadowTiddlers[title];
	else
		return "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0,pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		if(!section)
			return tiddler.text;
		var re = new RegExp("(^!{1,6}" + section.escapeRegExp() + "[ \t]*\n)","mg");
		re.lastIndex = 0;
		var match = re.exec(tiddler.text);
		if(match) {
			var t = tiddler.text.substr(match.index+match[1].length);
			var re2 = /^!/mg;
			re2.lastIndex = 0;
			match = re2.exec(t); //# search for the next heading
			if(match)
				t = t.substr(0,match.index-1);//# don't include final \n
			return t;
		}
		return defaultText;
	}
	if(this.isShadowTiddler(title))
		return this.getShadowTiddlerText(title);
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	var m = this.slicesRE.exec(text);
	while(m) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
		m = this.slicesRE.exec(text);
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for(var i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		tiddler.incChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title,true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		created = created || tiddler.created; // Preserve created date
		this.deleteTiddler(title);
	} else {
		created = created || modified;
		tiddler = new Tiddler();
	}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery().trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var candidates = this.reverseLookup("tags",excludeTag,!!match);
	var results = [];
	for(var t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Returns a list of all tags in use
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
// Returns an array of arrays where [tag][0] is the name of the tag and [tag][1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			var n = true;
			for(var c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					n = false;
					results[c][1]++;
				}
			}
			if(n && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					n = false;
			}
			if(n)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		for(var n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter)
{
	var results = [];
	if(filter) {
		var tiddler;
		var re = /([^\s\[\]]+)|(?:\[([ \w]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;
		var match = re.exec(filter);
		while(match) {
			if(match[1] || match[4]) {
				var title = match[1] || match[4];
				tiddler = this.fetchTiddler(title);
				if(tiddler) {
					results.pushUnique(tiddler);
				} else if(this.isShadowTiddler(title)) {
					tiddler = new Tiddler();
					tiddler.set(title,this.getTiddlerText(title));
					results.pushUnique(tiddler);
				} else {
					results.pushUnique(new Tiddler(title));
				}
			} else if(match[2]) {
				switch(match[2]) {
					case "tag":
						var matched = this.getTaggedTiddlers(match[3]);
						for(var m = 0; m < matched.length; m++)
							results.pushUnique(matched[m]);
						break;
					case "sort":
						results = this.sortTiddlers(results,match[3]);
						break;
				}
			}
			match = re.exec(filter);
		}
	}
	return results;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers,field)
{
	var asc = +1;
	switch(field.substr(0,1)) {
	case "-":
		asc = -1;
		// Note: this fall-through is intentional
		/*jsl:fallthru*/
	case "+":
		field = field.substr(1);
		break;
	}
	if(TiddlyWiki.standardFieldAccess[field])
		tiddlers.sort(function(a,b) {return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);});
	else
		tiddlers.sort(function(a,b) {return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);});
	return tiddlers;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^"+fieldName+"\\.");
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	fieldName = fieldName.toLowerCase();
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	var n,result;
	for(n in t.fields) {
		result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(n in TiddlyWiki.standardFieldAccess) {
		if(n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
		result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
		if(result)
			return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(containerId,idPrefix)
{
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		var id = this.idPrefix + title;
		return id==this.container ? this.idPrefix + "_" + title : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title)
{
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function()
{
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(fn)
{
	var place = this.getContainer();
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
	}
};

Story.prototype.displayDefaultTiddlers = function()
{
	this.displayTiddlers(null,store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,unused,customFields,toggle,animationSrc)
{
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle)
			this.closeTiddler(title,true);
		else
			this.refreshTiddler(title,template,false,customFields);
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
		case "top":
			before = place.firstChild;
			break;
		case "bottom":
			before = null;
			break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.tiddlerId(title),"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields,tiddlerElem);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,tiddlerElem)
{
	var getTiddlerCallback = function(context)
	{
		if(context.status) {
			var t = context.tiddler;
			if(!t.created)
				t.created = new Date();
			if(!t.modified)
				t.modified = t.created;
			store.saveTiddler(t.title,t.title,t.text,t.modifier,t.modified,t.tags,t.fields,true,t.created);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title,null,true);
		}
		context.adaptor.close();
		delete context.adaptor;
	};
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields||{};
	var context = {serverType:tiddler.getServerType()};
	if(!context.serverType)
		return;
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType];
	adaptor.getTiddler(title,context,null,getTiddlerCallback);
	return config.messages.loadingMissingTiddler.format([title,context.serverType,context.host,context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					var tags = [];
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,tags,version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText || text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			tiddlerElem.innerHTML = this.getTemplateForTiddler(title,template,tiddler);
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(tiddlerElem,"isTag");
			else
				removeClass(tiddlerElem,"isTag");
			if(store.tiddlerExists(title)) {
				removeClass(tiddlerElem,"shadow");
				removeClass(tiddlerElem,"missing");
			} else {
				addClass(tiddlerElem, store.isShadowTiddler(title) ? "shadow" : "missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
			forceReflow();
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = createTiddlyElement(place,"div",null,"customFields");
	w.style.display = "none";
	for(var t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function(force)
{
	var e = this.getContainer().firstChild;
	while(e) {
		var template = e.getAttribute("template");
		if(template && e.getAttribute("dirty") != "true") {
			this.refreshTiddler(e.getAttribute("tiddler"),force ? null : template,true);
		}
		e = e.nextSibling;
	}
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	addClass(this, "selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(target && target.nodeName.toLowerCase() != "input" && target.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	}
	return false;
};

Story.prototype.onTiddlerKeyPress = function(ev)
{
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
	case 9: // Tab
		if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
			replaceSelection(target,String.fromCharCode(9));
			consume = true;
		}
		if(config.isOpera) {
			target.onblur = function() {
				this.focus();
				this.onblur = null;
			};
		}
		break;
	case 13: // Ctrl-Enter
	case 10: // Ctrl-Enter on IE PC
	case 77: // Ctrl-Enter is "M" on some platforms
		if(e.ctrlKey) {
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
			consume = true;
		}
		break;
	case 27: // Escape
		blurElement(this);
		config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
		consume = true;
		break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = this.getTiddler(title);
	var e = null;
	if(tiddlerElem ) {
		var children = tiddlerElem.getElementsByTagName("*");
		for(var t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = this.getTiddlerField(title,field);
	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	this.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			removeNode(tiddlerElem);
			forceReflow();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	this.displayTiddlers(null,matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = this.getTiddler(title);
	if(e) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		if(store.fetchTiddler(title)) {
			for(var n in fields) {
				if(store.getValue(title,n) != fields[n]) //# tiddler changed
					return true;
			}
		} else {
			if(store.isShadowTiddler(title) && store.getShadowTiddlerText(title) == fields.text) { //# not checking for title or tags
				return false;
			} else { //# changed shadow or new tiddler
				return true;
			}
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title || title;
		if(!store.tiddlerExists(newTitle))
			newTitle = newTitle.trim();
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.tiddlerId(newTitle);
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		if(store.tiddlerExists(title)) {
			var extendedFields = store.fetchTiddler(title).fields;
		} else {
			extendedFields = merge({},config.defaultCustomFields);
		}
		for(var n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
		}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

Story.prototype.switchTheme = function(theme)
{
	if(safeMode)
		return;

	var isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};

	var getSlice = function(theme,slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme,slice+"ReadOnly") || store.getTiddlerSlice(theme,"Web"+slice);
		r = r || store.getTiddlerSlice(theme,slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator)==0)
			r = theme + r;
		return isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i,name,theme,slice) {
		var newName = getSlice(theme,slice);
		if(name!=newName && store.namedNotifications[i].name==name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i=0; i<config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
		case "PageTemplate":
			config.refresherData.pageTemplate = replaceNotification(i,config.refresherData.pageTemplate,theme,name);
			break;
		case "StyleSheet":
			removeStyleSheet(config.refresherData.styleSheet);
			config.refresherData.styleSheet = replaceNotification(i,config.refresherData.styleSheet,theme,name);
			break;
		case "ColorPalette":
			config.refresherData.colorPalette = replaceNotification(i,config.refresherData.colorPalette,theme,name);
			break;
		default:
			break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme,"ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme,"EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate!=pt || config.tiddlerTemplates[vi]!=vt || config.tiddlerTemplates[ei]!=et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet,"",10),config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOptionCookie("txtTheme");
	}
};

//--
//-- Backstage
//--

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = document.getElementById("backstageToolbar");
		this.button = document.getElementById("backstageButton");
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function(e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function(e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {backstage.switchTab(null);};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			addClass(btn,task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOptionCookie("chkBackstage");
		addClass(this.content,"backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOptionCookie("chkBackstage");
			removeClass(this.content, "backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		displayMessage(task);
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e)
			{
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
			}
		if(tabName == backstage.currTabName) {
			backstage.hidePanel();
			return;
		}
		if(backstage.currTabElem) {
			removeClass(this.currTabElem, "backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			addClass(tabElem,"backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findWindowHeight() + "px";
		backstage.cloak.style.display = "block";
		removeChildren(backstage.panelBody);
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			removeClass(backstage.currTabElem, "backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		} else {
			jQuery([backstage.panel,backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	var place = wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e)
{
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	wizard.addStep(this.step1Title,this.step1Html);
	var s = wizard.getElement("selTypes");
	for(var t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,config.adaptors[t].serverLabel ? config.adaptors[t].serverLabel : t);
		e.value = t;
	}
	if(config.defaultAdaptor)
		s.value = config.defaultAdaptor;
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = config.macros.importTiddlers.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = config.macros.importTiddlers.onBrowseChange;
	fileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: config.macros.importTiddlers.onOpen}]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var tagged = store.getTaggedTiddlers("systemServer","title");
	for(var t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(this.value);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(v)
{
	if(!v||!v.length)
		return v;
	v = v.replace(/\\/g,"/"); // use "/" for cross-platform consistency
	var u;
	var t = v.split(":");
	var p = t[1]||t[0]; // remove drive letter (if any)
	if (t[1] && (t[0]=="http"||t[0]=="https"||t[0]=="file")) {
		u = v;
	} else if(p.substr(0,1)=="/") {
		u = document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + v;
	} else {
		var c = document.location.href.replace(/\\/g,"/");
		var pos = c.lastIndexOf("/");
		if (pos!=-1)
			c = c.substr(0,pos); // remove filename
		u = c + "/" + p;
	}
	return u;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	var ret = adaptor.openHost(url,null,wizard,config.macros.importTiddlers.onOpenHost);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	var ret = adaptor.getWorkspaceList(context,wizard,config.macros.importTiddlers.onGetWorkspaceList);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context",context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length==1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		var ret = context.adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
		if(ret !== true)
			displayMessage(ret);
		wizard.setValue("workspace",workspace);
		wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
		return;
	}
	wizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);
	var s = wizard.getElement("selWorkspace");
	s.onchange = config.macros.importTiddlers.onWorkspaceChange;
	for(var t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace",null,false,true);
		for(var n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: config.macros.importTiddlers.openLabel, tooltip: config.macros.importTiddlers.openPrompt, onClick: config.macros.importTiddlers.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = wizard.getValue("context");
	var ret = adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var ret = adaptor.getTiddlerList(context,wizard,config.macros.importTiddlers.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	if(ret !== true)
		displayMessage(ret);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	if(context.status !== true) {
		wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.errorGettingTiddlerList);
		return;
	}
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,config.macros.importTiddlers.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setValue("context",context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = config.macros.importTiddlers.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},
			{caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick: config.macros.importTiddlers.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = config.macros.importTiddlers.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,config.macros.importTiddlers.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		config.macros.importTiddlers.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}
		],config.macros.importTiddlers.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(t=0; t<rowNames.length; t++) {
		var context = {
			allowSynchronous:true,
			tiddler:tiddlers[tiddlers.findByField("title",rowNames[t])]
		};
		adaptor.getTiddler(rowNames[t],context,wizard,config.macros.importTiddlers.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous)
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onClose}
			],config.macros.importTiddlers.statusDoneImport);
		autoSaveChanges();
	}
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.handler = function(place)
{
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	w.addStep(this.step1Title,this.step1Html.format([this.source,this.source]));
	w.setButtons([{caption: this.upgradeLabel, tooltip: this.upgradePrompt, onClick: this.onClickUpgrade}]);
};

config.macros.upgrade.onClickUpgrade = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(window.location.protocol != "file:") {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}
	var localPath = getLocalPath(document.location.toString());
	var backupPath = getBackupPath(localPath,me.backupExtension);
	w.setValue("backupPath",backupPath);
	w.setButtons([],me.statusPreparingBackup);
	var original = loadOriginal(localPath);
	w.setButtons([],me.statusSavingBackup);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(!backup) {
		w.setButtons([],me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}
	w.setButtons([],me.statusLoadingCore);
	var load = loadRemoteFile(me.source,me.onLoadCore,w);
	if(typeof load == "string") {
		w.setButtons([],me.errorLoadingCore);
		alert(me.errorLoadingCore);
		return false;
	}
	return false;
};

config.macros.upgrade.onLoadCore = function(status,params,responseText,url,xhr)
{
	var me = config.macros.upgrade;
	var w = params;
	var errMsg;
	if(!status)
		errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer)
		errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([],errMsg);
		alert(errMsg);
		return;
	}
	var onStartUpgrade = function(e) {
		w.setButtons([],me.statusSavingCore);
		var localPath = getLocalPath(document.location.toString());
		saveFile(localPath,responseText);
		w.setButtons([],me.statusReloadingCore);
		var backupPath = w.getValue("backupPath");
		var newLoc = document.location.toString() + "?time=" + new Date().convertToYYYYMMDDHHMM() + "#upgrade:[[" + encodeURI(backupPath) + "]]";
		window.setTimeout(function () {window.location = newLoc;},10);
	};
	var step2 = [me.step2Html_downgrade,me.step2Html_restore,me.step2Html_upgrade][compareVersions(version,newVer) + 1];
	w.addStep(me.step2Title,step2.format([formatVersion(newVer),formatVersion(version)]));
	w.setButtons([{caption: me.startLabel, tooltip: me.startPrompt, onClick: onStartUpgrade},{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}]);
};

config.macros.upgrade.onCancel = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title,me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile)
{
	var re = /^var version = \{title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return  m ? {title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])} : null;
};

function upgradeFrom(path)
{
	var importStore = new TiddlyWiki();
	var tw = loadFile(path);
	if(window.netscape !== undefined)
		tw = convertUTF8ToUnicode(tw);
	importStore.importTiddlyWiki(tw);
	importStore.forEachTiddler(function(title,tiddler) {
		if(!store.getTiddler(title)) {
			store.addTiddler(tiddler);
		}
	});
	refreshDisplay();
	saveChanges(); //# To create appropriate Markup* sections
	alert(config.messages.upgradeDone.format([formatVersion()]));
	window.location = window.location.toString().substr(0,window.location.toString().lastIndexOf("?"));
}

//--
//-- Sync macro
//--

// Synchronisation handlers
config.syncers = {};

// Sync state.
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!wikifier.isStatic)
		this.startSync(place);
};

config.macros.sync.cancelSync = function()
{
	currSync = null;
};

config.macros.sync.startSync = function(place)
{
	if(currSync)
		config.macros.sync.cancelSync();
	currSync = {};
	currSync.syncList = this.getSyncableTiddlers();
	currSync.syncTasks = this.createSyncTasks(currSync.syncList);
	this.preProcessSyncableTiddlers(currSync.syncList);
	var wizard = new Wizard();
	currSync.wizard = wizard;
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	currSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
	this.processSyncableTiddlers(currSync.syncList);
	wizard.setButtons([{caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}]);
};

config.macros.sync.getSyncableTiddlers = function()
{
	var list = [];
	store.forEachTiddler(function(title,tiddler) {
		var syncItem = {};
		syncItem.serverType = tiddler.getServerType();
		syncItem.serverHost = tiddler.fields['server.host'];
		if(syncItem.serverType && syncItem.serverHost) {
			syncItem.adaptor = new config.adaptors[syncItem.serverType];
			syncItem.serverWorkspace = tiddler.fields['server.workspace'];
			syncItem.tiddler = tiddler;
			syncItem.title = tiddler.title;
			syncItem.isTouched = tiddler.isTouched();
			syncItem.selected = syncItem.isTouched;
			syncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? "changedLocally" : "none"];
			syncItem.status = syncItem.syncStatus.text;
			list.push(syncItem);
		}
		});
	list.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	return list;
};

config.macros.sync.preProcessSyncableTiddlers = function(syncList)
{
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		si.serverUrl = si.adaptor.generateTiddlerInfo(si.tiddler).uri;
	}
};

config.macros.sync.processSyncableTiddlers = function(syncList)
{
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		if(si.syncStatus.display)
			si.rowElement.style.display = si.syncStatus.display;
		if(si.syncStatus.className)
			si.rowElement.className = si.syncStatus.className;
	}
};

config.macros.sync.createSyncTasks = function(syncList)
{
	var syncTasks = [];
	for(var i=0; i<syncList.length; i++) {
		var si = syncList[i];
		var r = null;
		for(var j=0; j<syncTasks.length; j++) {
			var cst = syncTasks[j];
			if(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)
				r = cst;
		}
		if(r) {
			si.syncTask = r;
			r.syncItems.push(si);
		} else {
			si.syncTask = this.createSyncTask(si);
			syncTasks.push(si.syncTask);
		}
	}
	return syncTasks;
};

config.macros.sync.createSyncTask = function(syncItem)
{
	var st = {};
	st.serverType = syncItem.serverType;
	st.serverHost = syncItem.serverHost;
	st.serverWorkspace = syncItem.serverWorkspace;
	st.syncItems = [syncItem];

	var openWorkspaceCallback = function(context,syncItems) {
		if(context.status) {
			context.adaptor.getTiddlerList(context,syncItems,getTiddlerListCallback);
			return true;
		}
		displayMessage(context.statusText);
		return false;
	};

	var getTiddlerListCallback = function(context,sycnItems) {
		if(!context.status) {
			displayMessage(context.statusText);
			return false;
		}
		syncItems = context.userParams;
		var tiddlers = context.tiddlers;
		for(var i=0; i<syncItems.length; i++) {
			var si = syncItems[i];
			var f = tiddlers.findByField("title",si.title);
			if(f !== null) {
				if(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {
					si.syncStatus = config.macros.sync.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];
				}
			} else {
				si.syncStatus = config.macros.sync.syncStatusList.notFound;
			}
			config.macros.sync.updateSyncStatus(si);
		}
		return true;
	};
	var context = {host:st.serverHost,workspace:st.serverWorkspace};
	syncItem.adaptor.openHost(st.serverHost);
	syncItem.adaptor.openWorkspace(st.serverWorkspace,context,st.syncItems,openWorkspaceCallback);
	return st;
};

config.macros.sync.updateSyncStatus = function(syncItem)
{
	var e = syncItem.colElements["status"];
	removeChildren(e);
	createTiddlyText(e,syncItem.syncStatus.text);
	if(syncItem.syncStatus.display)
		syncItem.rowElement.style.display = syncItem.syncStatus.display;
	if(syncItem.syncStatus.className)
		syncItem.rowElement.className = syncItem.syncStatus.className;
};

config.macros.sync.doSync = function(e)
{
	var getTiddlerCallback = function(context,syncItem) {
		if(syncItem) {
			var tiddler = context.tiddler;
			store.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);
			syncItem.syncStatus = config.macros.sync.syncStatusList.gotFromServer;
			config.macros.sync.updateSyncStatus(syncItem);
		}
	};
	var putTiddlerCallback = function(context,syncItem) {
		if(syncItem) {
			store.resetTiddler(context.title);
			syncItem.syncStatus = config.macros.sync.syncStatusList.putToServer;
			config.macros.sync.updateSyncStatus(syncItem);
		}
	};

	var rowNames = ListView.getSelectedRows(currSync.listView);
	var sl = config.macros.sync.syncStatusList;
	for(var i=0; i<currSync.syncList.length; i++) {
		var si = currSync.syncList[i];
		if(rowNames.indexOf(si.title) != -1) {
			var errorMsg = "Error in doSync: ";
			try {
				var r = true;
				switch(si.syncStatus) {
				case sl.changedServer:
					r = si.adaptor.getTiddler(si.title,null,si,getTiddlerCallback);
					break;
				case sl.notFound:
				case sl.changedLocally:
				case sl.changedBoth:
					r = si.adaptor.putTiddler(si.tiddler,null,si,putTiddlerCallback);
					break;
				default:
					break;
				}
				if(!r)
					displayMessage(errorMsg + r);
			} catch(ex) {
				if(ex.name == "TypeError")
					displayMessage("sync operation unsupported: " + ex.message);
				else
					displayMessage(errorMsg + ex.message);
			}
		}
	}
	return false;
};

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(listWrapper);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);
		wizard.setValue("listView",listView);
		wizard.setButtons([
				{caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick: config.macros.plugins.doRemoveTag},
				{caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick: config.macros.plugins.doDelete}
			]);
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var t=0; t<rowNames.length; t++)
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(var t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
	}
};

//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		removeChildren(msgArea);
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},

	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.indexOf(title) != -1) {
			removeChildren(e);
			wikify(store.getTiddlerText(title,""),e,null,store.fetchTiddler(title));
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	var isAvailable = function(title) {
		var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
		if(s!=-1)
			title = title.substr(0,s);
		return store.tiddlerExists(title) || store.isShadowTiddler(title);
	};
	if(!title || !isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	wrapper.innerHTML = store.getRecursiveTiddlerText(title,null,10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div",story.containerId());
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	removeNode(stash);
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	var st = wikifyPlain("SiteTitle");
	var ss = wikifyPlain("SiteSubtitle");
	return st + ((st == "" || ss == "") ? "" : " - ") + ss;
}

function refreshStyles(title,doc)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc || document);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Options stuff
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? "true" : "false";},
		set: function(name,value) {config.options[name] = value == "true";}
	}
};

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++) {
		var p = cookies[c].indexOf("=");
		if(p != -1) {
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			var optType = name.substr(0,3);
			if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
				config.optionHandlers[optType].set(name,value);
		}
	}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].get)
		c += config.optionHandlers[optType].get(name);
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

function removeCookie(name)
{
	document.cookie = name + "=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;";
}

function encodeCookie(s)
{
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,"")));});
}


config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute("type",typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute("option",opt);
	c.className = className || typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute("title",config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != "no")
		createTiddlyText(place,config.optionsDesc[opt] || opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute("option");
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType,this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: "input",
		valueField: "value",
		eventName: "onchange",
		className: "txtOptionInput",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: "input",
		valueField: "checked",
		eventName: "onclick",
		className: "chkOptionInput",
		typeValue: "checkbox",
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType,elem)
{
	config.options[opt] = value;
	saveOptionCookie(opt);
	var nodes = document.getElementsByTagName(elementType);
	for(var t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute("option");
		if(opt == optNode && nodes[t]!=elem)
			nodes[t][valueField] = value;
	}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var opt = (params[1] && params[1].name == "anon") ? params[1].value : getParam(params,"name",null);
	var className = (params[2] && params[2].name == "anon") ? params[2].value : getParam(params,"class",null);
	var desc = getParam(params,"desc","no");
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var showUnknown = getParam(params,"showUnknown","no");
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var chkUnknown = wizard.getElement("chkUnknown");
	chkUnknown.checked = showUnknown == "yes";
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue("listWrapper",listWrapper);
	this.refreshOptions(listWrapper,showUnknown == "yes");
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
	var opts = [];
	for(var n in config.options) {
		var opt = {};
		opt.option = "";
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	var listview = ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,"no");
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue("listWrapper");
	removeChildren(listWrapper);
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + convertUnicodeToFileFormat(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
}

function updateOriginal(original,posDiv,localPath)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToFileFormat(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToFileFormat(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

function loadOriginal(localPath)
{
	return loadFile(localPath);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var originalPath = document.location.toString();
	if(originalPath.substr(0,5) != "file:") {
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return;
	}
	saveMain(localPath,original,posDiv);
	if(config.options.chkSaveBackups)
		saveBackup(localPath,original);
	if(config.options.chkSaveEmptyTemplate)
		saveEmpty(localPath,original,posDiv);
	if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
		saveRss(localPath);
	if(config.options.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv,localPath);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function saveBackup(localPath,original)
{
	var backupPath = getBackupPath(localPath);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(backup)
		displayMessage(config.messages.backupSaved,"file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath,original,posDiv)
{
	var emptyPath,p;
	if((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";
	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath,empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath,title,extension)
{
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
	if(title)
		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath)
{
	var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
	if(saveFile(rssPath,convertUnicodeToFileFormat(generateRss())))
		displayMessage(config.messages.rssSaved,"file://" + rssPath);
	else
		alert(config.messages.rssFailed);
}

tiddlerToRssItem = function(tiddler,uri)
{
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text,null,tiddler).htmlEncode() + "</description>\n";
	for(var i=0; i<tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s +="<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
};

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for(var i=tiddlers.length-1; i>=n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i],u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToFileFormat(s)
{
	return config.browser.isOpera || !window.netscape ? convertUnicodeToHtmlEntities(s) : mozConvertUnicodeToUTF8(s);
}

function convertUnicodeToHtmlEntities(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function convertUnicodeToUTF8(s)
{
// return convertUnicodeToFileFormat to allow plugin migration
	return convertUnicodeToFileFormat(s);
}

function manualConvertUnicodeToUTF8(s)
{
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function copyFile(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}

function saveFile(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos==-1)
		pos = path.lastIndexOf("/");
	if(pos!=-1)
		path = path.substring(0,pos+1);

	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	return i > 0 ? url.substring(i-1) : url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

//--
//-- Server adaptor base class
//--

function AdaptorBase()
{
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function()
{
	return true;
};

AdaptorBase.prototype.fullHostName = function(host)
{
	if(!host)
		return '';
	host = host.trim();
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length-1) == '/')
		host = host.substr(0,host.length-1);
	return host;
};

AdaptorBase.minHostName = function(host)
{
	return host ? host.replace(/^http:\/\//,'').replace(/\/$/,'') : '';
};

AdaptorBase.prototype.setContext = function(context,userParams,callback)
{
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
AdaptorBase.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {context.callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
AdaptorBase.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	this.workspace = workspace;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor()
{
}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

// Get the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback,filter)
{
	context = this.setContext(context,userParams,callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		var ret = context.complete(context,context.userParams);
	} else {
		ret = loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
		if(typeof ret != "string")
			ret = true;
	}
	return ret;
};

FileAdaptor.getTiddlerListComplete = function(context,userParams)
{
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title,tiddler) {context.tiddlers.push(tiddler);});
		}
		for(var i=0; i<context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieve a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	return context.adaptor.store ?
		context.complete(context,context.userParams) :
		loadRemoteFile(context.host,FileAdaptor.loadTiddlyWikiCallback,context);
};

FileAdaptor.getTiddlerComplete = function(context,userParams)
{
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context,userParams);
	} else {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	delete this.store;
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

function ajaxReq(args)
{
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	return jQuery.ajax(args);
}

//--
//-- TiddlyWiki-specific utility functions
//--

// Returns TiddlyWiki version string
function formatVersion(v)
{
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "");
}

function compareVersions(v1,v2)
{
	var a = ["major","minor","revision"];
	for(var i = 0; i<a.length; i++) {
		var x1 = v1[a[i]] || 0;
		var x2 = v2[a[i]] || 0;
		if(x1<x2)
			return 1;
		if(x1>x2)
			return -1;
	}
	x1 = v1.beta || 9999;
	x2 = v2.beta || 9999;
	if(x1<x2)
		return 1;
	return x1 > x2 ? -1 : 0;
}

function createTiddlyButton(parent,text,tooltip,action,className,id,accessKey,attribs)
{
	var btn = document.createElement("a");
	if(action) {
		btn.onclick = action;
		btn.setAttribute("href","javascript:;");
	}
	if(tooltip)
		btn.setAttribute("title",tooltip);
	if(text)
		btn.appendChild(document.createTextNode(text));
	btn.className = className || "button";
	if(id)
		btn.id = id;
	if(attribs) {
		for(var i in attribs) {
			btn.setAttribute(i,attribs[i]);
		}
	}
	if(parent)
		parent.appendChild(btn);
	if(accessKey)
		btn.setAttribute("accessKey",accessKey);
	return btn;
}

function createTiddlyLink(place,title,includeText,className,isStatic,linkedFromTiddler,noToggle)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,className);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
		} else {
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
		}
	}
	if(typeof config.annotations[title]=="string")
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url,label)
{
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	link.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	if(label)
		createTiddlyText(link, label);
	return link;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f,config.defaultCustomFields,true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler,title,tooltip)
{
	var btn = createTiddlyButton(place,title||tag,(tooltip||config.views.wikified.tag.tooltip).format([tag]),onClickTag);
	btn.setAttribute("tag",tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler",excludeTiddler);
	return btn;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	addClass(popup,"taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyElement(popup,"li",null,"disabled",lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev)
{
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	story.displayTiddlers(this,tiddlers);
	return false;
}

function onClickError(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickTiddlyPopup(ev)
{
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for(var i in src) {
		if(!preserveExisting || dst[i] === undefined)
			dst[i] = src[i];
	}
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description || e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(!g.browsers[b]() && b < g.browsers.length-1)
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}

if(!window.console) {
	console = {tiddlywiki:true,log:function(message) {displayMessage(message);}};
}

//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() //# Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
	case "-tw-vertScroll":
		window.scrollTo(findScrollX(),value);
		break;
	case "-tw-horizScroll":
		window.scrollTo(value,findScrollY());
		break;
	default:
		element.style[style] = value;
		break;
	}
};

Morpher.prototype.stop = function()
{
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	var progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(var t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
			case undefined:
			case "style":
				var v = p.start + (p.end-p.start) * progress;
				this.assignStyle(this.element,p.style,template.format([v]));
				break;
			case "color":
				break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {removeNode(element);};
	return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement)
{
	var p = [{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}];
	return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var left = findPosX(element);
	var width = element.scrollWidth;
	var height = element.scrollHeight;
	var winWidth = findWindowWidth();
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
		case "all":
			c = function(element,properties) {removeNode(element);};
			break;
		case "children":
			c = function(element,properties) {removeChildren(element);};
			break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,className)
{
	var stackPosition = this.find(root,"popup");
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem || "ol","popup",className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev)
{
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign,halign,offset)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,valign,halign,offset);
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,valign,halign,offset)
{
	if(!offset)
		var offset = {x:0,y:0};
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e)
{
	var pos = -1;
	for (var t=this.stack.length-1; t>=0; t--) {
		if(isDescendant(e,this.stack[t].popup))
			pos = t;
	}
	return pos;
};

Popup.remove = function(pos)
{
	if(!pos) var pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		removeNode(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	if(this.formElem)
		this.formElem[name] = value;
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? this.formElem[name] : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
};

Wizard.prototype.clear = function()
{
	removeChildren(this.bodyElem);
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	removeChildren(this.footElem);
	for(var t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	removeChildren(this.bodyElem);
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className || "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(c,columnTemplate,t);
			if(columnTemplate.className)
				addClass(c,columnTemplate.className);
		}
	}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++) {
		var rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		for(var cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
				if(columnTemplate.className)
					addClass(c,columnTemplate.className);
			}
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<config.messages.sizeTemplates.length-1 && v<config.messages.sizeTemplates[t].unit)
					t++;
				createTiddlyText(place,config.messages.sizeTemplates[t].template.format([Math.round(v/config.messages.sizeTemplates[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createExternalLink(place,v,c || v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				for(var t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};

//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return Number(c);
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++) {
		if(this[t][field] === value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for(var i = 0; i<items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

if(!Array.prototype.map) {
Array.prototype.map = function(fn,thisObj)
{
	var scope = thisObj || window;
	var a = [];
	for(var i=0, j=this.length; i < j; ++i) {
		a.push(fn.call(scope,this[i],i,this));
	}
	return a;
};}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1) {
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++) {
		if(p[t].value)
			n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var r = {};
	for(var t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var r = [];
	for(var t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix)
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	t = t.replace(/\\/g,"");
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	var hh = d.substr(8,2) || "00";
	var mm = d.substr(10,2) || "00";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(hh,10),
			parseInt(mm,10),0,0));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

function drawGradient(place,horiz,locolors,hicolors)
{
	if(!hicolors)
		hicolors = locolors;
	for(var t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var p = t/100*(locolors.length-1);
		var hc = hicolors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = locolors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc,p-Math.floor(p)).toString();
	}
}

function createTiddlyText(parent,text)
{
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,parent);
	return cb;
}

function createTiddlyElement(parent,element,id,className,text,attribs)
{
	var e = document.createElement(element);
	if(className != null)
		e.className = className;
	if(id != null)
		e.setAttribute("id",id);
	if(text != null)
		e.appendChild(document.createTextNode(text));
	if(attribs) {
		for(var n in attribs) {
			e.setAttribute(n,attribs[n]);
		}
	}
	if(parent != null)
		parent.appendChild(e);
	return e;
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj["e"+type+fn] = fn;
		obj[type+fn] = function(){obj["e"+type+fn](window.event);};
		obj.attachEvent("on"+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent("on"+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}


// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !hasClass(e,value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Force the browser to do a document reflow when needed to workaround browser bugs
function forceReflow()
{
	if(config.browser.isGecko) {
		setStylesheet("body {top:0px;margin-top:0px;}","forceReflow");
		setTimeout(function() {setStylesheet("","forceReflow");},1);
	}
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0,e.selectionStart).split("\n").length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = "";
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor)
{
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e)
{
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	if(!config.browser.isIE)
		return;
	var att = e.attributes;
	if(att) {
		for(var t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function addClass(e,className)
{
	jQuery(e).addClass(className);
}

function removeClass(e,className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e,className)
{
	return jQuery(e).hasClass(className);
}

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

// Remove a node and all it's children
function removeNode(e)
{
	jQuery(e).remove();
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(safeMode && store.isShadowTiddler(title))
		return;
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for(var t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for(var t = 0; t < tiddlers.length; t++) {
		if(!tiddlers[t].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[t]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if(node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var attrs = node.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if(!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created;
		var modified = tiddler.modified;
		var attributes = tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && created == version.date) ? "" :' created="' + created.convertToYYYYMMDDHHMM() + '"';
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() +'"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//]]>
</script>
<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated DOM utilities
//--

// @Deprecated: Use jQuery.stylesheet instead
function setStylesheet(s,id,doc)
{
	jQuery.twStylesheet(s,{ id: id, doc: doc });
}

// @Deprecated: Use jQuery.stylesheet.remove instead
function removeStyleSheet(id)
{
	jQuery.twStylesheet.remove({ id: id });
}
//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

function httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache)
{
	var options = {
		type:type,
		url:url,
		processData:false,
		data:data,
		cache:!!allowCache,
		beforeSend: function(xhr) {
			for(var i in headers)
				xhr.setRequestHeader(i,headers[i]);
			xhr.setRequestHeader("X-Requested-With", "TiddlyWiki " + formatVersion());
		}
	};

	if(callback) {
		options.complete = function(xhr,textStatus) {
			if(jQuery.httpSuccess(xhr))
				callback(true,params,xhr.responseText,url,xhr);
			else
				callback(false,params,null,url,xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	jQuery.ajax(options);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*
 * jQuery JavaScript Library v1.3.2
 * http://jquery.com/
 *
 * Copyright (c) 2009 John Resig
 * Dual licensed under the MIT and GPL licenses.
 * http://docs.jquery.com/License
 *
 * Date: 2009-02-19 17:34:21 -0500 (Thu, 19 Feb 2009)
 * Revision: 6246
 */
(function(){var l=this,g,y=l.jQuery,p=l.$,o=l.jQuery=l.$=function(E,F){return new o.fn.init(E,F)},D=/^[^<]*(<(.|\s)+>)[^>]*$|^#([\w-]+)$/,f=/^.[^:#\[\.,]*$/;o.fn=o.prototype={init:function(E,H){E=E||document;if(E.nodeType){this[0]=E;this.length=1;this.context=E;return this}if(typeof E==="string"){var G=D.exec(E);if(G&&(G[1]||!H)){if(G[1]){E=o.clean([G[1]],H)}else{var I=document.getElementById(G[3]);if(I&&I.id!=G[3]){return o().find(E)}var F=o(I||[]);F.context=document;F.selector=E;return F}}else{return o(H).find(E)}}else{if(o.isFunction(E)){return o(document).ready(E)}}if(E.selector&&E.context){this.selector=E.selector;this.context=E.context}return this.setArray(o.isArray(E)?E:o.makeArray(E))},selector:"",jquery:"1.3.2",size:function(){return this.length},get:function(E){return E===g?Array.prototype.slice.call(this):this[E]},pushStack:function(F,H,E){var G=o(F);G.prevObject=this;G.context=this.context;if(H==="find"){G.selector=this.selector+(this.selector?" ":"")+E}else{if(H){G.selector=this.selector+"."+H+"("+E+")"}}return G},setArray:function(E){this.length=0;Array.prototype.push.apply(this,E);return this},each:function(F,E){return o.each(this,F,E)},index:function(E){return o.inArray(E&&E.jquery?E[0]:E,this)},attr:function(F,H,G){var E=F;if(typeof F==="string"){if(H===g){return this[0]&&o[G||"attr"](this[0],F)}else{E={};E[F]=H}}return this.each(function(I){for(F in E){o.attr(G?this.style:this,F,o.prop(this,E[F],G,I,F))}})},css:function(E,F){if((E=="width"||E=="height")&&parseFloat(F)<0){F=g}return this.attr(E,F,"curCSS")},text:function(F){if(typeof F!=="object"&&F!=null){return this.empty().append((this[0]&&this[0].ownerDocument||document).createTextNode(F))}var E="";o.each(F||this,function(){o.each(this.childNodes,function(){if(this.nodeType!=8){E+=this.nodeType!=1?this.nodeValue:o.fn.text([this])}})});return E},wrapAll:function(E){if(this[0]){var F=o(E,this[0].ownerDocument).clone();if(this[0].parentNode){F.insertBefore(this[0])}F.map(function(){var G=this;while(G.firstChild){G=G.firstChild}return G}).append(this)}return this},wrapInner:function(E){return this.each(function(){o(this).contents().wrapAll(E)})},wrap:function(E){return this.each(function(){o(this).wrapAll(E)})},append:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.appendChild(E)}})},prepend:function(){return this.domManip(arguments,true,function(E){if(this.nodeType==1){this.insertBefore(E,this.firstChild)}})},before:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this)})},after:function(){return this.domManip(arguments,false,function(E){this.parentNode.insertBefore(E,this.nextSibling)})},end:function(){return this.prevObject||o([])},push:[].push,sort:[].sort,splice:[].splice,find:function(E){if(this.length===1){var F=this.pushStack([],"find",E);F.length=0;o.find(E,this[0],F);return F}else{return this.pushStack(o.unique(o.map(this,function(G){return o.find(E,G)})),"find",E)}},clone:function(G){var E=this.map(function(){if(!o.support.noCloneEvent&&!o.isXMLDoc(this)){var I=this.outerHTML;if(!I){var J=this.ownerDocument.createElement("div");J.appendChild(this.cloneNode(true));I=J.innerHTML}return o.clean([I.replace(/ jQuery\d+="(?:\d+|null)"/g,"").replace(/^\s*/,"")])[0]}else{return this.cloneNode(true)}});if(G===true){var H=this.find("*").andSelf(),F=0;E.find("*").andSelf().each(function(){if(this.nodeName!==H[F].nodeName){return}var I=o.data(H[F],"events");for(var K in I){for(var J in I[K]){o.event.add(this,K,I[K][J],I[K][J].data)}}F++})}return E},filter:function(E){return this.pushStack(o.isFunction(E)&&o.grep(this,function(G,F){return E.call(G,F)})||o.multiFilter(E,o.grep(this,function(F){return F.nodeType===1})),"filter",E)},closest:function(E){var G=o.expr.match.POS.test(E)?o(E):null,F=0;return this.map(function(){var H=this;while(H&&H.ownerDocument){if(G?G.index(H)>-1:o(H).is(E)){o.data(H,"closest",F);return H}H=H.parentNode;F++}})},not:function(E){if(typeof E==="string"){if(f.test(E)){return this.pushStack(o.multiFilter(E,this,true),"not",E)}else{E=o.multiFilter(E,this)}}var F=E.length&&E[E.length-1]!==g&&!E.nodeType;return this.filter(function(){return F?o.inArray(this,E)<0:this!=E})},add:function(E){return this.pushStack(o.unique(o.merge(this.get(),typeof E==="string"?o(E):o.makeArray(E))))},is:function(E){return !!E&&o.multiFilter(E,this).length>0},hasClass:function(E){return !!E&&this.is("."+E)},val:function(K){if(K===g){var E=this[0];if(E){if(o.nodeName(E,"option")){return(E.attributes.value||{}).specified?E.value:E.text}if(o.nodeName(E,"select")){var I=E.selectedIndex,L=[],M=E.options,H=E.type=="select-one";if(I<0){return null}for(var F=H?I:0,J=H?I+1:M.length;F<J;F++){var G=M[F];if(G.selected){K=o(G).val();if(H){return K}L.push(K)}}return L}return(E.value||"").replace(/\r/g,"")}return g}if(typeof K==="number"){K+=""}return this.each(function(){if(this.nodeType!=1){return}if(o.isArray(K)&&/radio|checkbox/.test(this.type)){this.checked=(o.inArray(this.value,K)>=0||o.inArray(this.name,K)>=0)}else{if(o.nodeName(this,"select")){var N=o.makeArray(K);o("option",this).each(function(){this.selected=(o.inArray(this.value,N)>=0||o.inArray(this.text,N)>=0)});if(!N.length){this.selectedIndex=-1}}else{this.value=K}}})},html:function(E){return E===g?(this[0]?this[0].innerHTML.replace(/ jQuery\d+="(?:\d+|null)"/g,""):null):this.empty().append(E)},replaceWith:function(E){return this.after(E).remove()},eq:function(E){return this.slice(E,+E+1)},slice:function(){return this.pushStack(Array.prototype.slice.apply(this,arguments),"slice",Array.prototype.slice.call(arguments).join(","))},map:function(E){return this.pushStack(o.map(this,function(G,F){return E.call(G,F,G)}))},andSelf:function(){return this.add(this.prevObject)},domManip:function(J,M,L){if(this[0]){var I=(this[0].ownerDocument||this[0]).createDocumentFragment(),F=o.clean(J,(this[0].ownerDocument||this[0]),I),H=I.firstChild;if(H){for(var G=0,E=this.length;G<E;G++){L.call(K(this[G],H),this.length>1||G>0?I.cloneNode(true):I)}}if(F){o.each(F,z)}}return this;function K(N,O){return M&&o.nodeName(N,"table")&&o.nodeName(O,"tr")?(N.getElementsByTagName("tbody")[0]||N.appendChild(N.ownerDocument.createElement("tbody"))):N}}};o.fn.init.prototype=o.fn;function z(E,F){if(F.src){o.ajax({url:F.src,async:false,dataType:"script"})}else{o.globalEval(F.text||F.textContent||F.innerHTML||"")}if(F.parentNode){F.parentNode.removeChild(F)}}function e(){return +new Date}o.extend=o.fn.extend=function(){var J=arguments[0]||{},H=1,I=arguments.length,E=false,G;if(typeof J==="boolean"){E=J;J=arguments[1]||{};H=2}if(typeof J!=="object"&&!o.isFunction(J)){J={}}if(I==H){J=this;--H}for(;H<I;H++){if((G=arguments[H])!=null){for(var F in G){var K=J[F],L=G[F];if(J===L){continue}if(E&&L&&typeof L==="object"&&!L.nodeType){J[F]=o.extend(E,K||(L.length!=null?[]:{}),L)}else{if(L!==g){J[F]=L}}}}}return J};var b=/z-?index|font-?weight|opacity|zoom|line-?height/i,q=document.defaultView||{},s=Object.prototype.toString;o.extend({noConflict:function(E){l.$=p;if(E){l.jQuery=y}return o},isFunction:function(E){return s.call(E)==="[object Function]"},isArray:function(E){return s.call(E)==="[object Array]"},isXMLDoc:function(E){return E.nodeType===9&&E.documentElement.nodeName!=="HTML"||!!E.ownerDocument&&o.isXMLDoc(E.ownerDocument)},globalEval:function(G){if(G&&/\S/.test(G)){var F=document.getElementsByTagName("head")[0]||document.documentElement,E=document.createElement("script");E.type="text/javascript";if(o.support.scriptEval){E.appendChild(document.createTextNode(G))}else{E.text=G}F.insertBefore(E,F.firstChild);F.removeChild(E)}},nodeName:function(F,E){return F.nodeName&&F.nodeName.toUpperCase()==E.toUpperCase()},each:function(G,K,F){var E,H=0,I=G.length;if(F){if(I===g){for(E in G){if(K.apply(G[E],F)===false){break}}}else{for(;H<I;){if(K.apply(G[H++],F)===false){break}}}}else{if(I===g){for(E in G){if(K.call(G[E],E,G[E])===false){break}}}else{for(var J=G[0];H<I&&K.call(J,H,J)!==false;J=G[++H]){}}}return G},prop:function(H,I,G,F,E){if(o.isFunction(I)){I=I.call(H,F)}return typeof I==="number"&&G=="curCSS"&&!b.test(E)?I+"px":I},className:{add:function(E,F){o.each((F||"").split(/\s+/),function(G,H){if(E.nodeType==1&&!o.className.has(E.className,H)){E.className+=(E.className?" ":"")+H}})},remove:function(E,F){if(E.nodeType==1){E.className=F!==g?o.grep(E.className.split(/\s+/),function(G){return !o.className.has(F,G)}).join(" "):""}},has:function(F,E){return F&&o.inArray(E,(F.className||F).toString().split(/\s+/))>-1}},swap:function(H,G,I){var E={};for(var F in G){E[F]=H.style[F];H.style[F]=G[F]}I.call(H);for(var F in G){H.style[F]=E[F]}},css:function(H,F,J,E){if(F=="width"||F=="height"){var L,G={position:"absolute",visibility:"hidden",display:"block"},K=F=="width"?["Left","Right"]:["Top","Bottom"];function I(){L=F=="width"?H.offsetWidth:H.offsetHeight;if(E==="border"){return}o.each(K,function(){if(!E){L-=parseFloat(o.curCSS(H,"padding"+this,true))||0}if(E==="margin"){L+=parseFloat(o.curCSS(H,"margin"+this,true))||0}else{L-=parseFloat(o.curCSS(H,"border"+this+"Width",true))||0}})}if(H.offsetWidth!==0){I()}else{o.swap(H,G,I)}return Math.max(0,Math.round(L))}return o.curCSS(H,F,J)},curCSS:function(I,F,G){var L,E=I.style;if(F=="opacity"&&!o.support.opacity){L=o.attr(E,"opacity");return L==""?"1":L}if(F.match(/float/i)){F=w}if(!G&&E&&E[F]){L=E[F]}else{if(q.getComputedStyle){if(F.match(/float/i)){F="float"}F=F.replace(/([A-Z])/g,"-$1").toLowerCase();var M=q.getComputedStyle(I,null);if(M){L=M.getPropertyValue(F)}if(F=="opacity"&&L==""){L="1"}}else{if(I.currentStyle){var J=F.replace(/\-(\w)/g,function(N,O){return O.toUpperCase()});L=I.currentStyle[F]||I.currentStyle[J];if(!/^\d+(px)?$/i.test(L)&&/^\d/.test(L)){var H=E.left,K=I.runtimeStyle.left;I.runtimeStyle.left=I.currentStyle.left;E.left=L||0;L=E.pixelLeft+"px";E.left=H;I.runtimeStyle.left=K}}}}return L},clean:function(F,K,I){K=K||document;if(typeof K.createElement==="undefined"){K=K.ownerDocument||K[0]&&K[0].ownerDocument||document}if(!I&&F.length===1&&typeof F[0]==="string"){var H=/^<(\w+)\s*\/?>$/.exec(F[0]);if(H){return[K.createElement(H[1])]}}var G=[],E=[],L=K.createElement("div");o.each(F,function(P,S){if(typeof S==="number"){S+=""}if(!S){return}if(typeof S==="string"){S=S.replace(/(<(\w+)[^>]*?)\/>/g,function(U,V,T){return T.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i)?U:V+"></"+T+">"});var O=S.replace(/^\s+/,"").substring(0,10).toLowerCase();var Q=!O.indexOf("<opt")&&[1,"<select multiple='multiple'>","</select>"]||!O.indexOf("<leg")&&[1,"<fieldset>","</fieldset>"]||O.match(/^<(thead|tbody|tfoot|colg|cap)/)&&[1,"<table>","</table>"]||!O.indexOf("<tr")&&[2,"<table><tbody>","</tbody></table>"]||(!O.indexOf("<td")||!O.indexOf("<th"))&&[3,"<table><tbody><tr>","</tr></tbody></table>"]||!O.indexOf("<col")&&[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"]||!o.support.htmlSerialize&&[1,"div<div>","</div>"]||[0,"",""];L.innerHTML=Q[1]+S+Q[2];while(Q[0]--){L=L.lastChild}if(!o.support.tbody){var R=/<tbody/i.test(S),N=!O.indexOf("<table")&&!R?L.firstChild&&L.firstChild.childNodes:Q[1]=="<table>"&&!R?L.childNodes:[];for(var M=N.length-1;M>=0;--M){if(o.nodeName(N[M],"tbody")&&!N[M].childNodes.length){N[M].parentNode.removeChild(N[M])}}}if(!o.support.leadingWhitespace&&/^\s/.test(S)){L.insertBefore(K.createTextNode(S.match(/^\s*/)[0]),L.firstChild)}S=o.makeArray(L.childNodes)}if(S.nodeType){G.push(S)}else{G=o.merge(G,S)}});if(I){for(var J=0;G[J];J++){if(o.nodeName(G[J],"script")&&(!G[J].type||G[J].type.toLowerCase()==="text/javascript")){E.push(G[J].parentNode?G[J].parentNode.removeChild(G[J]):G[J])}else{if(G[J].nodeType===1){G.splice.apply(G,[J+1,0].concat(o.makeArray(G[J].getElementsByTagName("script"))))}I.appendChild(G[J])}}return E}return G},attr:function(J,G,K){if(!J||J.nodeType==3||J.nodeType==8){return g}var H=!o.isXMLDoc(J),L=K!==g;G=H&&o.props[G]||G;if(J.tagName){var F=/href|src|style/.test(G);if(G=="selected"&&J.parentNode){J.parentNode.selectedIndex}if(G in J&&H&&!F){if(L){if(G=="type"&&o.nodeName(J,"input")&&J.parentNode){throw"type property can't be changed"}J[G]=K}if(o.nodeName(J,"form")&&J.getAttributeNode(G)){return J.getAttributeNode(G).nodeValue}if(G=="tabIndex"){var I=J.getAttributeNode("tabIndex");return I&&I.specified?I.value:J.nodeName.match(/(button|input|object|select|textarea)/i)?0:J.nodeName.match(/^(a|area)$/i)&&J.href?0:g}return J[G]}if(!o.support.style&&H&&G=="style"){return o.attr(J.style,"cssText",K)}if(L){J.setAttribute(G,""+K)}var E=!o.support.hrefNormalized&&H&&F?J.getAttribute(G,2):J.getAttribute(G);return E===null?g:E}if(!o.support.opacity&&G=="opacity"){if(L){J.zoom=1;J.filter=(J.filter||"").replace(/alpha\([^)]*\)/,"")+(parseInt(K)+""=="NaN"?"":"alpha(opacity="+K*100+")")}return J.filter&&J.filter.indexOf("opacity=")>=0?(parseFloat(J.filter.match(/opacity=([^)]*)/)[1])/100)+"":""}G=G.replace(/-([a-z])/ig,function(M,N){return N.toUpperCase()});if(L){J[G]=K}return J[G]},trim:function(E){return(E||"").replace(/^\s+|\s+$/g,"")},makeArray:function(G){var E=[];if(G!=null){var F=G.length;if(F==null||typeof G==="string"||o.isFunction(G)||G.setInterval){E[0]=G}else{while(F){E[--F]=G[F]}}}return E},inArray:function(G,H){for(var E=0,F=H.length;E<F;E++){if(H[E]===G){return E}}return -1},merge:function(H,E){var F=0,G,I=H.length;if(!o.support.getAll){while((G=E[F++])!=null){if(G.nodeType!=8){H[I++]=G}}}else{while((G=E[F++])!=null){H[I++]=G}}return H},unique:function(K){var F=[],E={};try{for(var G=0,H=K.length;G<H;G++){var J=o.data(K[G]);if(!E[J]){E[J]=true;F.push(K[G])}}}catch(I){F=K}return F},grep:function(F,J,E){var G=[];for(var H=0,I=F.length;H<I;H++){if(!E!=!J(F[H],H)){G.push(F[H])}}return G},map:function(E,J){var F=[];for(var G=0,H=E.length;G<H;G++){var I=J(E[G],G);if(I!=null){F[F.length]=I}}return F.concat.apply([],F)}});var C=navigator.userAgent.toLowerCase();o.browser={version:(C.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(C),opera:/opera/.test(C),msie:/msie/.test(C)&&!/opera/.test(C),mozilla:/mozilla/.test(C)&&!/(compatible|webkit)/.test(C)};o.each({parent:function(E){return E.parentNode},parents:function(E){return o.dir(E,"parentNode")},next:function(E){return o.nth(E,2,"nextSibling")},prev:function(E){return o.nth(E,2,"previousSibling")},nextAll:function(E){return o.dir(E,"nextSibling")},prevAll:function(E){return o.dir(E,"previousSibling")},siblings:function(E){return o.sibling(E.parentNode.firstChild,E)},children:function(E){return o.sibling(E.firstChild)},contents:function(E){return o.nodeName(E,"iframe")?E.contentDocument||E.contentWindow.document:o.makeArray(E.childNodes)}},function(E,F){o.fn[E]=function(G){var H=o.map(this,F);if(G&&typeof G=="string"){H=o.multiFilter(G,H)}return this.pushStack(o.unique(H),E,G)}});o.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(E,F){o.fn[E]=function(G){var J=[],L=o(G);for(var K=0,H=L.length;K<H;K++){var I=(K>0?this.clone(true):this).get();o.fn[F].apply(o(L[K]),I);J=J.concat(I)}return this.pushStack(J,E,G)}});o.each({removeAttr:function(E){o.attr(this,E,"");if(this.nodeType==1){this.removeAttribute(E)}},addClass:function(E){o.className.add(this,E)},removeClass:function(E){o.className.remove(this,E)},toggleClass:function(F,E){if(typeof E!=="boolean"){E=!o.className.has(this,F)}o.className[E?"add":"remove"](this,F)},remove:function(E){if(!E||o.filter(E,[this]).length){o("*",this).add([this]).each(function(){o.event.remove(this);o.removeData(this)});if(this.parentNode){this.parentNode.removeChild(this)}}},empty:function(){o(this).children().remove();while(this.firstChild){this.removeChild(this.firstChild)}}},function(E,F){o.fn[E]=function(){return this.each(F,arguments)}});function j(E,F){return E[0]&&parseInt(o.curCSS(E[0],F,true),10)||0}var h="jQuery"+e(),v=0,A={};o.extend({cache:{},data:function(F,E,G){F=F==l?A:F;var H=F[h];if(!H){H=F[h]=++v}if(E&&!o.cache[H]){o.cache[H]={}}if(G!==g){o.cache[H][E]=G}return E?o.cache[H][E]:H},removeData:function(F,E){F=F==l?A:F;var H=F[h];if(E){if(o.cache[H]){delete o.cache[H][E];E="";for(E in o.cache[H]){break}if(!E){o.removeData(F)}}}else{try{delete F[h]}catch(G){if(F.removeAttribute){F.removeAttribute(h)}}delete o.cache[H]}},queue:function(F,E,H){if(F){E=(E||"fx")+"queue";var G=o.data(F,E);if(!G||o.isArray(H)){G=o.data(F,E,o.makeArray(H))}else{if(H){G.push(H)}}}return G},dequeue:function(H,G){var E=o.queue(H,G),F=E.shift();if(!G||G==="fx"){F=E[0]}if(F!==g){F.call(H)}}});o.fn.extend({data:function(E,G){var H=E.split(".");H[1]=H[1]?"."+H[1]:"";if(G===g){var F=this.triggerHandler("getData"+H[1]+"!",[H[0]]);if(F===g&&this.length){F=o.data(this[0],E)}return F===g&&H[1]?this.data(H[0]):F}else{return this.trigger("setData"+H[1]+"!",[H[0],G]).each(function(){o.data(this,E,G)})}},removeData:function(E){return this.each(function(){o.removeData(this,E)})},queue:function(E,F){if(typeof E!=="string"){F=E;E="fx"}if(F===g){return o.queue(this[0],E)}return this.each(function(){var G=o.queue(this,E,F);if(E=="fx"&&G.length==1){G[0].call(this)}})},dequeue:function(E){return this.each(function(){o.dequeue(this,E)})}});
/*
 * Sizzle CSS Selector Engine - v0.9.3
 *  Copyright 2009, The Dojo Foundation
 *  Released under the MIT, BSD, and GPL Licenses.
 *  More information: http://sizzlejs.com/
 */
(function(){var R=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?/g,L=0,H=Object.prototype.toString;var F=function(Y,U,ab,ac){ab=ab||[];U=U||document;if(U.nodeType!==1&&U.nodeType!==9){return[]}if(!Y||typeof Y!=="string"){return ab}var Z=[],W,af,ai,T,ad,V,X=true;R.lastIndex=0;while((W=R.exec(Y))!==null){Z.push(W[1]);if(W[2]){V=RegExp.rightContext;break}}if(Z.length>1&&M.exec(Y)){if(Z.length===2&&I.relative[Z[0]]){af=J(Z[0]+Z[1],U)}else{af=I.relative[Z[0]]?[U]:F(Z.shift(),U);while(Z.length){Y=Z.shift();if(I.relative[Y]){Y+=Z.shift()}af=J(Y,af)}}}else{var ae=ac?{expr:Z.pop(),set:E(ac)}:F.find(Z.pop(),Z.length===1&&U.parentNode?U.parentNode:U,Q(U));af=F.filter(ae.expr,ae.set);if(Z.length>0){ai=E(af)}else{X=false}while(Z.length){var ah=Z.pop(),ag=ah;if(!I.relative[ah]){ah=""}else{ag=Z.pop()}if(ag==null){ag=U}I.relative[ah](ai,ag,Q(U))}}if(!ai){ai=af}if(!ai){throw"Syntax error, unrecognized expression: "+(ah||Y)}if(H.call(ai)==="[object Array]"){if(!X){ab.push.apply(ab,ai)}else{if(U.nodeType===1){for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&&(ai[aa]===true||ai[aa].nodeType===1&&K(U,ai[aa]))){ab.push(af[aa])}}}else{for(var aa=0;ai[aa]!=null;aa++){if(ai[aa]&&ai[aa].nodeType===1){ab.push(af[aa])}}}}}else{E(ai,ab)}if(V){F(V,U,ab,ac);if(G){hasDuplicate=false;ab.sort(G);if(hasDuplicate){for(var aa=1;aa<ab.length;aa++){if(ab[aa]===ab[aa-1]){ab.splice(aa--,1)}}}}}return ab};F.matches=function(T,U){return F(T,null,null,U)};F.find=function(aa,T,ab){var Z,X;if(!aa){return[]}for(var W=0,V=I.order.length;W<V;W++){var Y=I.order[W],X;if((X=I.match[Y].exec(aa))){var U=RegExp.leftContext;if(U.substr(U.length-1)!=="\\"){X[1]=(X[1]||"").replace(/\\/g,"");Z=I.find[Y](X,T,ab);if(Z!=null){aa=aa.replace(I.match[Y],"");break}}}}if(!Z){Z=T.getElementsByTagName("*")}return{set:Z,expr:aa}};F.filter=function(ad,ac,ag,W){var V=ad,ai=[],aa=ac,Y,T,Z=ac&&ac[0]&&Q(ac[0]);while(ad&&ac.length){for(var ab in I.filter){if((Y=I.match[ab].exec(ad))!=null){var U=I.filter[ab],ah,af;T=false;if(aa==ai){ai=[]}if(I.preFilter[ab]){Y=I.preFilter[ab](Y,aa,ag,ai,W,Z);if(!Y){T=ah=true}else{if(Y===true){continue}}}if(Y){for(var X=0;(af=aa[X])!=null;X++){if(af){ah=U(af,Y,X,aa);var ae=W^!!ah;if(ag&&ah!=null){if(ae){T=true}else{aa[X]=false}}else{if(ae){ai.push(af);T=true}}}}}if(ah!==g){if(!ag){aa=ai}ad=ad.replace(I.match[ab],"");if(!T){return[]}break}}}if(ad==V){if(T==null){throw"Syntax error, unrecognized expression: "+ad}else{break}}V=ad}return aa};var I=F.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF_-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF_-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*_-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF_-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(T){return T.getAttribute("href")}},relative:{"+":function(aa,T,Z){var X=typeof T==="string",ab=X&&!/\W/.test(T),Y=X&&!ab;if(ab&&!Z){T=T.toUpperCase()}for(var W=0,V=aa.length,U;W<V;W++){if((U=aa[W])){while((U=U.previousSibling)&&U.nodeType!==1){}aa[W]=Y||U&&U.nodeName===T?U||false:U===T}}if(Y){F.filter(T,aa,true)}},">":function(Z,U,aa){var X=typeof U==="string";if(X&&!/\W/.test(U)){U=aa?U:U.toUpperCase();for(var V=0,T=Z.length;V<T;V++){var Y=Z[V];if(Y){var W=Y.parentNode;Z[V]=W.nodeName===U?W:false}}}else{for(var V=0,T=Z.length;V<T;V++){var Y=Z[V];if(Y){Z[V]=X?Y.parentNode:Y.parentNode===U}}if(X){F.filter(U,Z,true)}}},"":function(W,U,Y){var V=L++,T=S;if(!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T("parentNode",U,V,W,X,Y)},"~":function(W,U,Y){var V=L++,T=S;if(typeof U==="string"&&!U.match(/\W/)){var X=U=Y?U:U.toUpperCase();T=P}T("previousSibling",U,V,W,X,Y)}},find:{ID:function(U,V,W){if(typeof V.getElementById!=="undefined"&&!W){var T=V.getElementById(U[1]);return T?[T]:[]}},NAME:function(V,Y,Z){if(typeof Y.getElementsByName!=="undefined"){var U=[],X=Y.getElementsByName(V[1]);for(var W=0,T=X.length;W<T;W++){if(X[W].getAttribute("name")===V[1]){U.push(X[W])}}return U.length===0?null:U}},TAG:function(T,U){return U.getElementsByTagName(T[1])}},preFilter:{CLASS:function(W,U,V,T,Z,aa){W=" "+W[1].replace(/\\/g,"")+" ";if(aa){return W}for(var X=0,Y;(Y=U[X])!=null;X++){if(Y){if(Z^(Y.className&&(" "+Y.className+" ").indexOf(W)>=0)){if(!V){T.push(Y)}}else{if(V){U[X]=false}}}}return false},ID:function(T){return T[1].replace(/\\/g,"")},TAG:function(U,T){for(var V=0;T[V]===false;V++){}return T[V]&&Q(T[V])?U[1]:U[1].toUpperCase()},CHILD:function(T){if(T[1]=="nth"){var U=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(T[2]=="even"&&"2n"||T[2]=="odd"&&"2n+1"||!/\D/.test(T[2])&&"0n+"+T[2]||T[2]);T[2]=(U[1]+(U[2]||1))-0;T[3]=U[3]-0}T[0]=L++;return T},ATTR:function(X,U,V,T,Y,Z){var W=X[1].replace(/\\/g,"");if(!Z&&I.attrMap[W]){X[1]=I.attrMap[W]}if(X[2]==="~="){X[4]=" "+X[4]+" "}return X},PSEUDO:function(X,U,V,T,Y){if(X[1]==="not"){if(X[3].match(R).length>1||/^\w/.test(X[3])){X[3]=F(X[3],null,null,U)}else{var W=F.filter(X[3],U,V,true^Y);if(!V){T.push.apply(T,W)}return false}}else{if(I.match.POS.test(X[0])||I.match.CHILD.test(X[0])){return true}}return X},POS:function(T){T.unshift(true);return T}},filters:{enabled:function(T){return T.disabled===false&&T.type!=="hidden"},disabled:function(T){return T.disabled===true},checked:function(T){return T.checked===true},selected:function(T){T.parentNode.selectedIndex;return T.selected===true},parent:function(T){return !!T.firstChild},empty:function(T){return !T.firstChild},has:function(V,U,T){return !!F(T[3],V).length},header:function(T){return/h\d/i.test(T.nodeName)},text:function(T){return"text"===T.type},radio:function(T){return"radio"===T.type},checkbox:function(T){return"checkbox"===T.type},file:function(T){return"file"===T.type},password:function(T){return"password"===T.type},submit:function(T){return"submit"===T.type},image:function(T){return"image"===T.type},reset:function(T){return"reset"===T.type},button:function(T){return"button"===T.type||T.nodeName.toUpperCase()==="BUTTON"},input:function(T){return/input|select|textarea|button/i.test(T.nodeName)}},setFilters:{first:function(U,T){return T===0},last:function(V,U,T,W){return U===W.length-1},even:function(U,T){return T%2===0},odd:function(U,T){return T%2===1},lt:function(V,U,T){return U<T[3]-0},gt:function(V,U,T){return U>T[3]-0},nth:function(V,U,T){return T[3]-0==U},eq:function(V,U,T){return T[3]-0==U}},filter:{PSEUDO:function(Z,V,W,aa){var U=V[1],X=I.filters[U];if(X){return X(Z,W,V,aa)}else{if(U==="contains"){return(Z.textContent||Z.innerText||"").indexOf(V[3])>=0}else{if(U==="not"){var Y=V[3];for(var W=0,T=Y.length;W<T;W++){if(Y[W]===Z){return false}}return true}}}},CHILD:function(T,W){var Z=W[1],U=T;switch(Z){case"only":case"first":while(U=U.previousSibling){if(U.nodeType===1){return false}}if(Z=="first"){return true}U=T;case"last":while(U=U.nextSibling){if(U.nodeType===1){return false}}return true;case"nth":var V=W[2],ac=W[3];if(V==1&&ac==0){return true}var Y=W[0],ab=T.parentNode;if(ab&&(ab.sizcache!==Y||!T.nodeIndex)){var X=0;for(U=ab.firstChild;U;U=U.nextSibling){if(U.nodeType===1){U.nodeIndex=++X}}ab.sizcache=Y}var aa=T.nodeIndex-ac;if(V==0){return aa==0}else{return(aa%V==0&&aa/V>=0)}}},ID:function(U,T){return U.nodeType===1&&U.getAttribute("id")===T},TAG:function(U,T){return(T==="*"&&U.nodeType===1)||U.nodeName===T},CLASS:function(U,T){return(" "+(U.className||U.getAttribute("class"))+" ").indexOf(T)>-1},ATTR:function(Y,W){var V=W[1],T=I.attrHandle[V]?I.attrHandle[V](Y):Y[V]!=null?Y[V]:Y.getAttribute(V),Z=T+"",X=W[2],U=W[4];return T==null?X==="!=":X==="="?Z===U:X==="*="?Z.indexOf(U)>=0:X==="~="?(" "+Z+" ").indexOf(U)>=0:!U?Z&&T!==false:X==="!="?Z!=U:X==="^="?Z.indexOf(U)===0:X==="$="?Z.substr(Z.length-U.length)===U:X==="|="?Z===U||Z.substr(0,U.length+1)===U+"-":false},POS:function(X,U,V,Y){var T=U[2],W=I.setFilters[T];if(W){return W(X,V,U,Y)}}}};var M=I.match.POS;for(var O in I.match){I.match[O]=RegExp(I.match[O].source+/(?![^\[]*\])(?![^\(]*\))/.source)}var E=function(U,T){U=Array.prototype.slice.call(U);if(T){T.push.apply(T,U);return T}return U};try{Array.prototype.slice.call(document.documentElement.childNodes)}catch(N){E=function(X,W){var U=W||[];if(H.call(X)==="[object Array]"){Array.prototype.push.apply(U,X)}else{if(typeof X.length==="number"){for(var V=0,T=X.length;V<T;V++){U.push(X[V])}}else{for(var V=0;X[V];V++){U.push(X[V])}}}return U}}var G;if(document.documentElement.compareDocumentPosition){G=function(U,T){var V=U.compareDocumentPosition(T)&4?-1:U===T?0:1;if(V===0){hasDuplicate=true}return V}}else{if("sourceIndex" in document.documentElement){G=function(U,T){var V=U.sourceIndex-T.sourceIndex;if(V===0){hasDuplicate=true}return V}}else{if(document.createRange){G=function(W,U){var V=W.ownerDocument.createRange(),T=U.ownerDocument.createRange();V.selectNode(W);V.collapse(true);T.selectNode(U);T.collapse(true);var X=V.compareBoundaryPoints(Range.START_TO_END,T);if(X===0){hasDuplicate=true}return X}}}}(function(){var U=document.createElement("form"),V="script"+(new Date).getTime();U.innerHTML="<input name='"+V+"'/>";var T=document.documentElement;T.insertBefore(U,T.firstChild);if(!!document.getElementById(V)){I.find.ID=function(X,Y,Z){if(typeof Y.getElementById!=="undefined"&&!Z){var W=Y.getElementById(X[1]);return W?W.id===X[1]||typeof W.getAttributeNode!=="undefined"&&W.getAttributeNode("id").nodeValue===X[1]?[W]:g:[]}};I.filter.ID=function(Y,W){var X=typeof Y.getAttributeNode!=="undefined"&&Y.getAttributeNode("id");return Y.nodeType===1&&X&&X.nodeValue===W}}T.removeChild(U)})();(function(){var T=document.createElement("div");T.appendChild(document.createComment(""));if(T.getElementsByTagName("*").length>0){I.find.TAG=function(U,Y){var X=Y.getElementsByTagName(U[1]);if(U[1]==="*"){var W=[];for(var V=0;X[V];V++){if(X[V].nodeType===1){W.push(X[V])}}X=W}return X}}T.innerHTML="<a href='#'></a>";if(T.firstChild&&typeof T.firstChild.getAttribute!=="undefined"&&T.firstChild.getAttribute("href")!=="#"){I.attrHandle.href=function(U){return U.getAttribute("href",2)}}})();if(document.querySelectorAll){(function(){var T=F,U=document.createElement("div");U.innerHTML="<p class='TEST'></p>";if(U.querySelectorAll&&U.querySelectorAll(".TEST").length===0){return}F=function(Y,X,V,W){X=X||document;if(!W&&X.nodeType===9&&!Q(X)){try{return E(X.querySelectorAll(Y),V)}catch(Z){}}return T(Y,X,V,W)};F.find=T.find;F.filter=T.filter;F.selectors=T.selectors;F.matches=T.matches})()}if(document.getElementsByClassName&&document.documentElement.getElementsByClassName){(function(){var T=document.createElement("div");T.innerHTML="<div class='test e'></div><div class='test'></div>";if(T.getElementsByClassName("e").length===0){return}T.lastChild.className="e";if(T.getElementsByClassName("e").length===1){return}I.order.splice(1,0,"CLASS");I.find.CLASS=function(U,V,W){if(typeof V.getElementsByClassName!=="undefined"&&!W){return V.getElementsByClassName(U[1])}}})()}function P(U,Z,Y,ad,aa,ac){var ab=U=="previousSibling"&&!ac;for(var W=0,V=ad.length;W<V;W++){var T=ad[W];if(T){if(ab&&T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1&&!ac){T.sizcache=Y;T.sizset=W}if(T.nodeName===Z){X=T;break}T=T[U]}ad[W]=X}}}function S(U,Z,Y,ad,aa,ac){var ab=U=="previousSibling"&&!ac;for(var W=0,V=ad.length;W<V;W++){var T=ad[W];if(T){if(ab&&T.nodeType===1){T.sizcache=Y;T.sizset=W}T=T[U];var X=false;while(T){if(T.sizcache===Y){X=ad[T.sizset];break}if(T.nodeType===1){if(!ac){T.sizcache=Y;T.sizset=W}if(typeof Z!=="string"){if(T===Z){X=true;break}}else{if(F.filter(Z,[T]).length>0){X=T;break}}}T=T[U]}ad[W]=X}}}var K=document.compareDocumentPosition?function(U,T){return U.compareDocumentPosition(T)&16}:function(U,T){return U!==T&&(U.contains?U.contains(T):true)};var Q=function(T){return T.nodeType===9&&T.documentElement.nodeName!=="HTML"||!!T.ownerDocument&&Q(T.ownerDocument)};var J=function(T,aa){var W=[],X="",Y,V=aa.nodeType?[aa]:aa;while((Y=I.match.PSEUDO.exec(T))){X+=Y[0];T=T.replace(I.match.PSEUDO,"")}T=I.relative[T]?T+"*":T;for(var Z=0,U=V.length;Z<U;Z++){F(T,V[Z],W)}return F.filter(X,W)};o.find=F;o.filter=F.filter;o.expr=F.selectors;o.expr[":"]=o.expr.filters;F.selectors.filters.hidden=function(T){return T.offsetWidth===0||T.offsetHeight===0};F.selectors.filters.visible=function(T){return T.offsetWidth>0||T.offsetHeight>0};F.selectors.filters.animated=function(T){return o.grep(o.timers,function(U){return T===U.elem}).length};o.multiFilter=function(V,T,U){if(U){V=":not("+V+")"}return F.matches(V,T)};o.dir=function(V,U){var T=[],W=V[U];while(W&&W!=document){if(W.nodeType==1){T.push(W)}W=W[U]}return T};o.nth=function(X,T,V,W){T=T||1;var U=0;for(;X;X=X[V]){if(X.nodeType==1&&++U==T){break}}return X};o.sibling=function(V,U){var T=[];for(;V;V=V.nextSibling){if(V.nodeType==1&&V!=U){T.push(V)}}return T};return;l.Sizzle=F})();o.event={add:function(I,F,H,K){if(I.nodeType==3||I.nodeType==8){return}if(I.setInterval&&I!=l){I=l}if(!H.guid){H.guid=this.guid++}if(K!==g){var G=H;H=this.proxy(G);H.data=K}var E=o.data(I,"events")||o.data(I,"events",{}),J=o.data(I,"handle")||o.data(I,"handle",function(){return typeof o!=="undefined"&&!o.event.triggered?o.event.handle.apply(arguments.callee.elem,arguments):g});J.elem=I;o.each(F.split(/\s+/),function(M,N){var O=N.split(".");N=O.shift();H.type=O.slice().sort().join(".");var L=E[N];if(o.event.specialAll[N]){o.event.specialAll[N].setup.call(I,K,O)}if(!L){L=E[N]={};if(!o.event.special[N]||o.event.special[N].setup.call(I,K,O)===false){if(I.addEventListener){I.addEventListener(N,J,false)}else{if(I.attachEvent){I.attachEvent("on"+N,J)}}}}L[H.guid]=H;o.event.global[N]=true});I=null},guid:1,global:{},remove:function(K,H,J){if(K.nodeType==3||K.nodeType==8){return}var G=o.data(K,"events"),F,E;if(G){if(H===g||(typeof H==="string"&&H.charAt(0)==".")){for(var I in G){this.remove(K,I+(H||""))}}else{if(H.type){J=H.handler;H=H.type}o.each(H.split(/\s+/),function(M,O){var Q=O.split(".");O=Q.shift();var N=RegExp("(^|\\.)"+Q.slice().sort().join(".*\\.")+"(\\.|$)");if(G[O]){if(J){delete G[O][J.guid]}else{for(var P in G[O]){if(N.test(G[O][P].type)){delete G[O][P]}}}if(o.event.specialAll[O]){o.event.specialAll[O].teardown.call(K,Q)}for(F in G[O]){break}if(!F){if(!o.event.special[O]||o.event.special[O].teardown.call(K,Q)===false){if(K.removeEventListener){K.removeEventListener(O,o.data(K,"handle"),false)}else{if(K.detachEvent){K.detachEvent("on"+O,o.data(K,"handle"))}}}F=null;delete G[O]}}})}for(F in G){break}if(!F){var L=o.data(K,"handle");if(L){L.elem=null}o.removeData(K,"events");o.removeData(K,"handle")}}},trigger:function(I,K,H,E){var G=I.type||I;if(!E){I=typeof I==="object"?I[h]?I:o.extend(o.Event(G),I):o.Event(G);if(G.indexOf("!")>=0){I.type=G=G.slice(0,-1);I.exclusive=true}if(!H){I.stopPropagation();if(this.global[G]){o.each(o.cache,function(){if(this.events&&this.events[G]){o.event.trigger(I,K,this.handle.elem)}})}}if(!H||H.nodeType==3||H.nodeType==8){return g}I.result=g;I.target=H;K=o.makeArray(K);K.unshift(I)}I.currentTarget=H;var J=o.data(H,"handle");if(J){J.apply(H,K)}if((!H[G]||(o.nodeName(H,"a")&&G=="click"))&&H["on"+G]&&H["on"+G].apply(H,K)===false){I.result=false}if(!E&&H[G]&&!I.isDefaultPrevented()&&!(o.nodeName(H,"a")&&G=="click")){this.triggered=true;try{H[G]()}catch(L){}}this.triggered=false;if(!I.isPropagationStopped()){var F=H.parentNode||H.ownerDocument;if(F){o.event.trigger(I,K,F,true)}}},handle:function(K){var J,E;K=arguments[0]=o.event.fix(K||l.event);K.currentTarget=this;var L=K.type.split(".");K.type=L.shift();J=!L.length&&!K.exclusive;var I=RegExp("(^|\\.)"+L.slice().sort().join(".*\\.")+"(\\.|$)");E=(o.data(this,"events")||{})[K.type];for(var G in E){var H=E[G];if(J||I.test(H.type)){K.handler=H;K.data=H.data;var F=H.apply(this,arguments);if(F!==g){K.result=F;if(F===false){K.preventDefault();K.stopPropagation()}}if(K.isImmediatePropagationStopped()){break}}}},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode metaKey newValue originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),fix:function(H){if(H[h]){return H}var F=H;H=o.Event(F);for(var G=this.props.length,J;G;){J=this.props[--G];H[J]=F[J]}if(!H.target){H.target=H.srcElement||document}if(H.target.nodeType==3){H.target=H.target.parentNode}if(!H.relatedTarget&&H.fromElement){H.relatedTarget=H.fromElement==H.target?H.toElement:H.fromElement}if(H.pageX==null&&H.clientX!=null){var I=document.documentElement,E=document.body;H.pageX=H.clientX+(I&&I.scrollLeft||E&&E.scrollLeft||0)-(I.clientLeft||0);H.pageY=H.clientY+(I&&I.scrollTop||E&&E.scrollTop||0)-(I.clientTop||0)}if(!H.which&&((H.charCode||H.charCode===0)?H.charCode:H.keyCode)){H.which=H.charCode||H.keyCode}if(!H.metaKey&&H.ctrlKey){H.metaKey=H.ctrlKey}if(!H.which&&H.button){H.which=(H.button&1?1:(H.button&2?3:(H.button&4?2:0)))}return H},proxy:function(F,E){E=E||function(){return F.apply(this,arguments)};E.guid=F.guid=F.guid||E.guid||this.guid++;return E},special:{ready:{setup:B,teardown:function(){}}},specialAll:{live:{setup:function(E,F){o.event.add(this,F[0],c)},teardown:function(G){if(G.length){var E=0,F=RegExp("(^|\\.)"+G[0]+"(\\.|$)");o.each((o.data(this,"events").live||{}),function(){if(F.test(this.type)){E++}});if(E<1){o.event.remove(this,G[0],c)}}}}}};o.Event=function(E){if(!this.preventDefault){return new o.Event(E)}if(E&&E.type){this.originalEvent=E;this.type=E.type}else{this.type=E}this.timeStamp=e();this[h]=true};function k(){return false}function u(){return true}o.Event.prototype={preventDefault:function(){this.isDefaultPrevented=u;var E=this.originalEvent;if(!E){return}if(E.preventDefault){E.preventDefault()}E.returnValue=false},stopPropagation:function(){this.isPropagationStopped=u;var E=this.originalEvent;if(!E){return}if(E.stopPropagation){E.stopPropagation()}E.cancelBubble=true},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=u;this.stopPropagation()},isDefaultPrevented:k,isPropagationStopped:k,isImmediatePropagationStopped:k};var a=function(F){var E=F.relatedTarget;while(E&&E!=this){try{E=E.parentNode}catch(G){E=this}}if(E!=this){F.type=F.data;o.event.handle.apply(this,arguments)}};o.each({mouseover:"mouseenter",mouseout:"mouseleave"},function(F,E){o.event.special[E]={setup:function(){o.event.add(this,F,a,E)},teardown:function(){o.event.remove(this,F,a)}}});o.fn.extend({bind:function(F,G,E){return F=="unload"?this.one(F,G,E):this.each(function(){o.event.add(this,F,E||G,E&&G)})},one:function(G,H,F){var E=o.event.proxy(F||H,function(I){o(this).unbind(I,E);return(F||H).apply(this,arguments)});return this.each(function(){o.event.add(this,G,E,F&&H)})},unbind:function(F,E){return this.each(function(){o.event.remove(this,F,E)})},trigger:function(E,F){return this.each(function(){o.event.trigger(E,F,this)})},triggerHandler:function(E,G){if(this[0]){var F=o.Event(E);F.preventDefault();F.stopPropagation();o.event.trigger(F,G,this[0]);return F.result}},toggle:function(G){var E=arguments,F=1;while(F<E.length){o.event.proxy(G,E[F++])}return this.click(o.event.proxy(G,function(H){this.lastToggle=(this.lastToggle||0)%F;H.preventDefault();return E[this.lastToggle++].apply(this,arguments)||false}))},hover:function(E,F){return this.mouseenter(E).mouseleave(F)},ready:function(E){B();if(o.isReady){E.call(document,o)}else{o.readyList.push(E)}return this},live:function(G,F){var E=o.event.proxy(F);E.guid+=this.selector+G;o(document).bind(i(G,this.selector),this.selector,E);return this},die:function(F,E){o(document).unbind(i(F,this.selector),E?{guid:E.guid+this.selector+F}:null);return this}});function c(H){var E=RegExp("(^|\\.)"+H.type+"(\\.|$)"),G=true,F=[];o.each(o.data(this,"events").live||[],function(I,J){if(E.test(J.type)){var K=o(H.target).closest(J.data)[0];if(K){F.push({elem:K,fn:J})}}});F.sort(function(J,I){return o.data(J.elem,"closest")-o.data(I.elem,"closest")});o.each(F,function(){if(this.fn.call(this.elem,H,this.fn.data)===false){return(G=false)}});return G}function i(F,E){return["live",F,E.replace(/\./g,"`").replace(/ /g,"|")].join(".")}o.extend({isReady:false,readyList:[],ready:function(){if(!o.isReady){o.isReady=true;if(o.readyList){o.each(o.readyList,function(){this.call(document,o)});o.readyList=null}o(document).triggerHandler("ready")}}});var x=false;function B(){if(x){return}x=true;if(document.addEventListener){document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,false);o.ready()},false)}else{if(document.attachEvent){document.attachEvent("onreadystatechange",function(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",arguments.callee);o.ready()}});if(document.documentElement.doScroll&&l==l.top){(function(){if(o.isReady){return}try{document.documentElement.doScroll("left")}catch(E){setTimeout(arguments.callee,0);return}o.ready()})()}}}o.event.add(l,"load",o.ready)}o.each(("blur,focus,load,resize,scroll,unload,click,dblclick,mousedown,mouseup,mousemove,mouseover,mouseout,mouseenter,mouseleave,change,select,submit,keydown,keypress,keyup,error").split(","),function(F,E){o.fn[E]=function(G){return G?this.bind(E,G):this.trigger(E)}});o(l).bind("unload",function(){for(var E in o.cache){if(E!=1&&o.cache[E].handle){o.event.remove(o.cache[E].handle.elem)}}});(function(){o.support={};var F=document.documentElement,G=document.createElement("script"),K=document.createElement("div"),J="script"+(new Date).getTime();K.style.display="none";K.innerHTML='   <link/><table></table><a href="/a" style="color:red;float:left;opacity:.5;">a</a><select><option>text</option></select><object><param/></object>';var H=K.getElementsByTagName("*"),E=K.getElementsByTagName("a")[0];if(!H||!H.length||!E){return}o.support={leadingWhitespace:K.firstChild.nodeType==3,tbody:!K.getElementsByTagName("tbody").length,objectAll:!!K.getElementsByTagName("object")[0].getElementsByTagName("*").length,htmlSerialize:!!K.getElementsByTagName("link").length,style:/red/.test(E.getAttribute("style")),hrefNormalized:E.getAttribute("href")==="/a",opacity:E.style.opacity==="0.5",cssFloat:!!E.style.cssFloat,scriptEval:false,noCloneEvent:true,boxModel:null};G.type="text/javascript";try{G.appendChild(document.createTextNode("window."+J+"=1;"))}catch(I){}F.insertBefore(G,F.firstChild);if(l[J]){o.support.scriptEval=true;delete l[J]}F.removeChild(G);if(K.attachEvent&&K.fireEvent){K.attachEvent("onclick",function(){o.support.noCloneEvent=false;K.detachEvent("onclick",arguments.callee)});K.cloneNode(true).fireEvent("onclick")}o(function(){var L=document.createElement("div");L.style.width=L.style.paddingLeft="1px";document.body.appendChild(L);o.boxModel=o.support.boxModel=L.offsetWidth===2;document.body.removeChild(L).style.display="none"})})();var w=o.support.cssFloat?"cssFloat":"styleFloat";o.props={"for":"htmlFor","class":"className","float":w,cssFloat:w,styleFloat:w,readonly:"readOnly",maxlength:"maxLength",cellspacing:"cellSpacing",rowspan:"rowSpan",tabindex:"tabIndex"};o.fn.extend({_load:o.fn.load,load:function(G,J,K){if(typeof G!=="string"){return this._load(G)}var I=G.indexOf(" ");if(I>=0){var E=G.slice(I,G.length);G=G.slice(0,I)}var H="GET";if(J){if(o.isFunction(J)){K=J;J=null}else{if(typeof J==="object"){J=o.param(J);H="POST"}}}var F=this;o.ajax({url:G,type:H,dataType:"html",data:J,complete:function(M,L){if(L=="success"||L=="notmodified"){F.html(E?o("<div/>").append(M.responseText.replace(/<script(.|\s)*?\/script>/g,"")).find(E):M.responseText)}if(K){F.each(K,[M.responseText,L,M])}}});return this},serialize:function(){return o.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?o.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||/select|textarea/i.test(this.nodeName)||/text|hidden|password|search/i.test(this.type))}).map(function(E,F){var G=o(this).val();return G==null?null:o.isArray(G)?o.map(G,function(I,H){return{name:F.name,value:I}}):{name:F.name,value:G}}).get()}});o.each("ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend".split(","),function(E,F){o.fn[F]=function(G){return this.bind(F,G)}});var r=e();o.extend({get:function(E,G,H,F){if(o.isFunction(G)){H=G;G=null}return o.ajax({type:"GET",url:E,data:G,success:H,dataType:F})},getScript:function(E,F){return o.get(E,null,F,"script")},getJSON:function(E,F,G){return o.get(E,F,G,"json")},post:function(E,G,H,F){if(o.isFunction(G)){H=G;G={}}return o.ajax({type:"POST",url:E,data:G,success:H,dataType:F})},ajaxSetup:function(E){o.extend(o.ajaxSettings,E)},ajaxSettings:{url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return l.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},lastModified:{},ajax:function(M){M=o.extend(true,M,o.extend(true,{},o.ajaxSettings,M));var W,F=/=\?(&|$)/g,R,V,G=M.type.toUpperCase();if(M.data&&M.processData&&typeof M.data!=="string"){M.data=o.param(M.data)}if(M.dataType=="jsonp"){if(G=="GET"){if(!M.url.match(F)){M.url+=(M.url.match(/\?/)?"&":"?")+(M.jsonp||"callback")+"=?"}}else{if(!M.data||!M.data.match(F)){M.data=(M.data?M.data+"&":"")+(M.jsonp||"callback")+"=?"}}M.dataType="json"}if(M.dataType=="json"&&(M.data&&M.data.match(F)||M.url.match(F))){W="jsonp"+r++;if(M.data){M.data=(M.data+"").replace(F,"="+W+"$1")}M.url=M.url.replace(F,"="+W+"$1");M.dataType="script";l[W]=function(X){V=X;I();L();l[W]=g;try{delete l[W]}catch(Y){}if(H){H.removeChild(T)}}}if(M.dataType=="script"&&M.cache==null){M.cache=false}if(M.cache===false&&G=="GET"){var E=e();var U=M.url.replace(/(\?|&)_=.*?(&|$)/,"$1_="+E+"$2");M.url=U+((U==M.url)?(M.url.match(/\?/)?"&":"?")+"_="+E:"")}if(M.data&&G=="GET"){M.url+=(M.url.match(/\?/)?"&":"?")+M.data;M.data=null}if(M.global&&!o.active++){o.event.trigger("ajaxStart")}var Q=/^(\w+:)?\/\/([^\/?#]+)/.exec(M.url);if(M.dataType=="script"&&G=="GET"&&Q&&(Q[1]&&Q[1]!=location.protocol||Q[2]!=location.host)){var H=document.getElementsByTagName("head")[0];var T=document.createElement("script");T.src=M.url;if(M.scriptCharset){T.charset=M.scriptCharset}if(!W){var O=false;T.onload=T.onreadystatechange=function(){if(!O&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){O=true;I();L();T.onload=T.onreadystatechange=null;H.removeChild(T)}}}H.appendChild(T);return g}var K=false;var J=M.xhr();if(M.username){J.open(G,M.url,M.async,M.username,M.password)}else{J.open(G,M.url,M.async)}try{if(M.data){J.setRequestHeader("Content-Type",M.contentType)}if(M.ifModified){J.setRequestHeader("If-Modified-Since",o.lastModified[M.url]||"Thu, 01 Jan 1970 00:00:00 GMT")}J.setRequestHeader("X-Requested-With","XMLHttpRequest");J.setRequestHeader("Accept",M.dataType&&M.accepts[M.dataType]?M.accepts[M.dataType]+", */*":M.accepts._default)}catch(S){}if(M.beforeSend&&M.beforeSend(J,M)===false){if(M.global&&!--o.active){o.event.trigger("ajaxStop")}J.abort();return false}if(M.global){o.event.trigger("ajaxSend",[J,M])}var N=function(X){if(J.readyState==0){if(P){clearInterval(P);P=null;if(M.global&&!--o.active){o.event.trigger("ajaxStop")}}}else{if(!K&&J&&(J.readyState==4||X=="timeout")){K=true;if(P){clearInterval(P);P=null}R=X=="timeout"?"timeout":!o.httpSuccess(J)?"error":M.ifModified&&o.httpNotModified(J,M.url)?"notmodified":"success";if(R=="success"){try{V=o.httpData(J,M.dataType,M)}catch(Z){R="parsererror"}}if(R=="success"){var Y;try{Y=J.getResponseHeader("Last-Modified")}catch(Z){}if(M.ifModified&&Y){o.lastModified[M.url]=Y}if(!W){I()}}else{o.handleError(M,J,R)}L();if(X){J.abort()}if(M.async){J=null}}}};if(M.async){var P=setInterval(N,13);if(M.timeout>0){setTimeout(function(){if(J&&!K){N("timeout")}},M.timeout)}}try{J.send(M.data)}catch(S){o.handleError(M,J,null,S)}if(!M.async){N()}function I(){if(M.success){M.success(V,R)}if(M.global){o.event.trigger("ajaxSuccess",[J,M])}}function L(){if(M.complete){M.complete(J,R)}if(M.global){o.event.trigger("ajaxComplete",[J,M])}if(M.global&&!--o.active){o.event.trigger("ajaxStop")}}return J},handleError:function(F,H,E,G){if(F.error){F.error(H,E,G)}if(F.global){o.event.trigger("ajaxError",[H,F,G])}},active:0,httpSuccess:function(F){try{return !F.status&&location.protocol=="file:"||(F.status>=200&&F.status<300)||F.status==304||F.status==1223}catch(E){}return false},httpNotModified:function(G,E){try{var H=G.getResponseHeader("Last-Modified");return G.status==304||H==o.lastModified[E]}catch(F){}return false},httpData:function(J,H,G){var F=J.getResponseHeader("content-type"),E=H=="xml"||!H&&F&&F.indexOf("xml")>=0,I=E?J.responseXML:J.responseText;if(E&&I.documentElement.tagName=="parsererror"){throw"parsererror"}if(G&&G.dataFilter){I=G.dataFilter(I,H)}if(typeof I==="string"){if(H=="script"){o.globalEval(I)}if(H=="json"){I=l["eval"]("("+I+")")}}return I},param:function(E){var G=[];function H(I,J){G[G.length]=encodeURIComponent(I)+"="+encodeURIComponent(J)}if(o.isArray(E)||E.jquery){o.each(E,function(){H(this.name,this.value)})}else{for(var F in E){if(o.isArray(E[F])){o.each(E[F],function(){H(F,this)})}else{H(F,o.isFunction(E[F])?E[F]():E[F])}}}return G.join("&").replace(/%20/g,"+")}});var m={},n,d=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]];function t(F,E){var G={};o.each(d.concat.apply([],d.slice(0,E)),function(){G[this]=F});return G}o.fn.extend({show:function(J,L){if(J){return this.animate(t("show",3),J,L)}else{for(var H=0,F=this.length;H<F;H++){var E=o.data(this[H],"olddisplay");this[H].style.display=E||"";if(o.css(this[H],"display")==="none"){var G=this[H].tagName,K;if(m[G]){K=m[G]}else{var I=o("<"+G+" />").appendTo("body");K=I.css("display");if(K==="none"){K="block"}I.remove();m[G]=K}o.data(this[H],"olddisplay",K)}}for(var H=0,F=this.length;H<F;H++){this[H].style.display=o.data(this[H],"olddisplay")||""}return this}},hide:function(H,I){if(H){return this.animate(t("hide",3),H,I)}else{for(var G=0,F=this.length;G<F;G++){var E=o.data(this[G],"olddisplay");if(!E&&E!=="none"){o.data(this[G],"olddisplay",o.css(this[G],"display"))}}for(var G=0,F=this.length;G<F;G++){this[G].style.display="none"}return this}},_toggle:o.fn.toggle,toggle:function(G,F){var E=typeof G==="boolean";return o.isFunction(G)&&o.isFunction(F)?this._toggle.apply(this,arguments):G==null||E?this.each(function(){var H=E?G:o(this).is(":hidden");o(this)[H?"show":"hide"]()}):this.animate(t("toggle",3),G,F)},fadeTo:function(E,G,F){return this.animate({opacity:G},E,F)},animate:function(I,F,H,G){var E=o.speed(F,H,G);return this[E.queue===false?"each":"queue"](function(){var K=o.extend({},E),M,L=this.nodeType==1&&o(this).is(":hidden"),J=this;for(M in I){if(I[M]=="hide"&&L||I[M]=="show"&&!L){return K.complete.call(this)}if((M=="height"||M=="width")&&this.style){K.display=o.css(this,"display");K.overflow=this.style.overflow}}if(K.overflow!=null){this.style.overflow="hidden"}K.curAnim=o.extend({},I);o.each(I,function(O,S){var R=new o.fx(J,K,O);if(/toggle|show|hide/.test(S)){R[S=="toggle"?L?"show":"hide":S](I)}else{var Q=S.toString().match(/^([+-]=)?([\d+-.]+)(.*)$/),T=R.cur(true)||0;if(Q){var N=parseFloat(Q[2]),P=Q[3]||"px";if(P!="px"){J.style[O]=(N||1)+P;T=((N||1)/R.cur(true))*T;J.style[O]=T+P}if(Q[1]){N=((Q[1]=="-="?-1:1)*N)+T}R.custom(T,N,P)}else{R.custom(T,S,"")}}});return true})},stop:function(F,E){var G=o.timers;if(F){this.queue([])}this.each(function(){for(var H=G.length-1;H>=0;H--){if(G[H].elem==this){if(E){G[H](true)}G.splice(H,1)}}});if(!E){this.dequeue()}return this}});o.each({slideDown:t("show",1),slideUp:t("hide",1),slideToggle:t("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"}},function(E,F){o.fn[E]=function(G,H){return this.animate(F,G,H)}});o.extend({speed:function(G,H,F){var E=typeof G==="object"?G:{complete:F||!F&&H||o.isFunction(G)&&G,duration:G,easing:F&&H||H&&!o.isFunction(H)&&H};E.duration=o.fx.off?0:typeof E.duration==="number"?E.duration:o.fx.speeds[E.duration]||o.fx.speeds._default;E.old=E.complete;E.complete=function(){if(E.queue!==false){o(this).dequeue()}if(o.isFunction(E.old)){E.old.call(this)}};return E},easing:{linear:function(G,H,E,F){return E+F*G},swing:function(G,H,E,F){return((-Math.cos(G*Math.PI)/2)+0.5)*F+E}},timers:[],fx:function(F,E,G){this.options=E;this.elem=F;this.prop=G;if(!E.orig){E.orig={}}}});o.fx.prototype={update:function(){if(this.options.step){this.options.step.call(this.elem,this.now,this)}(o.fx.step[this.prop]||o.fx.step._default)(this);if((this.prop=="height"||this.prop=="width")&&this.elem.style){this.elem.style.display="block"}},cur:function(F){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null)){return this.elem[this.prop]}var E=parseFloat(o.css(this.elem,this.prop,F));return E&&E>-10000?E:parseFloat(o.curCSS(this.elem,this.prop))||0},custom:function(I,H,G){this.startTime=e();this.start=I;this.end=H;this.unit=G||this.unit||"px";this.now=this.start;this.pos=this.state=0;var E=this;function F(J){return E.step(J)}F.elem=this.elem;if(F()&&o.timers.push(F)&&!n){n=setInterval(function(){var K=o.timers;for(var J=0;J<K.length;J++){if(!K[J]()){K.splice(J--,1)}}if(!K.length){clearInterval(n);n=g}},13)}},show:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.show=true;this.custom(this.prop=="width"||this.prop=="height"?1:0,this.cur());o(this.elem).show()},hide:function(){this.options.orig[this.prop]=o.attr(this.elem.style,this.prop);this.options.hide=true;this.custom(this.cur(),0)},step:function(H){var G=e();if(H||G>=this.options.duration+this.startTime){this.now=this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;var E=true;for(var F in this.options.curAnim){if(this.options.curAnim[F]!==true){E=false}}if(E){if(this.options.display!=null){this.elem.style.overflow=this.options.overflow;this.elem.style.display=this.options.display;if(o.css(this.elem,"display")=="none"){this.elem.style.display="block"}}if(this.options.hide){o(this.elem).hide()}if(this.options.hide||this.options.show){for(var I in this.options.curAnim){o.attr(this.elem.style,I,this.options.orig[I])}}this.options.complete.call(this.elem)}return false}else{var J=G-this.startTime;this.state=J/this.options.duration;this.pos=o.easing[this.options.easing||(o.easing.swing?"swing":"linear")](this.state,J,0,1,this.options.duration);this.now=this.start+((this.end-this.start)*this.pos);this.update()}return true}};o.extend(o.fx,{speeds:{slow:600,fast:200,_default:400},step:{opacity:function(E){o.attr(E.elem.style,"opacity",E.now)},_default:function(E){if(E.elem.style&&E.elem.style[E.prop]!=null){E.elem.style[E.prop]=E.now+E.unit}else{E.elem[E.prop]=E.now}}}});if(document.documentElement.getBoundingClientRect){o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}var G=this[0].getBoundingClientRect(),J=this[0].ownerDocument,F=J.body,E=J.documentElement,L=E.clientTop||F.clientTop||0,K=E.clientLeft||F.clientLeft||0,I=G.top+(self.pageYOffset||o.boxModel&&E.scrollTop||F.scrollTop)-L,H=G.left+(self.pageXOffset||o.boxModel&&E.scrollLeft||F.scrollLeft)-K;return{top:I,left:H}}}else{o.fn.offset=function(){if(!this[0]){return{top:0,left:0}}if(this[0]===this[0].ownerDocument.body){return o.offset.bodyOffset(this[0])}o.offset.initialized||o.offset.initialize();var J=this[0],G=J.offsetParent,F=J,O=J.ownerDocument,M,H=O.documentElement,K=O.body,L=O.defaultView,E=L.getComputedStyle(J,null),N=J.offsetTop,I=J.offsetLeft;while((J=J.parentNode)&&J!==K&&J!==H){M=L.getComputedStyle(J,null);N-=J.scrollTop,I-=J.scrollLeft;if(J===G){N+=J.offsetTop,I+=J.offsetLeft;if(o.offset.doesNotAddBorder&&!(o.offset.doesAddBorderForTableAndCells&&/^t(able|d|h)$/i.test(J.tagName))){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}F=G,G=J.offsetParent}if(o.offset.subtractsBorderForOverflowNotVisible&&M.overflow!=="visible"){N+=parseInt(M.borderTopWidth,10)||0,I+=parseInt(M.borderLeftWidth,10)||0}E=M}if(E.position==="relative"||E.position==="static"){N+=K.offsetTop,I+=K.offsetLeft}if(E.position==="fixed"){N+=Math.max(H.scrollTop,K.scrollTop),I+=Math.max(H.scrollLeft,K.scrollLeft)}return{top:N,left:I}}}o.offset={initialize:function(){if(this.initialized){return}var L=document.body,F=document.createElement("div"),H,G,N,I,M,E,J=L.style.marginTop,K='<div style="position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;"><div></div></div><table style="position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;" cellpadding="0" cellspacing="0"><tr><td></td></tr></table>';M={position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",height:"1px",visibility:"hidden"};for(E in M){F.style[E]=M[E]}F.innerHTML=K;L.insertBefore(F,L.firstChild);H=F.firstChild,G=H.firstChild,I=H.nextSibling.firstChild.firstChild;this.doesNotAddBorder=(G.offsetTop!==5);this.doesAddBorderForTableAndCells=(I.offsetTop===5);H.style.overflow="hidden",H.style.position="relative";this.subtractsBorderForOverflowNotVisible=(G.offsetTop===-5);L.style.marginTop="1px";this.doesNotIncludeMarginInBodyOffset=(L.offsetTop===0);L.style.marginTop=J;L.removeChild(F);this.initialized=true},bodyOffset:function(E){o.offset.initialized||o.offset.initialize();var G=E.offsetTop,F=E.offsetLeft;if(o.offset.doesNotIncludeMarginInBodyOffset){G+=parseInt(o.curCSS(E,"marginTop",true),10)||0,F+=parseInt(o.curCSS(E,"marginLeft",true),10)||0}return{top:G,left:F}}};o.fn.extend({position:function(){var I=0,H=0,F;if(this[0]){var G=this.offsetParent(),J=this.offset(),E=/^body|html$/i.test(G[0].tagName)?{top:0,left:0}:G.offset();J.top-=j(this,"marginTop");J.left-=j(this,"marginLeft");E.top+=j(G,"borderTopWidth");E.left+=j(G,"borderLeftWidth");F={top:J.top-E.top,left:J.left-E.left}}return F},offsetParent:function(){var E=this[0].offsetParent||document.body;while(E&&(!/^body|html$/i.test(E.tagName)&&o.css(E,"position")=="static")){E=E.offsetParent}return o(E)}});o.each(["Left","Top"],function(F,E){var G="scroll"+E;o.fn[G]=function(H){if(!this[0]){return null}return H!==g?this.each(function(){this==l||this==document?l.scrollTo(!F?H:o(l).scrollLeft(),F?H:o(l).scrollTop()):this[G]=H}):this[0]==l||this[0]==document?self[F?"pageYOffset":"pageXOffset"]||o.boxModel&&document.documentElement[G]||document.body[G]:this[0][G]}});o.each(["Height","Width"],function(I,G){var E=I?"Left":"Top",H=I?"Right":"Bottom",F=G.toLowerCase();o.fn["inner"+G]=function(){return this[0]?o.css(this[0],F,false,"padding"):null};o.fn["outer"+G]=function(K){return this[0]?o.css(this[0],F,false,K?"margin":"border"):null};var J=G.toLowerCase();o.fn[J]=function(K){return this[0]==l?document.compatMode=="CSS1Compat"&&document.documentElement["client"+G]||document.body["client"+G]:this[0]==document?Math.max(document.documentElement["client"+G],document.body["scroll"+G],document.documentElement["scroll"+G],document.body["offset"+G],document.documentElement["offset"+G]):K===g?(this.length?o.css(this[0],J):null):this.css(J,typeof K==="string"?K:K+"px")}})})();
//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			"&nbsp;<style id='" + id + "'>" + css + "</style>"); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
